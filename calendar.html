<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario de Actividades Profesional</title>
  <style>
    /* ... (el mismo CSS que antes, sin cambios) ... */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f8f9fa;
      padding: 20px;
      transition: background-color 0.3s ease;
    }
    
    body.dark-mode {
      background-color: #1a1a1a;
      color: #f0f0f0;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    body.dark-mode .container {
      background: #2d2d2d;
      color: #f0f0f0;
    }
    
    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #2c3e50;
    }
    
    body.dark-mode h2 {
      color: #ecf0f1;
    }
    
    .usuario-info {
      background-color: #e8f4f8;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    
    body.dark-mode .usuario-info {
      background-color: #34495e;
      color: #ecf0f1;
    }
    
    .controles {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .navegacion {
      display: flex;
      gap: 10px;
    }
    
    .navegacion button, .vista-toggle button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background-color: #3498db;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }
    
    .navegacion button:hover, .vista-toggle button:hover {
      background-color: #2980b9;
    }
    
    .vista-toggle button.activo {
      background-color: #27ae60;
    }
    
    .vista-toggle button.activo:hover {
      background-color: #219653;
    }
    
    .mes-anio {
      font-size: 20px;
      font-weight: bold;
      color: #2c3e50;
    }
    
    body.dark-mode .mes-anio {
      color: #ecf0f1;
    }
    
    .filtros {
      display: flex;
      gap: 10px;
    }
    
    .filtros select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background-color: white;
      color: #2c3e50;
    }
    
    body.dark-mode .filtros select {
      background-color: #34495e;
      color: #ecf0f1;
      border-color: #4a4a4a;
    }
    
    .calendario {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .calendario th {
      background-color: #34495e;
      color: white;
      padding: 12px;
      text-align: center;
      font-weight: 600;
    }
    
    body.dark-mode .calendario th {
      background-color: #2c3e50;
    }
    
    .calendario td {
      width: 14.28%;
      height: 100px;
      vertical-align: top;
      padding: 5px;
      border: 1px solid #eee;
      position: relative;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    
    body.dark-mode .calendario td {
      border-color: #4a4a4a;
    }
    
    .calendario td:hover:not(.dia-vacio) {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 10;
    }
    
    body.dark-mode .calendario td:hover:not(.dia-vacio) {
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .dia-numero {
      font-weight: bold;
      margin-bottom: 5px;
      color: #2c3e50;
    }
    
    body.dark-mode .dia-numero {
      color: #ecf0f1;
    }
    
    .dia-vacio {
      background-color: #f8f9fa;
      color: #bdc3c7;
      cursor: default;
    }
    
    body.dark-mode .dia-vacio {
      background-color: #252525;
      color: #6c757d;
    }
    
    .dia-hoy {
      background-color: #fff3cd;
      border: 2px solid #ffc107;
    }
    
    body.dark-mode .dia-hoy {
      background-color: #343a40;
      border-color: #ffc107;
    }
    
    /* Colores para diferentes tipos de d√≠as */
    .dia-laborado { background-color: #d5f5e3; border-left: 4px solid #27ae60; }
    .dia-no_laborado { background-color: #f5b7b1; border-left: 4px solid #c0392b; }
    .dia-libre1 { background-color: #fdebd0; border-left: 4px solid #f39c12; }
    .dia-libre2 { background-color: #fadbd8; border-left: 4px solid #e74c3c; }
    .dia-libre3 { background-color: #d7bde2; border-left: 4px solid #9b59b6; }
    .dia-vacaciones { background-color: #d6eaf8; border-left: 4px solid #3498db; }
    .dia-licencia { background-color: #d5dbdb; border-left: 4px solid #95a5a6; }
    .dia-Biologico { background-color: #d5fbdb; border-left: 4px solid #75a5a6; }
    
    body.dark-mode .dia-laborado { background-color: #1e5a3a; border-left-color: #27ae60; }
    body.dark-mode .dia-no_laborado { background-color: #5a2a27; border-left-color: #c0392b; }
    body.dark-mode .dia-libre1 { background-color: #5a4a2a; border-left-color: #f39c12; }
    body.dark-mode .dia-libre2 { background-color: #5a2a2a; border-left-color: #e74c3c; }
    body.dark-mode .dia-libre3 { background-color: #4a2a5a; border-left-color: #9b59b6; }
    body.dark-mode .dia-vacaciones { background-color: #1a3a5a; border-left-color: #3498db; }
    body.dark-mode .dia-licencia { background-color: #3a3a3a; border-left-color: #95a5a6; }
    
    .comentario-indicador {
      font-size: 10px;
      color: #7f8c8d;
      font-style: italic;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    body.dark-mode .comentario-indicador {
      color: #bdc3c7;
    }
    
    /* Modal de edici√≥n */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-contenido {
      background-color: white;
      margin: 10% auto;
      padding: 25px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    body.dark-mode .modal-contenido {
      background-color: #2d2d2d;
      color: #f0f0f0;
    }
    
    .modal-titulo {
      margin-bottom: 20px;
      color: #2c3e50;
      text-align: center;
    }
    
    body.dark-mode .modal-titulo {
      color: #ecf0f1;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #34495e;
    }
    
    body.dark-mode .form-group label {
      color: #ecf0f1;
    }
    
    .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background-color: white;
      color: #2c3e50;
    }
    
    body.dark-mode .form-group select, 
    body.dark-mode .form-group textarea {
      background-color: #34495e;
      color: #ecf0f1;
      border-color: #4a4a4a;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .modal-botones {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    
    .btn-modal {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }
    
    .btn-guardar {
      background-color: #27ae60;
      color: white;
    }
    
    .btn-guardar:hover {
      background-color: #219653;
    }
    
    .btn-cancelar {
      background-color: #95a5a6;
      color: white;
    }
    
    .btn-cancelar:hover {
      background-color: #7f8c8d;
    }
    
    .leyenda {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }
    
    body.dark-mode .leyenda {
      background-color: #34495e;
    }
    
    .leyenda-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
    }
    
    .leyenda-color {
      width: 15px;
      height: 15px;
      border-radius: 3px;
    }
    
    .resumen-estadisticas {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }
    
    body.dark-mode .resumen-estadisticas {
      background-color: #34495e;
    }
    
    .stat {
      background-color: white;
      padding: 10px;
      border-radius: 6px;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    
    body.dark-mode .stat {
      background-color: #2d2d2d;
      color: #ecf0f1;
    }
    
    .btn-flotante-inicio {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background-color: #3498db;
      color: white;
      padding: 12px 20px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 100;
      transition: transform 0.2s ease, background-color 0.2s ease;
    }
    
    .btn-flotante-inicio:hover {
      background-color: #2980b9;
      transform: scale(1.05);
    }
    
    .btn-modo-oscuro {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #7f8c8d;
      color: white;
      padding: 12px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 100;
      transition: transform 0.2s ease, background-color 0.2s ease;
    }
    
    .btn-modo-oscuro:hover {
      background-color: #95a5a6;
      transform: scale(1.05);
    }
    
    .mensaje-error, .mensaje-exito {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px;
      border-radius: 8px;
      color: white;
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease;
    }
    
    .mensaje-error {
      background-color: #e74c3c;
    }
    
    .mensaje-exito {
      background-color: #27ae60;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .vista-semanal {
      display: none;
    }
    
    .vista-semanal.activa {
      display: block;
    }
    
    .vista-mensual {
      display: block;
    }
    
    .vista-mensual.oculta {
      display: none;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .controles {
        flex-direction: column;
        align-items: stretch;
      }
      
      .navegacion, .filtros {
        justify-content: center;
      }
      
      .calendario td {
        height: 80px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- ... (el mismo HTML que antes, sin cambios en la estructura) ... -->
  <div class="container">
    <h2>üìÖ Calendario de Actividades Profesional</h2>
    
    <div class="usuario-info" id="usuarioInfo">
      <h3>Usuario Activo: <span id="nombreUsuario">Cargando...</span></h3>
      <p>Rol: <span id="rolUsuario">Usuario</span></p>
    </div>

    <div class="controles">
      <div class="navegacion">
        <button id="btnMesAnterior">‚óÄ Mes Anterior</button>
        <div class="mes-anio" id="mesAnioActual">Cargando...</div>
        <button id="btnMesSiguiente">Mes Siguiente ‚ñ∂</button>
      </div>
      
      <div class="vista-toggle">
        <button class="btn-vista activo" data-vista="mensual">üìÖ Mensual</button>
        <button class="btn-vista" data-vista="semanal">üìÜ Semanal</button>
      </div>
      
      <div class="filtros">
        <select id="selectMes">
          <option value="0">Enero</option>
          <option value="1">Febrero</option>
          <option value="2">Marzo</option>
          <option value="3">Abril</option>
          <option value="4">Mayo</option>
          <option value="5">Junio</option>
          <option value="6">Julio</option>
          <option value="7">Agosto</option>
          <option value="8">Septiembre</option>
          <option value="9">Octubre</option>
          <option value="10">Noviembre</option>
          <option value="11">Diciembre</option>
        </select>
        
        <select id="selectAnio">
          <!-- Se llenar√° din√°micamente -->
        </select>
      </div>
    </div>

    <!-- Vista Mensual -->
    <div class="vista-mensual" id="vistaMensual">
      <table class="calendario" id="calendario">
        <thead>
          <tr>
            <th>Domingo</th>
            <th>Lunes</th>
            <th>Martes</th>
            <th>Mi√©rcoles</th>
            <th>Jueves</th>
            <th>Viernes</th>
            <th>S√°bado</th>
          </tr>
        </thead>
        <tbody id="cuerpoCalendario">
          <!-- Se generar√° din√°micamente -->
        </tbody>
      </table>
    </div>

    <!-- Vista Semanal (placeholder) -->
    <div class="vista-semanal" id="vistaSemanal">
      <h3 id="tituloSemana">Semana del...</h3>
      <div id="contenidoSemanal">
        <!-- Se generar√° din√°micamente -->
      </div>
    </div>

    <div class="resumen-estadisticas" id="resumenEstadisticas">
      <div class="stat">Laborados: <span id="stat-laborados">0</span></div>
      <div class="stat">No Laborados: <span id="stat-no-laborados">0</span></div>
      <div class="stat">Libre 1: <span id="stat-libre1">0</span></div>
      <div class="stat">Libre 2: <span id="stat-libre2">0</span></div>
      <div class="stat">Libre 3: <span id="stat-libre3">0</span></div>
      <div class="stat">Vacaciones: <span id="stat-vacaciones">0</span></div>
      <div class="stat">Licencia: <span id="stat-licencia">0</span></div>
      <div class="stat">Biologico: <span id="stat-Biologico">0</span></div>
    </div>

    <div class="leyenda">
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #d5f5e3; border-left: 4px solid #27ae60;"></div>
        <span>‚úÖ Laborado</span>
      </div>
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #f5b7b1; border-left: 4px solid #c0392b;"></div>
        <span>‚ùå No Laborado</span>
      </div>
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #fdebd0; border-left: 4px solid #f39c12;"></div>
        <span>üî¥ Libre 1</span>
      </div>
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #fadbd8; border-left: 4px solid #e74c3c;"></div>
        <span>üü† Libre 2</span>
      </div>
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #d7bde2; border-left: 4px solid #9b59b6;"></div>
        <span>üü£ Libre 3</span>
      </div>
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #d6eaf8; border-left: 4px solid #3498db;"></div>
        <span>üèñÔ∏è Vacaciones</span>
      </div>
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #d5dbdb; border-left: 4px solid #95a5a6;"></div>
        <span>üè• Licencia</span>
      </div>
    </div>
  </div>

  <!-- Modal de Edici√≥n -->
  <div id="modalEdicion" class="modal">
    <div class="modal-contenido">
      <h3 class="modal-titulo">Editar D√≠a: <span id="fechaModal"></span></h3>
      
      <div class="form-group">
        <label for="tipoDia">Tipo de D√≠a:</label>
        <select id="tipoDia">
          <option value="">-- Seleccione tipo --</option>
          <option value="laborado">‚úÖ D√≠a Laborado</option>
          <option value="no_laborado">‚ùå D√≠a No Laborado</option>
          <option value="libre1">üî¥ Libre 1</option>
          <option value="libre2">üü† Libre 2</option>
          <option value="libre3">üü£ Libre 3</option>
          <option value="vacaciones">üèñÔ∏è Vacaciones</option>
          <option value="licencia">üè• Licencia</option>
          <option value="Biologico">üè• Biologico</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="comentarioDia">Comentario (m√°x. 500 caracteres):</label>
        <textarea id="comentarioDia" placeholder="Agregue un comentario para este d√≠a..."></textarea>
        <div id="contadorCaracteres" style="text-align: right; font-size: 12px; color: #7f8c8d;">0/500</div>
      </div>
      
      <div class="modal-botones">
        <button id="btnGuardarDia" class="btn-modal btn-guardar">üíæ Guardar</button>
        <button id="btnEliminarDia" class="btn-modal btn-cancelar" style="background-color: #e74c3c;">üóëÔ∏è Eliminar</button>
        <button id="btnCancelarModal" class="btn-modal btn-cancelar">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- üéØ Botones flotantes -->
  <a href="dashboard.html" class="btn-flotante-inicio" title="Ir al Dashboard">
    üè† Inicio
  </a>
  <a href="#" class="btn-modo-oscuro" id="btnModoOscuro" title="Alternar modo oscuro">
    üåô Modo Oscuro
  </a>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // üîπ Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDigm9JWEqr5h0YV3H6a-H3ub4N__2Y2q4",
      authDomain: "interinos-ccss.firebaseapp.com",
      projectId: "interinos-ccss",
      storageBucket: "interinos-ccss.firebasestorage.app",
      messagingSenderId: "1098694984589",
      appId: "1:1098694984589:web:180af36da33ff6a161b3c4"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Verificar sesi√≥n
    const usuario = JSON.parse(localStorage.getItem("usuarioActivo"));
    if (!usuario) {
      window.location.href = "login.html";
    } else {
      document.getElementById("nombreUsuario").textContent = usuario.nombre || "Usuario";
      document.getElementById("rolUsuario").textContent = usuario.rol || "Usuario";
    }

    // Variables globales
    let fechaActual = new Date();
    let datosCalendario = new Map();
    let unsubscribe = null;
    let vistaActual = "mensual";

    // üîπ Mostrar mensaje de notificaci√≥n
    function mostrarMensaje(mensaje, tipo = "error") {
      const contenedor = document.createElement("div");
      contenedor.className = `mensaje-${tipo}`;
      contenedor.textContent = mensaje;
      document.body.appendChild(contenedor);
      
      setTimeout(() => {
        if (contenedor.parentNode) {
          contenedor.parentNode.removeChild(contenedor);
        }
      }, 3000);
    }

    // üîπ Validar datos antes de guardar
    function validarDatosDia(tipo, comentario) {
      const tiposValidos = ["laborado", "no_laborado", "libre1", "libre2", "libre3", "vacaciones", "licencia" , "Biologico"];
      
      if (tipo && !tiposValidos.includes(tipo)) {
        throw new Error("Tipo de d√≠a inv√°lido");
      }
      
      if (comentario && (typeof comentario !== 'string' || comentario.length > 500)) {
        throw new Error("Comentario demasiado largo (m√°x. 500 caracteres)");
      }
      
      return true;
    }

    // üîπ Inicializar selectores de mes y a√±o
    function inicializarSelectores() {
      const selectMes = document.getElementById("selectMes");
      const selectAnio = document.getElementById("selectAnio");
      
      selectMes.value = fechaActual.getMonth();
      
      selectAnio.innerHTML = "";
      const anioActual = new Date().getFullYear();
      for (let year = anioActual - 2; year <= anioActual + 2; year++) {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = year;
        selectAnio.appendChild(option);
      }
      selectAnio.value = fechaActual.getFullYear();
      
      actualizarTituloMesAnio();
    }

    // üîπ Actualizar t√≠tulo del mes y a√±o
    function actualizarTituloMesAnio() {
      const meses = [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
      ];
      const mesTexto = meses[fechaActual.getMonth()];
      const anioTexto = fechaActual.getFullYear();
      document.getElementById("mesAnioActual").textContent = `${mesTexto} ${anioTexto}`;
    }

    // üîπ Escuchar cambios en tiempo real - ‚úÖ AHORA INCLUYE DATOS DEL USUARIO
    function escucharCambiosMes(mes, anio) {
      if (unsubscribe) {
        unsubscribe();
      }
      
      const calendarRef = collection(db, "calendar");
      // ‚úÖ El ID del documento incluye la c√©dula del usuario para aislamiento total
      const docRef = doc(calendarRef, `${usuario.cedula}_${anio}_${mes}`);
      
      unsubscribe = onSnapshot(docRef, (doc) => {
        datosCalendario.clear();
        if (doc.exists()) {
          const data = doc.data();
          Object.keys(data).forEach(fecha => {
            if (data[fecha]) {
              // ‚úÖ Verificar que los datos pertenezcan al usuario actual (seguridad adicional)
              const datosDia = data[fecha];
              if (!datosDia.usuario || datosDia.usuario.cedula === usuario.cedula) {
                datosCalendario.set(fecha, datosDia);
              }
            }
          });
        }
        generarCalendarioVisual();
        actualizarResumenEstadisticas();
      }, (error) => {
        console.error("Error en escucha en tiempo real:", error);
        mostrarMensaje("Error al sincronizar datos: " + error.message);
      });
    }

    // üîπ Guardar d√≠a en Firestore - ‚úÖ AHORA GUARDA DATOS DEL USUARIO
    async function guardarDia(fechaString, tipo, comentario) {
      try {
        validarDatosDia(tipo, comentario);
        
        const fecha = new Date(fechaString);
        const mes = fecha.getMonth();
        const anio = fecha.getFullYear();
        
        const calendarRef = collection(db, "calendar");
        const docRef = doc(calendarRef, `${usuario.cedula}_${anio}_${mes}`);
        
        const docSnap = await getDoc(docRef);
        let datosMes = {};
        if (docSnap.exists()) {
          datosMes = docSnap.data();
        }
        
        if (tipo) {
          // ‚úÖ Incluir datos del usuario en cada registro
          datosMes[fechaString] = { 
            tipo, 
            comentario: comentario || null,
            usuario: {
              cedula: usuario.cedula,
              nombre: usuario.nombre,
              rol: usuario.rol
            },
            ultimaActualizacion: new Date()
          };
        } else {
          delete datosMes[fechaString];
        }
        
        await setDoc(docRef, datosMes);
        return true;
      } catch (error) {
        console.error("Error al guardar d√≠a:", error);
        mostrarMensaje("Error al guardar: " + error.message);
        return false;
      }
    }

    // üîπ Resto de las funciones permanecen igual (crearCeldaDia, generarCalendarioVisual, etc.)
    // ... (el mismo c√≥digo que antes para las funciones restantes) ...

    // üîπ Generar calendario visual (solo vista, sin recargar datos)
    function generarCalendarioVisual() {
      const mes = fechaActual.getMonth();
      const anio = fechaActual.getFullYear();
      
      const primerDia = new Date(anio, mes, 1);
      const ultimoDia = new Date(anio, mes + 1, 0);
      const diaInicio = primerDia.getDay();
      const totalDias = ultimoDia.getDate();
      
      const tbody = document.getElementById("cuerpoCalendario");
      tbody.innerHTML = "";
      
      let dia = 1;
      let semana = [];
      
      for (let i = 0; i < diaInicio; i++) {
        semana.push(crearCeldaDia(null, mes, anio));
      }
      
      while (dia <= totalDias) {
        if (semana.length === 7) {
          agregarSemana(tbody, semana);
          semana = [];
        }
        semana.push(crearCeldaDia(dia, mes, anio));
        dia++;
      }
      
      while (semana.length < 7) {
        semana.push(crearCeldaDia(null, mes, anio));
      }
      
      if (semana.length > 0) {
        agregarSemana(tbody, semana);
      }
    }

    // üîπ Crear celda de d√≠a
    function crearCeldaDia(dia, mes, anio) {
      const celda = document.createElement("td");
      
      if (dia === null) {
        celda.className = "dia-vacio";
        celda.innerHTML = "";
        celda.setAttribute("role", "gridcell");
        celda.setAttribute("aria-label", "D√≠a vac√≠o");
        return celda;
      }
      
      const fechaCompleta = new Date(anio, mes, dia);
      const fechaString = fechaCompleta.toISOString().split('T')[0];
      const hoy = new Date();
      const esHoy = fechaCompleta.toDateString() === hoy.toDateString();
      
      // Validar si el d√≠a es editable
      const fechaMaxima = new Date(hoy.getFullYear(), hoy.getMonth() + 3, 0);
      const fechaMinima = new Date(hoy.getFullYear() - 1, hoy.getMonth(), 1);
      const esEditable = fechaCompleta >= fechaMinima && fechaCompleta <= fechaMaxima;
      
      const datosDia = datosCalendario.get(fechaString) || {};
      const tipoDia = datosDia.tipo || "";
      const comentario = datosDia.comentario || "";
      
      let claseDia = "";
      if (tipoDia) {
        claseDia = `dia-${tipoDia}`;
      }
      
      if (esHoy) {
        claseDia = claseDia ? `${claseDia} dia-hoy` : "dia-hoy";
      }
      
      if (!esEditable) {
        claseDia = claseDia ? `${claseDia} no-editable` : "no-editable";
      }
      
      celda.className = claseDia;
      celda.dataset.fecha = fechaString;
      
      // Iconos por tipo de d√≠a
      let icono = "";
      switch(tipoDia) {
        case "laborado": icono = "‚úÖ"; break;
        case "no_laborado": icono = "‚ùå"; break;
        case "libre1": icono = "üî¥"; break;
        case "libre2": icono = "üü†"; break;
        case "libre3": icono = "üü£"; break;
        case "vacaciones": icono = "üèñÔ∏è"; break;
        case "licencia": icono = "üè•"; break;
        case "case "licencia": icono = "üè•"; break;": icono = "üè•"; break;
        default: icono = "";
      }
      
      let contenido = `<div class="dia-numero">${dia}</div>`;
      if (icono) {
        contenido += `<div style="text-align: center; font-size: 18px; margin: 2px 0;">${icono}</div>`;
      }
      if (comentario) {
        contenido += `<div class="comentario-indicador" title="${comentario}">üí¨</div>`;
      }
      
      celda.innerHTML = contenido;
      
      // Atributos de accesibilidad
      let ariaLabel = `D√≠a ${dia}`;
      if (tipoDia) {
        const tiposTexto = {
          "laborado": "D√≠a Laborado",
          "no_laborado": "D√≠a No Laborado", 
          "libre1": "Libre 1",
          "libre2": "Libre 2",
          "libre3": "Libre 3",
          "vacaciones": "Vacaciones",
          "licencia": "Licencia"
          "Biologico": "Biologico"
        };
        ariaLabel += `, ${tiposTexto[tipoDia]}`;
      }
      if (comentario) {
        ariaLabel += `, Comentario: ${comentario}`;
      }
      if (!esEditable) {
        ariaLabel += ", No editable";
      }
      
      celda.setAttribute("role", "gridcell");
      celda.setAttribute("aria-label", ariaLabel);
      celda.setAttribute("tabindex", esEditable ? "0" : "-1");
      
      if (esEditable) {
        celda.addEventListener("click", () => abrirModalEdicion(fechaString, dia, mes, anio));
        celda.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            abrirModalEdicion(fechaString, dia, mes, anio);
          }
        });
      } else {
        celda.style.opacity = "0.6";
        celda.style.cursor = "not-allowed";
      }
      
      return celda;
    }

    // üîπ Agregar semana a la tabla
    function agregarSemana(tbody, semana) {
      const fila = document.createElement("tr");
      semana.forEach(celda => fila.appendChild(celda));
      tbody.appendChild(fila);
    }

    // üîπ Abrir modal de edici√≥n
    function abrirModalEdicion(fechaString, dia, mes, anio) {
      const modal = document.getElementById("modalEdicion");
      const fechaModal = document.getElementById("fechaModal");
      const tipoDia = document.getElementById("tipoDia");
      const comentarioDia = document.getElementById("comentarioDia");
      const contadorCaracteres = document.getElementById("contadorCaracteres");
      
      const fecha = new Date(fechaString);
      const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      fechaModal.textContent = `${dia} de ${meses[mes]} ${anio}`;
      
      const datosExistentes = datosCalendario.get(fechaString) || {};
      tipoDia.value = datosExistentes.tipo || "";
      comentarioDia.value = datosExistentes.comentario || "";
      
      // Actualizar contador de caracteres
      actualizarContadorCaracteres();
      comentarioDia.addEventListener("input", actualizarContadorCaracteres);
      
      modal.dataset.fecha = fechaString;
      modal.style.display = "flex";
    }

    // üîπ Actualizar contador de caracteres
    function actualizarContadorCaracteres() {
      const comentario = document.getElementById("comentarioDia");
      const contador = document.getElementById("contadorCaracteres");
      const longitud = comentario.value.length;
      contador.textContent = `${longitud}/500`;
      contador.style.color = longitud > 450 ? "#e74c3c" : "#7f8c8d";
    }

    // üîπ Eliminar d√≠a
    async function eliminarDia(fechaString) {
      if (confirm("¬øEst√° seguro que desea eliminar este d√≠a?")) {
        const resultado = await guardarDia(fechaString, "", "");
        if (resultado) {
          document.getElementById("modalEdicion").style.display = "none";
          mostrarMensaje("D√≠a eliminado correctamente", "exito");
        }
      }
    }

    // üîπ Actualizar resumen estad√≠stico
    function actualizarResumenEstadisticas() {
      const estadisticas = {
        laborado: 0,
        no_laborado: 0,
        libre1: 0,
        libre2: 0,
        libre3: 0,
        vacaciones: 0,
        licencia: 0
        Biologigico: 0
      };
      
      datosCalendario.forEach(datos => {
        if (estadisticas[datos.tipo] !== undefined) {
          estadisticas[datos.tipo]++;
        }
      });
      
      document.getElementById("stat-laborados").textContent = estadisticas.laborado;
      document.getElementById("stat-no-laborados").textContent = estadisticas.no_laborado;
      document.getElementById("stat-libre1").textContent = estadisticas.libre1;
      document.getElementById("stat-libre2").textContent = estadisticas.libre2;
      document.getElementById("stat-libre3").textContent = estadisticas.libre3;
      document.getElementById("stat-vacaciones").textContent = estadisticas.vacaciones;
      document.getElementById("stat-licencia").textContent = estadisticas.licencia;
      document.getElementById("stat-Biologico").textContent = estadisticas.Biologico;
    }

    // üîπ Cambiar vista
    function cambiarVista(vista) {
      if (vista === vistaActual) return;
      
      vistaActual = vista;
      
      // Actualizar botones
      document.querySelectorAll(".btn-vista").forEach(btn => {
        btn.classList.toggle("activo", btn.dataset.vista === vista);
      });
      
      // Mostrar/ocultar vistas
      const vistaMensual = document.getElementById("vistaMensual");
      const vistaSemanal = document.getElementById("vistaSemanal");
      
      if (vista === "mensual") {
        vistaMensual.classList.remove("oculta");
        vistaSemanal.classList.remove("activa");
      } else {
        vistaMensual.classList.add("oculta");
        vistaSemanal.classList.add("activa");
        generarVistaSemanal();
      }
    }

    // üîπ Generar vista semanal (placeholder - se puede expandir)
    function generarVistaSemanal() {
      const contenido = document.getElementById("contenidoSemanal");
      const titulo = document.getElementById("tituloSemana");
      
      const primerDiaSemana = new Date(fechaActual);
      primerDiaSemana.setDate(primerDiaSemana.getDate() - primerDiaSemana.getDay());
      
      titulo.textContent = `Semana del ${primerDiaSemana.toLocaleDateString('es-ES')}`;
      
      let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
      
      for (let i = 0; i < 7; i++) {
        const dia = new Date(primerDiaSemana);
        dia.setDate(dia.getDate() + i);
        const fechaString = dia.toISOString().split('T')[0];
        const datosDia = datosCalendario.get(fechaString) || {};
        const tipoDia = datosDia.tipo || "";
        const comentario = datosDia.comentario || "";
        
        let icono = "";
        switch(tipoDia) {
          case "laborado": icono = "‚úÖ"; break;
          case "no_laborado": icono = "‚ùå"; break;
          case "libre1": icono = "üî¥"; break;
          case "libre2": icono = "üü†"; break;
          case "libre3": icono = "üü£"; break;
          case "vacaciones": icono = "üèñÔ∏è"; break;
          case "licencia": icono = "üè•"; break;
          case "Biologico": icono = "üè•"; break;

          default: icono = "‚ö™";
        }
        
        html += `
          <div style="padding: 15px; border-radius: 8px; background: ${tipoDia ? '#f8f9fa' : '#e9ecef'};">
            <div style="font-weight: bold; margin-bottom: 8px;">
              ${dia.toLocaleDateString('es-ES', { weekday: 'long' })} ${dia.getDate()}
            </div>
            <div style="font-size: 24px; text-align: center; margin: 10px 0;">${icono}</div>
            ${comentario ? `<div style="font-size: 12px; color: #6c757d;">üí¨ ${comentario}</div>` : ''}
          </div>
        `;
      }
      
      html += '</div>';
      contenido.innerHTML = html;
    }

    // üîπ Alternar modo oscuro
    function alternarModoOscuro() {
      document.body.classList.toggle("dark-mode");
      const estaOscuro = document.body.classList.contains("dark-mode");
      localStorage.setItem("modoOscuro", estaOscuro);
      
      const btn = document.getElementById("btnModoOscuro");
      btn.textContent = estaOscuro ? "‚òÄÔ∏è Modo Claro" : "üåô Modo Oscuro";
    }

    // üîπ Restaurar modo oscuro
    function restaurarModoOscuro() {
      const modoGuardado = localStorage.getItem("modoOscuro") === "true";
      if (modoGuardado) {
        document.body.classList.add("dark-mode");
        document.getElementById("btnModoOscuro").textContent = "‚òÄÔ∏è Modo Claro";
      }
    }

    // üîπ Eventos de los botones
    document.getElementById("btnMesAnterior").addEventListener("click", () => {
      fechaActual.setMonth(fechaActual.getMonth() - 1);
      actualizarSelectores();
      escucharCambiosMes(fechaActual.getMonth(), fechaActual.getFullYear());
    });

    document.getElementById("btnMesSiguiente").addEventListener("click", () => {
      fechaActual.setMonth(fechaActual.getMonth() + 1);
      actualizarSelectores();
      escucharCambiosMes(fechaActual.getMonth(), fechaActual.getFullYear());
    });

    document.getElementById("selectMes").addEventListener("change", () => {
      fechaActual.setMonth(parseInt(document.getElementById("selectMes").value));
      escucharCambiosMes(fechaActual.getMonth(), fechaActual.getFullYear());
    });

    document.getElementById("selectAnio").addEventListener("change", () => {
      fechaActual.setFullYear(parseInt(document.getElementById("selectAnio").value));
      escucharCambiosMes(fechaActual.getMonth(), fechaActual.getFullYear());
    });

    document.querySelectorAll(".btn-vista").forEach(btn => {
      btn.addEventListener("click", () => {
        cambiarVista(btn.dataset.vista);
      });
    });

    document.getElementById("btnGuardarDia").addEventListener("click", async () => {
      const fechaString = document.getElementById("modalEdicion").dataset.fecha;
      const tipo = document.getElementById("tipoDia").value;
      const comentario = document.getElementById("comentarioDia").value;
      
      const resultado = await guardarDia(fechaString, tipo, comentario);
      if (resultado) {
        document.getElementById("modalEdicion").style.display = "none";
        mostrarMensaje("D√≠a guardado correctamente", "exito");
      }
    });

    document.getElementById("btnEliminarDia").addEventListener("click", () => {
      const fechaString = document.getElementById("modalEdicion").dataset.fecha;
      eliminarDia(fechaString);
    });

    document.getElementById("btnCancelarModal").addEventListener("click", () => {
      document.getElementById("modalEdicion").style.display = "none";
    });

    document.getElementById("btnModoOscuro").addEventListener("click", alternarModoOscuro);

    // Cerrar modal al hacer clic fuera
    window.addEventListener("click", (event) => {
      const modal = document.getElementById("modalEdicion");
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });

    // Atajos de teclado
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") {
        document.getElementById("btnMesAnterior").click();
      } else if (e.key === "ArrowRight") {
        document.getElementById("btnMesSiguiente").click();
      }
    });

    // üîπ Actualizar selectores cuando cambia la fecha
    function actualizarSelectores() {
      document.getElementById("selectMes").value = fechaActual.getMonth();
      document.getElementById("selectAnio").value = fechaActual.getFullYear();
      actualizarTituloMesAnio();
    }

    // üîπ Inicializar la aplicaci√≥n
    document.addEventListener("DOMContentLoaded", () => {
      restaurarModoOscuro();
      inicializarSelectores();
      escucharCambiosMes(fechaActual.getMonth(), fechaActual.getFullYear());
    });

    // Limpiar escucha al salir
    window.addEventListener("beforeunload", () => {
      if (unsubscribe) {
        unsubscribe();
      }
    });
  </script>
</body>
</html>