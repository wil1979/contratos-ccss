<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario de Actividades Profesional</title>
  <link rel="stylesheet" href="stylecalendar.css">
</head>
<body>
  <!-- ... (el mismo HTML que antes, sin cambios en la estructura) ... -->
  <div class="container">
    <h2>ğŸ“… Calendario de Actividades Profesional</h2>
    
    <div class="usuario-info" id="usuarioInfo">
      <h3>Usuario Activo: <span id="nombreUsuario">Cargando...</span></h3>
      <p>Rol: <span id="rolUsuario">Usuario</span></p>
    </div>

    <div class="controles">
      <div class="navegacion">
        <button id="btnMesAnterior">â—€ Mes Anterior</button>
        <div class="mes-anio" id="mesAnioActual">Cargando...</div>
        <button id="btnMesSiguiente">Mes Siguiente â–¶</button>
      </div>
      
      <div class="vista-toggle">
        <button class="btn-vista activo" data-vista="mensual">ğŸ“… Mensual</button>
        <button class="btn-vista" data-vista="semanal">ğŸ“† Semanal</button>
      </div>
      
      <div class="filtros">
        <select id="selectMes">
          <option value="0">Enero</option>
          <option value="1">Febrero</option>
          <option value="2">Marzo</option>
          <option value="3">Abril</option>
          <option value="4">Mayo</option>
          <option value="5">Junio</option>
          <option value="6">Julio</option>
          <option value="7">Agosto</option>
          <option value="8">Septiembre</option>
          <option value="9">Octubre</option>
          <option value="10">Noviembre</option>
          <option value="11">Diciembre</option>
        </select>
        
        <select id="selectAnio">
          <!-- Se llenarÃ¡ dinÃ¡micamente -->
        </select>
      </div>
    </div>

    <!-- Vista Mensual -->
    <div class="vista-mensual" id="vistaMensual">
      <table class="calendario" id="calendario">
        <thead>
          <tr>
            <th>Domingo</th>
            <th>Lunes</th>
            <th>Martes</th>
            <th>MiÃ©rcoles</th>
            <th>Jueves</th>
            <th>Viernes</th>
            <th>SÃ¡bado</th>
          </tr>
        </thead>
        <tbody id="cuerpoCalendario">
          <!-- Se generarÃ¡ dinÃ¡micamente -->
        </tbody>
      </table>
    </div>

    <!-- Vista Semanal (placeholder) -->
    <div class="vista-semanal" id="vistaSemanal">
      <h3 id="tituloSemana">Semana del...</h3>
      <div id="contenidoSemanal">
        <!-- Se generarÃ¡ dinÃ¡micamente -->
      </div>
    </div>

    <div class="resumen-estadisticas" id="resumenEstadisticas">
      <div class="stat">Laborados: <span id="stat-laborados">0</span></div>
      <div class="stat">No Laborados: <span id="stat-no-laborados">0</span></div>
      <div class="stat">Libre 1: <span id="stat-libre1">0</span></div>
      <div class="stat">Libre 2: <span id="stat-libre2">0</span></div>
      <div class="stat">Libre 3: <span id="stat-libre3">0</span></div>
      <div class="stat">Vacaciones: <span id="stat-vacaciones">0</span></div>
      <div class="stat">Licencia: <span id="stat-licencia">0</span></div>
    </div>

    <div class="leyenda">
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #d5f5e3; border-left: 4px solid #27ae60;"></div>
        <span>âœ… Laborado</span>
      </div>
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #f5b7b1; border-left: 4px solid #c0392b;"></div>
        <span>âŒ No Laborado</span>
      </div>
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #fdebd0; border-left: 4px solid #f39c12;"></div>
        <span>ğŸ”´ Libre 1</span>
      </div>
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #fadbd8; border-left: 4px solid #e74c3c;"></div>
        <span>ğŸŸ  Libre 2</span>
      </div>
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #d7bde2; border-left: 4px solid #9b59b6;"></div>
        <span>ğŸŸ£ Libre 3</span>
      </div>
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #d6eaf8; border-left: 4px solid #3498db;"></div>
        <span>ğŸ–ï¸ Vacaciones</span>
      </div>
      <div class="leyenda-item">
        <div class="leyenda-color" style="background-color: #d5dbdb; border-left: 4px solid #95a5a6;"></div>
        <span>ğŸ¥ Licencia</span>
      </div>
    </div>
  </div>

  <!-- Modal de EdiciÃ³n -->
  <div id="modalEdicion" class="modal">
    <div class="modal-contenido">
      <h3 class="modal-titulo">Editar DÃ­a: <span id="fechaModal"></span></h3>
      
      <div class="form-group">
        <label for="tipoDia">Tipo de DÃ­a:</label>
        <select id="tipoDia">
          <option value="">-- Seleccione tipo --</option>
          <option value="laborado">âœ… DÃ­a Laborado</option>
          <option value="no_laborado">âŒ DÃ­a No Laborado</option>
          <option value="libre1">ğŸ”´ Libre 1</option>
          <option value="libre2">ğŸŸ  Libre 2</option>
          <option value="libre3">ğŸŸ£ Libre 3</option>
          <option value="vacaciones">ğŸ–ï¸ Vacaciones</option>
          <option value="licencia">ğŸ¥ Licencia</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="comentarioDia">Comentario (mÃ¡x. 500 caracteres):</label>
        <textarea id="comentarioDia" placeholder="Agregue un comentario para este dÃ­a..."></textarea>
        <div id="contadorCaracteres" style="text-align: right; font-size: 12px; color: #7f8c8d;">0/500</div>
      </div>
      
      <div class="modal-botones">
        <button id="btnGuardarDia" class="btn-modal btn-guardar">ğŸ’¾ Guardar</button>
        <button id="btnEliminarDia" class="btn-modal btn-cancelar" style="background-color: #e74c3c;">ğŸ—‘ï¸ Eliminar</button>
        <button id="btnCancelarModal" class="btn-modal btn-cancelar">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- ğŸ¯ Botones flotantes -->
  <a href="dashboard.html" class="btn-flotante-inicio" title="Ir al Dashboard">
    ğŸ  Inicio
  </a>
  <a href="#" class="btn-modo-oscuro" id="btnModoOscuro" title="Alternar modo oscuro">
    ğŸŒ™ Modo Oscuro
  </a>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // ğŸ”¹ ConfiguraciÃ³n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDigm9JWEqr5h0YV3H6a-H3ub4N__2Y2q4",
      authDomain: "interinos-ccss.firebaseapp.com",
      projectId: "interinos-ccss",
      storageBucket: "interinos-ccss.firebasestorage.app",
      messagingSenderId: "1098694984589",
      appId: "1:1098694984589:web:180af36da33ff6a161b3c4"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Verificar sesiÃ³n
    const usuario = JSON.parse(localStorage.getItem("usuarioActivo"));
    if (!usuario) {
      window.location.href = "login.html";
    } else {
      document.getElementById("nombreUsuario").textContent = usuario.nombre || "Usuario";
      document.getElementById("rolUsuario").textContent = usuario.rol || "Usuario";
    }

    // Variables globales
    let fechaActual = new Date();
    let datosCalendario = new Map();
    let unsubscribe = null;
    let vistaActual = "mensual";

    // ğŸ”¹ Mostrar mensaje de notificaciÃ³n
    function mostrarMensaje(mensaje, tipo = "error") {
      const contenedor = document.createElement("div");
      contenedor.className = `mensaje-${tipo}`;
      contenedor.textContent = mensaje;
      document.body.appendChild(contenedor);
      
      setTimeout(() => {
        if (contenedor.parentNode) {
          contenedor.parentNode.removeChild(contenedor);
        }
      }, 3000);
    }

    // ğŸ”¹ Validar datos antes de guardar
    function validarDatosDia(tipo, comentario) {
      const tiposValidos = ["laborado", "no_laborado", "libre1", "libre2", "libre3", "vacaciones", "licencia"];
      
      if (tipo && !tiposValidos.includes(tipo)) {
        throw new Error("Tipo de dÃ­a invÃ¡lido");
      }
      
      if (comentario && (typeof comentario !== 'string' || comentario.length > 500)) {
        throw new Error("Comentario demasiado largo (mÃ¡x. 500 caracteres)");
      }
      
      return true;
    }

    // ğŸ”¹ Inicializar selectores de mes y aÃ±o
    function inicializarSelectores() {
      const selectMes = document.getElementById("selectMes");
      const selectAnio = document.getElementById("selectAnio");
      
      selectMes.value = fechaActual.getMonth();
      
      selectAnio.innerHTML = "";
      const anioActual = new Date().getFullYear();
      for (let year = anioActual - 2; year <= anioActual + 2; year++) {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = year;
        selectAnio.appendChild(option);
      }
      selectAnio.value = fechaActual.getFullYear();
      
      actualizarTituloMesAnio();
    }

    // ğŸ”¹ Actualizar tÃ­tulo del mes y aÃ±o
    function actualizarTituloMesAnio() {
      const meses = [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
      ];
      const mesTexto = meses[fechaActual.getMonth()];
      const anioTexto = fechaActual.getFullYear();
      document.getElementById("mesAnioActual").textContent = `${mesTexto} ${anioTexto}`;
    }

    // ğŸ”¹ Escuchar cambios en tiempo real - âœ… AHORA INCLUYE DATOS DEL USUARIO
    function escucharCambiosMes(mes, anio) {
      if (unsubscribe) {
        unsubscribe();
      }
      
      const calendarRef = collection(db, "calendar");
      // âœ… El ID del documento incluye la cÃ©dula del usuario para aislamiento total
      const docRef = doc(calendarRef, `${usuario.cedula}_${anio}_${mes}`);
      
      unsubscribe = onSnapshot(docRef, (doc) => {
        datosCalendario.clear();
        if (doc.exists()) {
          const data = doc.data();
          Object.keys(data).forEach(fecha => {
            if (data[fecha]) {
              // âœ… Verificar que los datos pertenezcan al usuario actual (seguridad adicional)
              const datosDia = data[fecha];
              if (!datosDia.usuario || datosDia.usuario.cedula === usuario.cedula) {
                datosCalendario.set(fecha, datosDia);
              }
            }
          });
        }
        generarCalendarioVisual();
        actualizarResumenEstadisticas();
      }, (error) => {
        console.error("Error en escucha en tiempo real:", error);
        mostrarMensaje("Error al sincronizar datos: " + error.message);
      });
    }

    // ğŸ”¹ Guardar dÃ­a en Firestore - âœ… AHORA GUARDA DATOS DEL USUARIO
    async function guardarDia(fechaString, tipo, comentario) {
      try {
        validarDatosDia(tipo, comentario);
        
        const fecha = new Date(fechaString);
        const mes = fecha.getMonth();
        const anio = fecha.getFullYear();
        
        const calendarRef = collection(db, "calendar");
        const docRef = doc(calendarRef, `${usuario.cedula}_${anio}_${mes}`);
        
        const docSnap = await getDoc(docRef);
        let datosMes = {};
        if (docSnap.exists()) {
          datosMes = docSnap.data();
        }
        
        if (tipo) {
          // âœ… Incluir datos del usuario en cada registro
          datosMes[fechaString] = { 
            tipo, 
            comentario: comentario || null,
            usuario: {
              cedula: usuario.cedula,
              nombre: usuario.nombre,
              rol: usuario.rol
            },
            ultimaActualizacion: new Date()
          };
        } else {
          delete datosMes[fechaString];
        }
        
        await setDoc(docRef, datosMes);
        return true;
      } catch (error) {
        console.error("Error al guardar dÃ­a:", error);
        mostrarMensaje("Error al guardar: " + error.message);
        return false;
      }
    }

    // ğŸ”¹ Resto de las funciones permanecen igual (crearCeldaDia, generarCalendarioVisual, etc.)
    // ... (el mismo cÃ³digo que antes para las funciones restantes) ...

    // ğŸ”¹ Generar calendario visual (solo vista, sin recargar datos)
    function generarCalendarioVisual() {
      const mes = fechaActual.getMonth();
      const anio = fechaActual.getFullYear();
      
      const primerDia = new Date(anio, mes, 1);
      const ultimoDia = new Date(anio, mes + 1, 0);
      const diaInicio = primerDia.getDay();
      const totalDias = ultimoDia.getDate();
      
      const tbody = document.getElementById("cuerpoCalendario");
      tbody.innerHTML = "";
      
      let dia = 1;
      let semana = [];
      
      for (let i = 0; i < diaInicio; i++) {
        semana.push(crearCeldaDia(null, mes, anio));
      }
      
      while (dia <= totalDias) {
        if (semana.length === 7) {
          agregarSemana(tbody, semana);
          semana = [];
        }
        semana.push(crearCeldaDia(dia, mes, anio));
        dia++;
      }
      
      while (semana.length < 7) {
        semana.push(crearCeldaDia(null, mes, anio));
      }
      
      if (semana.length > 0) {
        agregarSemana(tbody, semana);
      }
    }

    // ğŸ”¹ Crear celda de dÃ­a
    function crearCeldaDia(dia, mes, anio) {
      const celda = document.createElement("td");
      
      if (dia === null) {
        celda.className = "dia-vacio";
        celda.innerHTML = "";
        celda.setAttribute("role", "gridcell");
        celda.setAttribute("aria-label", "DÃ­a vacÃ­o");
        return celda;
      }
      
      const fechaCompleta = new Date(anio, mes, dia);
      const fechaString = fechaCompleta.toISOString().split('T')[0];
      const hoy = new Date();
      const esHoy = fechaCompleta.toDateString() === hoy.toDateString();
      
      // Validar si el dÃ­a es editable
      const fechaMaxima = new Date(hoy.getFullYear(), hoy.getMonth() + 3, 0);
      const fechaMinima = new Date(hoy.getFullYear() - 1, hoy.getMonth(), 1);
      const esEditable = fechaCompleta >= fechaMinima && fechaCompleta <= fechaMaxima;
      
      const datosDia = datosCalendario.get(fechaString) || {};
      const tipoDia = datosDia.tipo || "";
      const comentario = datosDia.comentario || "";
      
      let claseDia = "";
      if (tipoDia) {
        claseDia = `dia-${tipoDia}`;
      }
      
      if (esHoy) {
        claseDia = claseDia ? `${claseDia} dia-hoy` : "dia-hoy";
      }
      
      if (!esEditable) {
        claseDia = claseDia ? `${claseDia} no-editable` : "no-editable";
      }
      
      celda.className = claseDia;
      celda.dataset.fecha = fechaString;
      
      // Iconos por tipo de dÃ­a
      let icono = "";
      switch(tipoDia) {
        case "laborado": icono = "âœ…"; break;
        case "no_laborado": icono = "âŒ"; break;
        case "libre1": icono = "ğŸ”´"; break;
        case "libre2": icono = "ğŸŸ "; break;
        case "libre3": icono = "ğŸŸ£"; break;
        case "vacaciones": icono = "ğŸ–ï¸"; break;
        case "licencia": icono = "ğŸ¥"; break;
        default: icono = "";
      }
      
      let contenido = `<div class="dia-numero">${dia}</div>`;
      if (icono) {
        contenido += `<div style="text-align: center; font-size: 18px; margin: 2px 0;">${icono}</div>`;
      }
      if (comentario) {
        contenido += `<div class="comentario-indicador" title="${comentario}">ğŸ’¬</div>`;
      }
      
      celda.innerHTML = contenido;
      
      // Atributos de accesibilidad
      let ariaLabel = `DÃ­a ${dia}`;
      if (tipoDia) {
        const tiposTexto = {
          "laborado": "DÃ­a Laborado",
          "no_laborado": "DÃ­a No Laborado", 
          "libre1": "Libre 1",
          "libre2": "Libre 2",
          "libre3": "Libre 3",
          "vacaciones": "Vacaciones",
          "licencia": "Licencia"
        };
        ariaLabel += `, ${tiposTexto[tipoDia]}`;
      }
      if (comentario) {
        ariaLabel += `, Comentario: ${comentario}`;
      }
      if (!esEditable) {
        ariaLabel += ", No editable";
      }
      
      celda.setAttribute("role", "gridcell");
      celda.setAttribute("aria-label", ariaLabel);
      celda.setAttribute("tabindex", esEditable ? "0" : "-1");
      
      if (esEditable) {
        celda.addEventListener("click", () => abrirModalEdicion(fechaString, dia, mes, anio));
        celda.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            abrirModalEdicion(fechaString, dia, mes, anio);
          }
        });
      } else {
        celda.style.opacity = "0.6";
        celda.style.cursor = "not-allowed";
      }
      
      return celda;
    }

    // ğŸ”¹ Agregar semana a la tabla
    function agregarSemana(tbody, semana) {
      const fila = document.createElement("tr");
      semana.forEach(celda => fila.appendChild(celda));
      tbody.appendChild(fila);
    }

    // ğŸ”¹ Abrir modal de ediciÃ³n
    function abrirModalEdicion(fechaString, dia, mes, anio) {
      const modal = document.getElementById("modalEdicion");
      const fechaModal = document.getElementById("fechaModal");
      const tipoDia = document.getElementById("tipoDia");
      const comentarioDia = document.getElementById("comentarioDia");
      const contadorCaracteres = document.getElementById("contadorCaracteres");
      
      const fecha = new Date(fechaString);
      const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      fechaModal.textContent = `${dia} de ${meses[mes]} ${anio}`;
      
      const datosExistentes = datosCalendario.get(fechaString) || {};
      tipoDia.value = datosExistentes.tipo || "";
      comentarioDia.value = datosExistentes.comentario || "";
      
      // Actualizar contador de caracteres
      actualizarContadorCaracteres();
      comentarioDia.addEventListener("input", actualizarContadorCaracteres);
      
      modal.dataset.fecha = fechaString;
      modal.style.display = "flex";
    }

    // ğŸ”¹ Actualizar contador de caracteres
    function actualizarContadorCaracteres() {
      const comentario = document.getElementById("comentarioDia");
      const contador = document.getElementById("contadorCaracteres");
      const longitud = comentario.value.length;
      contador.textContent = `${longitud}/500`;
      contador.style.color = longitud > 450 ? "#e74c3c" : "#7f8c8d";
    }

    // ğŸ”¹ Eliminar dÃ­a
    async function eliminarDia(fechaString) {
      if (confirm("Â¿EstÃ¡ seguro que desea eliminar este dÃ­a?")) {
        const resultado = await guardarDia(fechaString, "", "");
        if (resultado) {
          document.getElementById("modalEdicion").style.display = "none";
          mostrarMensaje("DÃ­a eliminado correctamente", "exito");
        }
      }
    }

    // ğŸ”¹ Actualizar resumen estadÃ­stico
    function actualizarResumenEstadisticas() {
      const estadisticas = {
        laborado: 0,
        no_laborado: 0,
        libre1: 0,
        libre2: 0,
        libre3: 0,
        vacaciones: 0,
        licencia: 0
      };
      
      datosCalendario.forEach(datos => {
        if (estadisticas[datos.tipo] !== undefined) {
          estadisticas[datos.tipo]++;
        }
      });
      
      document.getElementById("stat-laborados").textContent = estadisticas.laborado;
      document.getElementById("stat-no-laborados").textContent = estadisticas.no_laborado;
      document.getElementById("stat-libre1").textContent = estadisticas.libre1;
      document.getElementById("stat-libre2").textContent = estadisticas.libre2;
      document.getElementById("stat-libre3").textContent = estadisticas.libre3;
      document.getElementById("stat-vacaciones").textContent = estadisticas.vacaciones;
      document.getElementById("stat-licencia").textContent = estadisticas.licencia;
    }

    // ğŸ”¹ Cambiar vista
    function cambiarVista(vista) {
      if (vista === vistaActual) return;
      
      vistaActual = vista;
      
      // Actualizar botones
      document.querySelectorAll(".btn-vista").forEach(btn => {
        btn.classList.toggle("activo", btn.dataset.vista === vista);
      });
      
      // Mostrar/ocultar vistas
      const vistaMensual = document.getElementById("vistaMensual");
      const vistaSemanal = document.getElementById("vistaSemanal");
      
      if (vista === "mensual") {
        vistaMensual.classList.remove("oculta");
        vistaSemanal.classList.remove("activa");
      } else {
        vistaMensual.classList.add("oculta");
        vistaSemanal.classList.add("activa");
        generarVistaSemanal();
      }
    }

    // ğŸ”¹ Generar vista semanal (placeholder - se puede expandir)
    function generarVistaSemanal() {
      const contenido = document.getElementById("contenidoSemanal");
      const titulo = document.getElementById("tituloSemana");
      
      const primerDiaSemana = new Date(fechaActual);
      primerDiaSemana.setDate(primerDiaSemana.getDate() - primerDiaSemana.getDay());
      
      titulo.textContent = `Semana del ${primerDiaSemana.toLocaleDateString('es-ES')}`;
      
      let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
      
      for (let i = 0; i < 7; i++) {
        const dia = new Date(primerDiaSemana);
        dia.setDate(dia.getDate() + i);
        const fechaString = dia.toISOString().split('T')[0];
        const datosDia = datosCalendario.get(fechaString) || {};
        const tipoDia = datosDia.tipo || "";
        const comentario = datosDia.comentario || "";
        
        let icono = "";
        switch(tipoDia) {
          case "laborado": icono = "âœ…"; break;
          case "no_laborado": icono = "âŒ"; break;
          case "libre1": icono = "ğŸ”´"; break;
          case "libre2": icono = "ğŸŸ "; break;
          case "libre3": icono = "ğŸŸ£"; break;
          case "vacaciones": icono = "ğŸ–ï¸"; break;
          case "licencia": icono = "ğŸ¥"; break;
          default: icono = "âšª";
        }
        
        html += `
          <div style="padding: 15px; border-radius: 8px; background: ${tipoDia ? '#f8f9fa' : '#e9ecef'};">
            <div style="font-weight: bold; margin-bottom: 8px;">
              ${dia.toLocaleDateString('es-ES', { weekday: 'long' })} ${dia.getDate()}
            </div>
            <div style="font-size: 24px; text-align: center; margin: 10px 0;">${icono}</div>
            ${comentario ? `<div style="font-size: 12px; color: #6c757d;">ğŸ’¬ ${comentario}</div>` : ''}
          </div>
        `;
      }
      
      html += '</div>';
      contenido.innerHTML = html;
    }

    // ğŸ”¹ Alternar modo oscuro
    function alternarModoOscuro() {
      document.body.classList.toggle("dark-mode");
      const estaOscuro = document.body.classList.contains("dark-mode");
      localStorage.setItem("modoOscuro", estaOscuro);
      
      const btn = document.getElementById("btnModoOscuro");
      btn.textContent = estaOscuro ? "â˜€ï¸ Modo Claro" : "ğŸŒ™ Modo Oscuro";
    }

    // ğŸ”¹ Restaurar modo oscuro
    function restaurarModoOscuro() {
      const modoGuardado = localStorage.getItem("modoOscuro") === "true";
      if (modoGuardado) {
        document.body.classList.add("dark-mode");
        document.getElementById("btnModoOscuro").textContent = "â˜€ï¸ Modo Claro";
      }
    }

    // ğŸ”¹ Eventos de los botones
    document.getElementById("btnMesAnterior").addEventListener("click", () => {
      fechaActual.setMonth(fechaActual.getMonth() - 1);
      actualizarSelectores();
      escucharCambiosMes(fechaActual.getMonth(), fechaActual.getFullYear());
    });

    document.getElementById("btnMesSiguiente").addEventListener("click", () => {
      fechaActual.setMonth(fechaActual.getMonth() + 1);
      actualizarSelectores();
      escucharCambiosMes(fechaActual.getMonth(), fechaActual.getFullYear());
    });

    document.getElementById("selectMes").addEventListener("change", () => {
      fechaActual.setMonth(parseInt(document.getElementById("selectMes").value));
      escucharCambiosMes(fechaActual.getMonth(), fechaActual.getFullYear());
    });

    document.getElementById("selectAnio").addEventListener("change", () => {
      fechaActual.setFullYear(parseInt(document.getElementById("selectAnio").value));
      escucharCambiosMes(fechaActual.getMonth(), fechaActual.getFullYear());
    });

    document.querySelectorAll(".btn-vista").forEach(btn => {
      btn.addEventListener("click", () => {
        cambiarVista(btn.dataset.vista);
      });
    });

    document.getElementById("btnGuardarDia").addEventListener("click", async () => {
      const fechaString = document.getElementById("modalEdicion").dataset.fecha;
      const tipo = document.getElementById("tipoDia").value;
      const comentario = document.getElementById("comentarioDia").value;
      
      const resultado = await guardarDia(fechaString, tipo, comentario);
      if (resultado) {
        document.getElementById("modalEdicion").style.display = "none";
        mostrarMensaje("DÃ­a guardado correctamente", "exito");
      }
    });

    document.getElementById("btnEliminarDia").addEventListener("click", () => {
      const fechaString = document.getElementById("modalEdicion").dataset.fecha;
      eliminarDia(fechaString);
    });

    document.getElementById("btnCancelarModal").addEventListener("click", () => {
      document.getElementById("modalEdicion").style.display = "none";
    });

    document.getElementById("btnModoOscuro").addEventListener("click", alternarModoOscuro);

    // Cerrar modal al hacer clic fuera
    window.addEventListener("click", (event) => {
      const modal = document.getElementById("modalEdicion");
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });

    // Atajos de teclado
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") {
        document.getElementById("btnMesAnterior").click();
      } else if (e.key === "ArrowRight") {
        document.getElementById("btnMesSiguiente").click();
      }
    });

    // ğŸ”¹ Actualizar selectores cuando cambia la fecha
    function actualizarSelectores() {
      document.getElementById("selectMes").value = fechaActual.getMonth();
      document.getElementById("selectAnio").value = fechaActual.getFullYear();
      actualizarTituloMesAnio();
    }

    // ğŸ”¹ Inicializar la aplicaciÃ³n
    document.addEventListener("DOMContentLoaded", () => {
      restaurarModoOscuro();
      inicializarSelectores();
      escucharCambiosMes(fechaActual.getMonth(), fechaActual.getFullYear());
    });

    // Limpiar escucha al salir
    window.addEventListener("beforeunload", () => {
      if (unsubscribe) {
        unsubscribe();
      }
    });
  </script>
</body>
</html>