<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consultas de Nombramientos</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f5f7fa;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #2c3e50;
    }
    
    .usuario-info {
      background-color: #e8f4f8;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .filtros {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: end;
    }
    
    .filtros > div {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .filtros label {
      font-weight: 600;
      color: #34495e;
    }
    
    .filtros select, .filtros button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .filtros button {
      background-color: #3498db;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    
    .filtros button:hover {
      background-color: #2980b9;
    }
    
    #btnExportarPDF {
      background-color: #27ae60;
    }
    
    #btnExportarPDF:hover {
      background-color: #219653;
    }
    
    #btnVerDiasLibres {
      background-color: #9b59b6;
    }
    
    #btnVerDiasLibres:hover {
      background-color: #8e44ad;
    }
    
    .tabla-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background-color: #f8f9fa;
      color: #2c3e50;
      font-weight: 600;
    }
    
    tr:hover {
      background-color: #f8f9fa;
    }
    
    .acciones {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    .btn-detalle, .btn-editar, .btn-guardar, .btn-cancelar {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }
    
    .btn-detalle {
      background-color: #9b59b6;
      color: white;
    }
    
    .btn-detalle:hover {
      background-color: #8e44ad;
    }
    
    .btn-editar {
      background-color: #3498db;
      color: white;
    }
    
    .btn-editar:hover {
      background-color: #2980b9;
    }
    
    .btn-guardar {
      background-color: #27ae60;
      color: white;
      display: none;
    }
    
    .btn-guardar:hover {
      background-color: #219653;
    }
    
    .btn-cancelar {
      background-color: #e74c3c;
      color: white;
      display: none;
    }
    
    .btn-cancelar:hover {
      background-color: #c0392b;
    }
    
    .cargando, .sin-datos, .error {
      text-align: center;
      padding: 20px;
      font-style: italic;
    }
    
    .error {
      color: #e74c3c;
    }
    
    .sin-datos {
      color: #7f8c8d;
    }
    
    /* Modal de Confirmación */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-contenido {
      background-color: white;
      margin: 5% auto;
      padding: 25px;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      position: relative;
    }
    
    .modal-titulo {
      margin-bottom: 20px;
      color: #2c3e50;
      text-align: center;
    }
    
    .modal-botones {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    
    .btn-modal {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
    }
    
    .btn-aceptar {
      background-color: #27ae60;
      color: white;
    }
    
    .btn-aceptar:hover {
      background-color: #219653;
    }
    
    .btn-cancelar-modal {
      background-color: #95a5a6;
      color: white;
    }
    
    .btn-cancelar-modal:hover {
      background-color: #7f8c8d;
    }
    
    /* Modal de Detalle */
    .detalle-info {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .detalle-info p {
      margin: 8px 0;
    }
    
    .dias-seleccion h4 {
      margin-bottom: 15px;
      color: #34495e;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #34495e;
    }
    
    .form-control, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .btn-flotante-inicio {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #3498db;
      color: white;
      padding: 12px 20px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 100;
    }
    
    .btn-flotante-inicio:hover {
      background-color: #2980b9;
      transform: scale(1.05);
      transition: transform 0.2s;
    }
    
    /* Estilo para días libres */
    .dias-libres-info {
      font-size: 12px;
      color: #8e44ad;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Consultas de Nombramientos</h2>

    <!-- Información del usuario activo -->
    <div class="usuario-info" id="usuarioInfo">
      <h3>Usuario Activo: <span id="nombreUsuario">Cargando...</span></h3>
      <p>Rol: <span id="rolUsuario">Administrador</span></p>
    </div>

    <div class="filtros">
      <div>
        <label for="mes">Mes:</label>
        <select id="mes">
          <option value="">Todos los meses</option>
          <option value="1">Enero</option>
          <option value="2">Febrero</option>
          <option value="3">Marzo</option>
          <option value="4">Abril</option>
          <option value="5">Mayo</option>
          <option value="6">Junio</option>
          <option value="7">Julio</option>
          <option value="8">Agosto</option>
          <option value="9">Septiembre</option>
          <option value="10">Octubre</option>
          <option value="11">Noviembre</option>
          <option value="12">Diciembre</option>
        </select>
      </div>

      <div>
        <label for="anio">Año:</label>
        <select id="anio">
          <!-- Se llenará dinámicamente con JavaScript -->
        </select>
      </div>

      <button id="btnFiltrar">Filtrar</button>
      <button id="btnExportarPDF">📄 Exportar PDF</button>
      <button id="btnVerDiasLibres">📊 Ver Días Libres</button>
    </div>

    <div class="tabla-container">
      <div id="mensajeError" class="error" style="display:none;"></div>
      <table id="tablaNombramientos">
        <thead>
          <tr>
            <th>Cédula Sustituido</th>
            <th>Funcionario Sustituido</th>
            <th>Área</th>
            <th>Código Área</th>
            <th>Inicio</th>
            <th>Final</th>
            <th>Horario</th>
            <th>Días</th>
            <th>Salario</th>
            <th>Estado</th>
            <th>Días Libres</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaRegistros">
          <tr><td colspan="12" class="cargando">Cargando datos del mes actual...</td></tr>
        </tbody>
      </table>
      <div id="mensajeSinDatos" class="sin-datos" style="display:none;">
        📭 No se encontraron nombramientos para este mes y año.
      </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="modalConfirmacion" class="modal">
      <div class="modal-contenido">
        <h3 class="modal-titulo">Confirmar Cambios</h3>
        <p id="mensajeConfirmacion">¿Está seguro que desea guardar los cambios realizados?</p>
        <div class="modal-botones">
          <button id="btnAceptar" class="btn-modal btn-aceptar">Aceptar</button>
          <button id="btnCancelarModal" class="btn-modal btn-cancelar-modal">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Detalle de Nombramiento -->
    <div id="modalDetalle" class="modal">
      <div class="modal-contenido" style="max-width: 800px; width: 90%;">
        <h3 class="modal-titulo">Detalles del Nombramiento</h3>
        
        <div class="detalle-info">
          <p><strong>Funcionario:</strong> <span id="detalleFuncionario"></span></p>
          <p><strong>Período:</strong> <span id="detallePeriodo"></span></p>
          <p><strong>Área:</strong> <span id="detalleArea"></span></p>
        </div>

        <div class="dias-seleccion">
          <h4>Días del período (<span id="totalDias"></span> días totales)</h4>
          <div id="diasContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin: 15px 0;"></div>
        </div>

        <div class="form-group">
          <label for="tipoAusencia">Tipo de Ausencia:</label>
          <select id="tipoAusencia" class="form-control">
            <option value="">-- Seleccione tipo --</option>
            <option value="libre1">Libre 1</option>
            <option value="libre2">Libre 2</option>
            <option value="libre3">Libre 3</option>
            <option value="vacaciones">Vacaciones</option>
            <option value="incapacidad">Incapacidad</option>
            <option value="licencia">Licencia</option>
          </select>
        </div>

        <div class="form-group">
          <label for="comentarioAusencia">Comentario:</label>
          <textarea id="comentarioAusencia" placeholder="Comentario adicional sobre la ausencia..."></textarea>
        </div>

        <div class="modal-botones">
          <button id="btnGuardarDetalle" class="btn-modal btn-aceptar">💾 Guardar Detalles</button>
          <button id="btnCerrarDetalle" class="btn-modal btn-cancelar-modal">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- 🎯 Botón flotante "Inicio" -->
    <a href="dashboard.html" class="btn-flotante-inicio" title="Ir al Dashboard">
      🏠 Inicio
    </a>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // 🔹 Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDigm9JWEqr5h0YV3H6a-H3ub4N__2Y2q4",
      authDomain: "interinos-ccss.firebaseapp.com",
      projectId: "interinos-ccss",
      storageBucket: "interinos-ccss.firebasestorage.app",
      messagingSenderId: "1098694984589",
      appId: "1:1098694984589:web:180af36da33ff6a161b3c4"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Verificar sesión
    const usuario = JSON.parse(localStorage.getItem("usuarioActivo"));
    if (!usuario) {
      window.location.href = "login.html";
    } else {
      // Mostrar información del usuario activo
      document.getElementById("nombreUsuario").textContent = usuario.nombre || "Usuario";
      document.getElementById("rolUsuario").textContent = usuario.rol || "Usuario";
    }

    // Variables globales
    let documentoActual = null;
    let filaActual = null;
    let datosOriginales = null;
    let documentoDetalleActual = null;
    let diasSeleccionados = new Set();

    // 🔹 Extrae mes y año directamente del string YYYY-MM-DD (evita zona horaria)
    function extraerMesYAnioDeFechaString(fechaStr) {
      if (!fechaStr || !/^\d{4}-\d{2}-\d{2}$/.test(fechaStr)) {
        console.warn("Formato de fecha inválido:", fechaStr);
        return null;
      }
      const [anio, mes] = fechaStr.split("-").map(Number);
      return { mes, anio };
    }

 // 🔹 Cargar registros con filtro desde Firestore (FILTRANDO POR USUARIO ACTIVO)
async function cargarRegistros() {
  const mesSeleccionado = document.getElementById("mes")?.value;
  const anioSeleccionado = parseInt(document.getElementById("anio")?.value);
  const tbody = document.getElementById("tablaRegistros");
  const mensaje = document.getElementById("mensajeSinDatos");
  const tabla = document.getElementById("tablaNombramientos");
  const mensajeError = document.getElementById("mensajeError");

  // Ocultar mensajes previos
  mensajeError.style.display = "none";
  mensaje.style.display = "none";

  // ✅ Validar que año sea un número válido
  if (isNaN(anioSeleccionado)) {
    tbody.innerHTML = `<tr><td colspan="12" style="color:red;">⚠️ Por favor, seleccione un año válido.</td></tr>`;
    tabla.style.display = "table";
    return;
  }

  console.log("🔍 Filtrando por Mes:", mesSeleccionado, "Año:", anioSeleccionado, "Usuario:", usuario.cedula);

  // Mostrar estado de carga
  tbody.innerHTML = `<tr><td colspan="12" class="cargando">Cargando datos...</td></tr>`;
  tabla.style.display = "table";

  try {
    // Obtener documentos de la colección "nombramientos" filtrados por usuarioCedula
    const nombramientosRef = collection(db, "nombramientos");
    
    // Crear query que filtre por usuarioCedula del usuario activo
    const q = query(nombramientosRef, where("usuarioCedula", "==", usuario.cedula));
    const querySnapshot = await getDocs(q);

    // Array para almacenar registros filtrados
    const registrosFiltrados = [];

    // Procesar cada documento
querySnapshot.forEach((docSnapshot) => {
  const r = docSnapshot.data();
  
  // 🔹 Validación robusta: verificar que el documento tenga datos válidos
  if (!r || typeof r !== 'object' || Array.isArray(r)) {
    console.warn("📄 Documento inválido (sin datos, no es objeto, o es array):", docSnapshot.id);
    return;
  }
  
  // Verificar que el documento tenga la fecha de inicio
  if (!r.inicio) {
    console.warn("📄 Documento sin campo 'inicio':", docSnapshot.id);
    return;
  }

  // Extraer mes y año de la fecha de inicio
  const fecha = extraerMesYAnioDeFechaString(r.inicio);
  if (!fecha) {
    console.warn("📄 Fecha inválida:", r.inicio, "en documento", docSnapshot.id);
    return;
  }

  // Filtrar por año seleccionado
  if (fecha.anio !== anioSeleccionado) {
    return;
  }

  // Si se seleccionó un mes específico, filtrar también por mes
  if (mesSeleccionado !== "" && fecha.mes !== parseInt(mesSeleccionado)) {
    return;
  }

  // 🔹 Validación adicional: asegurar que los campos críticos existan
  // Esto previene errores al renderizar la tabla
  const camposCriticos = ['personaSustituirNombre', 'personaSustituirCedula', 'area', 'codArea', 'inicio', 'dias', 'salario', 'estado'];
  const faltanCampos = camposCriticos.filter(campo => r[campo] === undefined);
  
  if (faltanCampos.length > 0) {
    console.warn(`📄 Documento incompleto, faltan campos: ${faltanCampos.join(', ')}`, docSnapshot.id);
    // Podemos seguir procesando el documento, pero usaremos valores por defecto al renderizar
  }

  // Agregar a registros filtrados - asegurando que data sea el objeto r
  registrosFiltrados.push({
    id: docSnapshot.id,
    data: r  // ← Usar 'data' explícitamente en lugar de spread
  });
});

    // 🔥 ORDENAR por fecha de inicio (ascendente: más antiguo primero) - versión segura
    registrosFiltrados.sort((a, b) => {
      // Verificar que ambos registros tengan datos y campo 'inicio'
      const inicioA = a.data?.inicio;
      const inicioB = b.data?.inicio;
      
      // Si alguno no tiene fecha de inicio, colocarlo al final
      if (!inicioA && !inicioB) return 0;
      if (!inicioA) return 1; // a va después de b
      if (!inicioB) return -1; // b va después de a
      
      const fechaA = new Date(inicioA);
      const fechaB = new Date(inicioB);
      
      // Manejar fechas inválidas
      if (isNaN(fechaA.getTime()) && isNaN(fechaB.getTime())) return 0;
      if (isNaN(fechaA.getTime())) return 1;
      if (isNaN(fechaB.getTime())) return -1;
      
      return fechaA - fechaB;
    });

    // Renderizar los registros ordenados
tbody.innerHTML = "";
if (registrosFiltrados.length === 0) {
  tabla.style.display = "none";
  mensaje.style.display = "block";
  console.log("📭 No se encontraron datos para este filtro.");
} else {
  registrosFiltrados.forEach(registro => {
    // 🔹 Asegurar que registro.data exista
    if (!registro.data) {
      console.warn("📄 Registro sin datos:", registro.id);
      return;
    }
    
    const r = registro.data;
    
    // Formatear los datos para mostrar - con valores por defecto seguros
    const personaSustituirNombre = (r.personaSustituirNombre !== undefined) ? r.personaSustituirNombre : "SIN DATOS";
    const personaSustituirCedula = (r.personaSustituirCedula !== undefined) ? r.personaSustituirCedula : "N/A";
    const area = (r.area !== undefined) ? r.area : "N/A";
    const codArea = (r.codArea !== undefined) ? r.codArea : "N/A";
    const fechaFinal = (r.final !== undefined) ? r.final : "N/A";
    const horario = `${(r.horarioEntrada !== undefined) ? r.horarioEntrada : 'N/A'} - ${(r.horarioSalida !== undefined) ? r.horarioSalida : 'N/A'}`;
    const dias = (r.dias !== undefined) ? r.dias : 0;
    const salario = parseFloat((r.salario !== undefined) ? r.salario : 0).toLocaleString('es-CR', { minimumFractionDigits: 2 });
    const estado = (r.estado !== undefined) ? (r.estado ? "✅ Pagado" : "⏳ Pendiente") : "⏳ Pendiente";
    
    // ✅ NUEVO: Formatear días libres
    const diasLibres = (r.diasLibres !== undefined && Array.isArray(r.diasLibres)) ? r.diasLibres : [];
    const diasLibresTexto = diasLibres.length > 0 
      ? `${diasLibres.length} día${diasLibres.length !== 1 ? 's' : ''}`
      : "Ninguno";

    // Crear la fila de la tabla
    const fila = document.createElement('tr');
    fila.dataset.id = registro.id;
    fila.innerHTML = `
      <td>${personaSustituirCedula}</td>
      <td>${personaSustituirNombre}</td>
      <td>${area}</td>
      <td>${codArea}</td>
      <td>${r.inicio}</td>
      <td>${fechaFinal}</td>
      <td>${horario}</td>
      <td>${dias}</td>
      <td>₡${salario}</td>
      <td>${estado}</td>
      <td class="dias-libres-info" title="${diasLibres.length > 0 ? 'Fechas: ' + diasLibres.join(', ') : ''}">${diasLibresTexto}</td>
      <td class="acciones">
        <button class="btn-detalle" onclick='abrirDetalle("${registro.id}", JSON.parse(decodeURIComponent("${encodeURIComponent(JSON.stringify(r))}")))'>📋 Detalles</button>
        <button class="btn-editar" onclick="iniciarEdicion('${registro.id}', this)">✏️ Editar</button>
        <button class="btn-guardar" onclick="guardarCambios('${registro.id}', this)">💾 Guardar</button>
        <button class="btn-cancelar" onclick="cancelarEdicion('${registro.id}', this)">❌ Cancelar</button>
      </td>
    `;
    tbody.appendChild(fila);
  });
  console.log(`✅ Se cargaron y ordenaron ${registrosFiltrados.length} registros.`);
}
  } catch (error) {
    console.error("❌ Error al cargar registros de Firestore:", error);
    mensajeError.textContent = "Error al cargar datos: " + error.message;
    mensajeError.style.display = "block";
    tbody.innerHTML = `<tr><td colspan="12" style="color:red;">Error al cargar datos de la base de datos. Por favor, intente nuevamente.</td></tr>`;
  }
}

    // 🔹 Iniciar edición de un registro
    window.iniciarEdicion = function(docId, boton) {
      const fila = boton.closest('tr');
      filaActual = fila;
      documentoActual = docId;
      
      // Guardar valores originales
      const celdas = fila.querySelectorAll('td');
      datosOriginales = {
        personaSustituirCedula: celdas[0].textContent,
        personaSustituirNombre: celdas[1].textContent,
        area: celdas[2].textContent,
        codArea: celdas[3].textContent,
        inicio: celdas[4].textContent,
        final: celdas[5].textContent,
        horario: celdas[6].textContent,
        dias: celdas[7].textContent,
        salario: celdas[8].textContent.replace(/[^\d.,-]/g, '').replace(',', '.'),
        estado: celdas[9].textContent.includes('✅')
      };
      
      // Cambiar los botones
      const btnEditar = fila.querySelector('.btn-editar');
      const btnGuardar = fila.querySelector('.btn-guardar');
      const btnCancelar = fila.querySelector('.btn-cancelar');
      
      btnEditar.style.display = 'none';
      btnGuardar.style.display = 'inline-block';
      btnCancelar.style.display = 'inline-block';
      
      // Convertir celdas en campos editables
      hacerEditable(celdas[0], 'personaSustituirCedula'); 
      hacerEditable(celdas[1], 'personaSustituirNombre');
      hacerEditable(celdas[2], 'area');
      hacerEditable(celdas[3], 'codArea');
      hacerEditableFecha(celdas[4], 'inicio');
      hacerEditableFecha(celdas[5], 'final');
      hacerEditableHorario(celdas[6]);
      hacerEditableNumero(celdas[7], 'dias');
      hacerEditableNumero(celdas[8], 'salario', true);
      hacerEditableEstado(celdas[9], 'estado');
    };

    // 🔹 Hacer una celda editable como texto
    function hacerEditable(celda, campo) {
      const valor = celda.textContent;
      celda.innerHTML = `<input type="text" class="editable" value="${valor}" data-campo="${campo}">`;
    }

    // 🔹 Hacer una celda editable como fecha
    function hacerEditableFecha(celda, campo) {
      const valor = celda.textContent;
      celda.innerHTML = `<input type="date" class="editable" value="${valor === 'N/A' ? '' : valor}" data-campo="${campo}">`;
    }

    // 🔹 Hacer una celda editable como número (versión segura)
    function hacerEditableNumero(celda, campo, esMoneda = false) {
      let valor = celda.textContent;
      if (esMoneda) {
        // Eliminar símbolos de moneda, espacios, puntos de miles, y dejar solo dígitos y punto decimal
        valor = valor.replace(/[^\d,.-]/g, '') // Elimina todo excepto dígitos, comas, puntos, guiones
                     .replace(',', '.')        // Convertir coma decimal a punto
                     .replace(/\.(?=.*\.)/g, ''); // Eliminar puntos de miles (solo deja el último punto)
      }
      const valorNumerico = parseFloat(valor) || 0;
      celda.innerHTML = `<input type="number" class="editable" value="${valorNumerico}" data-campo="${campo}" step="${esMoneda ? '0.01' : '1'}">`;
    }

    // 🔹 Hacer una celda editable como estado (select)
    function hacerEditableEstado(celda, campo) {
      const esPagado = celda.textContent.includes('✅');
      celda.innerHTML = `
        <select class="editable" data-campo="${campo}">
          <option value="true" ${esPagado ? 'selected' : ''}>✅ Pagado</option>
          <option value="false" ${!esPagado ? 'selected' : ''}>⏳ Pendiente</option>
        </select>
      `;
    }

    // 🔹 Hacer una celda editable como horario (entrada y salida)
    function hacerEditableHorario(celda) {
      const texto = celda.textContent;
      let entrada = 'N/A', salida = 'N/A';
      
      if (texto !== 'N/A - N/A') {
        const partes = texto.split(' - ');
        if (partes.length === 2) {
          entrada = partes[0];
          salida = partes[1];
        }
      }
      
      celda.innerHTML = `
        <div style="display: flex; gap: 5px; justify-content: center;">
          <input type="time" class="editable" value="${entrada === 'N/A' ? '' : entrada}" data-campo="horarioEntrada" style="width: 70px;">
          <span>-</span>
          <input type="time" class="editable" value="${salida === 'N/A' ? '' : salida}" data-campo="horarioSalida" style="width: 70px;">
        </div>
      `;
    }

    // 🔹 Cancelar edición de un registro
    window.cancelarEdicion = function(docId, boton) {
      if (!filaActual || !datosOriginales) return;
      
      const celdas = filaActual.querySelectorAll('td');
      celdas[0].textContent = datosOriginales.personaSustituirCedula;
      celdas[1].textContent = datosOriginales.personaSustituirNombre;
      celdas[2].textContent = datosOriginales.area;
      celdas[3].textContent = datosOriginales.codArea;
      celdas[4].textContent = datosOriginales.inicio;
      celdas[5].textContent = datosOriginales.final;
      celdas[6].textContent = datosOriginales.horario;
      celdas[7].textContent = datosOriginales.dias;
      celdas[8].textContent = `₡${parseFloat(datosOriginales.salario).toLocaleString('es-CR', { minimumFractionDigits: 2 })}`;
      celdas[9].textContent = datosOriginales.estado ? "✅ Pagado" : "⏳ Pendiente";
      
      // Cambiar los botones
      const btnEditar = filaActual.querySelector('.btn-editar');
      const btnGuardar = filaActual.querySelector('.btn-guardar');
      const btnCancelar = filaActual.querySelector('.btn-cancelar');
      
      btnEditar.style.display = 'inline-block';
      btnGuardar.style.display = 'none';
      btnCancelar.style.display = 'none';
      
      // Limpiar variables
      documentoActual = null;
      filaActual = null;
      datosOriginales = null;
    };

    // 🔹 Guardar cambios de un registro
    window.guardarCambios = function(docId, boton) {
      const fila = boton.closest('tr');
      
      // Obtener los nuevos valores
      const celdas = fila.querySelectorAll('td');
      const nuevosValores = {};
      
      // Procesar cada celda editable
      for (let i = 0; i <= 9; i++) { // De la celda 0 a la 9 (excluyendo acciones)
        const celda = celdas[i];
        const inputs = celda.querySelectorAll('.editable');
        
        if (inputs.length > 0) {
          if (i === 6) { // Horario (entrada y salida)
            nuevosValores.horarioEntrada = inputs[0].value || "N/A";
            nuevosValores.horarioSalida = inputs[1].value || "N/A";
          } else {
            const input = inputs[0];
            let campo;
            
            // Asignar el campo correcto según la posición
            switch(i) {
              case 0: campo = 'personaSustituirCedula'; break;
              case 1: campo = 'personaSustituirNombre'; break;
              case 2: campo = 'area'; break;
              case 3: campo = 'codArea'; break;
              case 4: campo = 'inicio'; break;
              case 5: campo = 'final'; break;
              case 7: campo = 'dias'; break;
              case 8: campo = 'salario'; break;
              case 9: campo = 'estado'; break;
            }
            
            if (campo === 'estado') {
              nuevosValores[campo] = input.value === 'true';
            } else if (campo === 'dias' || campo === 'salario') {
              nuevosValores[campo] = parseFloat(input.value) || 0;
            } else {
              nuevosValores[campo] = input.value || "N/A";
            }
          }
        }
      }
      
      // Mostrar modal de confirmación
      const modal = document.getElementById('modalConfirmacion');
      const mensajeConfirmacion = document.getElementById('mensajeConfirmacion');
      mensajeConfirmacion.textContent = `¿Está seguro que desea guardar los cambios realizados al nombramiento de ${celdas[1].querySelector('.editable')?.value || 'N/A'}?`;
      modal.style.display = 'flex';
      
      // Manejar botones del modal
      const btnAceptar = document.getElementById('btnAceptar');
      const btnCancelarModal = document.getElementById('btnCancelarModal');
      
      // Función para guardar realmente los cambios
      const confirmarGuardado = async () => {
        try {
          // Actualizar en Firestore
          const docRef = doc(db, "nombramientos", docId);
          await updateDoc(docRef, nuevosValores);
          
          // Actualizar la vista
          celdas[0].textContent = nuevosValores.personaSustituirCedula || "N/A";
          celdas[1].textContent = nuevosValores.personaSustituirNombre || "N/A";
          celdas[2].textContent = nuevosValores.area || "N/A";
          celdas[3].textContent = nuevosValores.codArea || "N/A";
          celdas[4].textContent = nuevosValores.inicio || "N/A";
          celdas[5].textContent = nuevosValores.final || "N/A";
          celdas[6].textContent = `${nuevosValores.horarioEntrada || 'N/A'} - ${nuevosValores.horarioSalida || 'N/A'}`;
          celdas[7].textContent = nuevosValores.dias || 0;
          celdas[8].textContent = `₡${parseFloat(nuevosValores.salario || 0).toLocaleString('es-CR', { minimumFractionDigits: 2 })}`;
          celdas[9].textContent = nuevosValores.estado ? "✅ Pagado" : "⏳ Pendiente";
          
          // ✅ Actualizar también la columna de días libres (aunque no se edita aquí)
          const diasLibres = nuevosValores.diasLibres || (datosOriginales?.diasLibres || []);
          const diasLibresTexto = diasLibres.length > 0 
            ? `${diasLibres.length} día${diasLibres.length !== 1 ? 's' : ''}`
            : "Ninguno";
          celdas[10].textContent = diasLibresTexto;
          if (diasLibres.length > 0) {
            celdas[10].title = 'Fechas: ' + diasLibres.join(', ');
          } else {
            celdas[10].title = '';
          }
          
          // Cambiar los botones
          const btnEditar = fila.querySelector('.btn-editar');
          const btnGuardar = fila.querySelector('.btn-guardar');
          const btnCancelar = fila.querySelector('.btn-cancelar');
          
          btnEditar.style.display = 'inline-block';
          btnGuardar.style.display = 'none';
          btnCancelar.style.display = 'none';
          
          // Mostrar mensaje de éxito
          alert("✅ Cambios guardados correctamente");
          
          // Limpiar variables
          documentoActual = null;
          filaActual = null;
          datosOriginales = null;
          
        } catch (error) {
          console.error("Error al guardar cambios:", error);
          alert("❌ Error al guardar los cambios: " + error.message);
        }
        
        // Cerrar modal
        modal.style.display = 'none';
      };
      
      // Asignar eventos a los botones del modal
      btnAceptar.onclick = confirmarGuardado;
      btnCancelarModal.onclick = function() {
        modal.style.display = 'none';
      };
      
      // Cerrar modal al hacer clic fuera de él
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      };
    };

    // 🔹 Abrir modal de detalle
    window.abrirDetalle = function(docId, datos) {
      documentoDetalleActual = docId;
      
      // Mostrar información básica
      document.getElementById('detalleFuncionario').textContent = datos.personaSustituirNombre || 'SIN DATOS';
      document.getElementById('detallePeriodo').textContent = `${datos.inicio} - ${datos.final || 'N/A'}`;
      document.getElementById('detalleArea').textContent = datos.area || 'N/A';
      
      // Generar checkboxes para cada día del período
      generarDiasPeriodo(datos.inicio, datos.final);
      
      // Cargar datos existentes si los hay
      cargarDatosDetalle(datos);
      
      // Mostrar modal
      document.getElementById('modalDetalle').style.display = 'flex';
    };

    // 🔹 Generar checkboxes para cada día del período
    function generarDiasPeriodo(fechaInicio, fechaFinal) {
      const container = document.getElementById('diasContainer');
      const totalDiasElem = document.getElementById('totalDias');
      
      if (!fechaInicio || !fechaFinal) {
        container.innerHTML = '<p style="color: red;">Fechas inválidas</p>';
        totalDiasElem.textContent = '0';
        return;
      }
      
      const inicio = new Date(fechaInicio);
      const final = new Date(fechaFinal);
      const dias = [];
      
      // Generar todos los días del período
      let fechaActual = new Date(inicio);
      while (fechaActual <= final) {
        dias.push(new Date(fechaActual));
        fechaActual.setDate(fechaActual.getDate() + 1);
      }
      
      // Mostrar total de días
      totalDiasElem.textContent = dias.length;
      
      // Crear checkboxes
      container.innerHTML = '';
      dias.forEach(fecha => {
        const fechaStr = fecha.toISOString().split('T')[0];
        const diaSemana = fecha.toLocaleDateString('es-ES', { weekday: 'short' });
        const fechaFormateada = fecha.toLocaleDateString('es-ES');
        
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.gap = '8px';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `dia_${fechaStr}`;
        checkbox.value = fechaStr;
        checkbox.dataset.fecha = fechaStr;
        
        const label = document.createElement('label');
        label.htmlFor = `dia_${fechaStr}`;
        label.textContent = `${fechaFormateada} (${diaSemana})`;
        label.style.cursor = 'pointer';
        
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
        
        // Evento para manejar selección
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            diasSeleccionados.add(this.value);
          } else {
            diasSeleccionados.delete(this.value);
          }
        });
      });
    }

    // 🔹 Cargar datos existentes del detalle
    function cargarDatosDetalle(datos) {
      // Resetear selección
      diasSeleccionados.clear();
      document.querySelectorAll('#diasContainer input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
      });
      
      // Cargar días seleccionados existentes
      const diasLibres = datos.diasLibres || [];
      diasLibres.forEach(fecha => {
        const checkbox = document.querySelector(`#dia_${fecha}`);
        if (checkbox) {
          checkbox.checked = true;
          diasSeleccionados.add(fecha);
        }
      });
      
      // Cargar tipo de ausencia
      document.getElementById('tipoAusencia').value = datos.tipoAusencia || '';
      
      // Cargar comentario
      document.getElementById('comentarioAusencia').value = datos.comentarioAusencia || '';
    }

    // 🔹 Guardar detalles del nombramiento
    document.getElementById('btnGuardarDetalle').addEventListener('click', async function() {
      if (!documentoDetalleActual) return;
      
      const tipoAusencia = document.getElementById('tipoAusencia').value;
      const comentarioAusencia = document.getElementById('comentarioAusencia').value;
      
      // Validar que se haya seleccionado al menos un día si se eligió un tipo de ausencia
      if (tipoAusencia && diasSeleccionados.size === 0) {
        alert('⚠️ Debe seleccionar al menos un día si especifica un tipo de ausencia.');
        return;
      }
      
      try {
        // Preparar datos para guardar
        const datosDetalle = {
          diasLibres: Array.from(diasSeleccionados),
          tipoAusencia: tipoAusencia || null,
          comentarioAusencia: comentarioAusencia || null,
          ultimaActualizacionDetalle: new Date()
        };
        
        // Actualizar en Firestore
        const docRef = doc(db, "nombramientos", documentoDetalleActual);
        await updateDoc(docRef, datosDetalle);
        
        // ✅ Actualizar la vista en la tabla principal
        const fila = document.querySelector(`tr[data-id="${documentoDetalleActual}"]`);
        if (fila) {
          const celdaDiasLibres = fila.querySelectorAll('td')[10]; // Índice 10 = columna de días libres
          const diasLibresTexto = diasSeleccionados.size > 0 
            ? `${diasSeleccionados.size} día${diasSeleccionados.size !== 1 ? 's' : ''}`
            : "Ninguno";
          celdaDiasLibres.textContent = diasLibresTexto;
          celdaDiasLibres.title = diasSeleccionados.size > 0 
            ? 'Fechas: ' + Array.from(diasSeleccionados).join(', ') 
            : '';
        }
        
        alert('✅ Detalles guardados correctamente');
        document.getElementById('modalDetalle').style.display = 'none';
        
      } catch (error) {
        console.error('Error al guardar detalles:', error);
        alert('❌ Error al guardar los detalles: ' + error.message);
      }
    });

    // 🔹 Cerrar modal de detalle
    document.getElementById('btnCerrarDetalle').addEventListener('click', function() {
      document.getElementById('modalDetalle').style.display = 'none';
    });

    // Cerrar modal al hacer clic fuera
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('modalDetalle');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });

    // 🔹 Exportar tabla a PDF usando html2pdf
    function exportarPDF() {
      const element = document.getElementById('tablaNombramientos');
      const mes = document.getElementById("mes").options[document.getElementById("mes").selectedIndex].text;
      const anio = document.getElementById("anio").value;
      const usuarioInfo = document.getElementById('usuarioInfo').outerHTML;
      
      // Verificar si hay datos para exportar
      const filas = document.querySelectorAll("#tablaRegistros tr");
      if (filas.length <= 1 || filas[0].querySelector("td")?.textContent?.includes("Cargando") || filas[0].querySelector("td")?.textContent?.includes("No se encontraron")) {
        alert("No hay datos para exportar.");
        return;
      }

      // Crear un contenedor para el PDF
      const pdfContainer = document.createElement('div');
      pdfContainer.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          <h2 style="color: #0d47a1; font-size: 24px; margin-bottom: 10px;">Reporte de Nombramientos</h2>
          <p style="font-size: 16px; margin-bottom: 5px;">Filtrado por: ${mes} ${anio}</p>
          <p style="font-size: 10px;">Generado por: ${usuario.nombre || 'Usuario'}</p>
          <p style="font-size: 8px;">Fecha: ${new Date().toLocaleDateString('es-CR')}</p>
        </div>
        ${usuarioInfo}
      `;
      
      // Clonar la tabla
      const tablaClone = element.cloneNode(true);
      
      // Eliminar botones de acciones en el PDF
      const botonesAcciones = tablaClone.querySelectorAll('.acciones');
      botonesAcciones.forEach(btn => {
        btn.innerHTML = 'Reporte generado';
        btn.style.backgroundColor = '#e0e0e0';
        btn.style.color = '#666';
        btn.style.padding = '5px';
        btn.style.borderRadius = '3px';
        btn.style.textAlign = 'center';
      });
      
      pdfContainer.appendChild(tablaClone);

      const opt = {
        margin: [15, 10, 15, 10],
        filename: `nombramientos_${mes}_${anio}_${usuario.nombre || 'usuario'}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
      };

      // Generar el PDF
      html2pdf().set(opt).from(pdfContainer).save();
    }

    // 🔹 Mostrar resumen de días libres
    function mostrarResumenDiasLibres() {
      const modal = document.createElement('div');
      modal.id = 'modalResumenLibres';
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-contenido" style="max-width: 800px;">
          <h3 class="modal-titulo">📊 Resumen de Días Libres</h3>
          <div id="resumenLibresContenido" class="cargando">Cargando resumen...</div>
          <div class="modal-botones">
            <button id="btnCerrarResumen" class="btn-modal btn-cancelar-modal">Cerrar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Cargar datos
      cargarResumenDiasLibres();
      
      // Cerrar modal
      document.getElementById('btnCerrarResumen').onclick = () => {
        document.body.removeChild(modal);
      };
    }

    async function cargarResumenDiasLibres() {
      try {
        const mesSeleccionado = document.getElementById("mes")?.value;
        const anioSeleccionado = parseInt(document.getElementById("anio")?.value);
        
        if (isNaN(anioSeleccionado)) {
          document.getElementById('resumenLibresContenido').innerHTML = 
            '<p style="color: red;">❌ Seleccione un año válido para ver el resumen.</p>';
          return;
        }

        const nombramientosRef = collection(db, "nombramientos");
        const q = query(nombramientosRef, where("usuarioCedula", "==", usuario.cedula));
        const querySnapshot = await getDocs(q);
        
        // Si se seleccionaron filtros específicos, usar la lógica anterior
        if (mesSeleccionado !== "" || true) {
          let totalDiasLibres = 0;
          let registrosConLibres = [];
          
          querySnapshot.forEach(doc => {
            const data = doc.data();
            
            if (!data.inicio) return;
            const fechaNombramiento = extraerMesYAnioDeFechaString(data.inicio);
            if (!fechaNombramiento) return;
            
            // Verificar año
            if (fechaNombramiento.anio !== anioSeleccionado) return;
            
            // Verificar mes (si se seleccionó)
            if (mesSeleccionado !== "" && fechaNombramiento.mes !== parseInt(mesSeleccionado)) return;
            
            const diasLibres = data.diasLibres || [];
            if (diasLibres.length > 0) {
              // Filtrar días libres por el período seleccionado
              const diasLibresFiltrados = diasLibres.filter(fechaLibre => {
                const fechaLibreObj = extraerMesYAnioDeFechaString(fechaLibre);
                if (!fechaLibreObj) return false;
                if (fechaLibreObj.anio !== anioSeleccionado) return false;
                if (mesSeleccionado !== "" && fechaLibreObj.mes !== parseInt(mesSeleccionado)) return false;
                return true;
              });
              
              if (diasLibresFiltrados.length > 0) {
                totalDiasLibres += diasLibresFiltrados.length;
                registrosConLibres.push({
                  funcionario: data.personaSustituirNombre || 'SIN DATOS',
                  periodo: `${data.inicio} - ${data.final || 'N/A'}`,
                  dias: diasLibresFiltrados,
                  tipo: data.tipoAusencia || 'Sin tipo',
                  mes: fechaNombramiento.mes,
                  anio: fechaNombramiento.anio
                });
              }
            }
          });
          
          const contenido = document.getElementById('resumenLibresContenido');
          const mesTexto = mesSeleccionado ? 
            document.getElementById("mes").options[parseInt(mesSeleccionado)].text : 
            "Todos los meses";
          
          if (registrosConLibres.length === 0) {
            contenido.innerHTML = `
              <p style="text-align: center; color: #7f8c8d;">
                📭 No hay días libres registrados para ${mesTexto} ${anioSeleccionado}.
              </p>
            `;
          } else if (mesSeleccionado !== "") {
            // Mostrar resumen simple para un mes específico
            let html = `<p><strong>Días libres en ${mesTexto} ${anioSeleccionado}: ${totalDiasLibres}</strong></p>`;
            html += '<div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">';
            
            registrosConLibres.forEach(reg => {
              html += `
                <div style="border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                  <p><strong>Funcionario:</strong> ${reg.funcionario}</p>
                  <p><strong>Período:</strong> ${reg.periodo}</p>
                  <p><strong>Tipo:</strong> ${reg.tipo}</p>
                  <p><strong>Días libres (${reg.dias.length}):</strong> ${reg.dias.join(', ')}</p>
                </div>
              `;
            });
            
            html += '</div>';
            contenido.innerHTML = html;
          } else {
            // ✅ AGRUPAR POR MES cuando se seleccionan "Todos los meses"
            const registrosPorMes = {};
            
            // Agrupar registros por mes
            registrosConLibres.forEach(reg => {
              const claveMes = `${reg.anio}-${reg.mes}`;
              if (!registrosPorMes[claveMes]) {
                registrosPorMes[claveMes] = {
                  mes: reg.mes,
                  anio: reg.anio,
                  registros: [],
                  totalDias: 0
                };
              }
              registrosPorMes[claveMes].registros.push(reg);
              registrosPorMes[claveMes].totalDias += reg.dias.length;
            });
            
            // Ordenar por mes y año (ascendente)
            const mesesOrdenados = Object.keys(registrosPorMes)
              .map(clave => registrosPorMes[clave])
              .sort((a, b) => {
                if (a.anio !== b.anio) return a.anio - b.anio;
                return a.mes - b.mes;
              });
            
            let html = `<p><strong>Resumen de días libres en ${anioSeleccionado} (todos los meses):</strong></p>`;
            html += '<div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">';
            
            mesesOrdenados.forEach(mesData => {
              const nombreMes = document.getElementById("mes").options[mesData.mes]?.text || `Mes ${mesData.mes}`;
              html += `
                <div style="border: 2px solid #3498db; padding: 15px; margin-bottom: 20px; border-radius: 8px; background-color: #f8f9fa;">
                  <h4 style="color: #2980b9; margin-bottom: 15px;">
                    📅 ${nombreMes} ${mesData.anio} 
                    <span style="float: right; background: #2980b9; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">
                      ${mesData.totalDias} día${mesData.totalDias !== 1 ? 's' : ''}
                    </span>
                  </h4>
              `;
              
              mesData.registros.forEach(reg => {
                html += `
                  <div style="border: 1px solid #ddd; padding: 12px; margin-bottom: 10px; border-radius: 6px; background-color: white;">
                    <p><strong>Funcionario:</strong> ${reg.funcionario}</p>
                    <p><strong>Período:</strong> ${reg.periodo}</p>
                    <p><strong>Tipo:</strong> ${reg.tipo}</p>
                    <p><strong>Días libres (${reg.dias.length}):</strong> ${reg.dias.join(', ')}</p>
                  </div>
                `;
              });
              
              html += '</div>';
            });
            
            html += '</div>';
            contenido.innerHTML = html;
          }
        }
        
      } catch (error) {
        console.error('Error al cargar resumen:', error);
        document.getElementById('resumenLibresContenido').innerHTML = 
          '<p style="color: red;">❌ Error al cargar el resumen: ' + error.message + '</p>';
      }
    }

    // ✅ Inicialización segura al cargar la página
    document.addEventListener("DOMContentLoaded", () => {
      const hoy = new Date();
      const mesSelect = document.getElementById("mes");
      const anioSelect = document.getElementById("anio");

      // Establecer mes actual por defecto
      if (mesSelect) mesSelect.value = hoy.getMonth() + 1;

      // Llenar el select de años desde 2020 hasta 2025
      if (anioSelect) {
        anioSelect.innerHTML = "";
        for (let year = 2020; year <= 2025; year++) {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          anioSelect.appendChild(option);
        }
        anioSelect.value = hoy.getFullYear();
      }

      // Cargar datos iniciales después de un breve retraso
      setTimeout(() => {
        cargarRegistros();
      }, 500);
    });

    // ✅ Asignar eventos a botones y filtros automáticos
    document.addEventListener("DOMContentLoaded", () => {
      const btnFiltrar = document.getElementById("btnFiltrar");
      const btnExportarPDF = document.getElementById("btnExportarPDF");
      const btnVerDiasLibres = document.getElementById("btnVerDiasLibres");
      const selectMes = document.getElementById("mes");
      const selectAnio = document.getElementById("anio");

      if (btnFiltrar) {
        btnFiltrar.addEventListener("click", cargarRegistros);
      }

      if (btnExportarPDF) {
        btnExportarPDF.addEventListener("click", exportarPDF);
      }

      if (btnVerDiasLibres) {
        btnVerDiasLibres.addEventListener("click", mostrarResumenDiasLibres);
      }

      if (selectMes) {
        selectMes.addEventListener("change", cargarRegistros);
      }

      if (selectAnio) {
        selectAnio.addEventListener("change", cargarRegistros);
      }

      console.log("✅ Todos los eventos y auto-filtros asignados correctamente.");
    });
  </script>
</body>
</html>