<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consultas de Nombramientos (Corregido)</title>
  <style>
    /* (mantuve el mismo estilo del archivo original para no cambiar la UI) */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f5f7fa; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h2 { text-align: center; margin-bottom: 25px; color: #2c3e50; }
    .usuario-info { background-color: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .filtros { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: end; }
    .filtros > div { display: flex; flex-direction: column; gap: 5px; }
    .filtros label { font-weight: 600; color: #34495e; }
    .filtros select, .filtros button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    .filtros button { background-color: #3498db; color: white; cursor: pointer; font-weight: 600; }
    .filtros button:hover { background-color: #2980b9; }
    #btnExportarPDF { background-color: #27ae60; }
    #btnExportarPDF:hover { background-color: #219653; }
    .tabla-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background-color: #f8f9fa; color: #2c3e50; font-weight: 600; }
    tr:hover { background-color: #f8f9fa; }
    .acciones { display: flex; gap: 5px; flex-wrap: wrap; }
    .btn-detalle, .btn-editar, .btn-guardar, .btn-cancelar { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; }
    .btn-detalle { background-color: #9b59b6; color: white; }
    .btn-detalle:hover { background-color: #8e44ad; }
    .btn-editar { background-color: #3498db; color: white; }
    .btn-editar:hover { background-color: #2980b9; }
    .btn-guardar { background-color: #27ae60; color: white; display: none; }
    .btn-guardar:hover { background-color: #219653; }
    .btn-cancelar { background-color: #e74c3c; color: white; display: none; }
    .btn-cancelar:hover { background-color: #c0392b; }
    .cargando, .sin-datos, .error { text-align: center; padding: 20px; font-style: italic; }
    .error { color: #e74c3c; }
    .sin-datos { color: #7f8c8d; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-contenido { background-color: white; margin: 5% auto; padding: 25px; border-radius: 12px; max-width: 600px; width: 90%; position: relative; }
    .modal-titulo { margin-bottom: 20px; color: #2c3e50; text-align: center; }
    .modal-botones { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
    .btn-modal { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 600; }
    .btn-aceptar { background-color: #27ae60; color: white; }
    .btn-aceptar:hover { background-color: #219653; }
    .btn-cancelar-modal { background-color: #95a5a6; color: white; }
    .btn-cancelar-modal:hover { background-color: #7f8c8d; }
    .detalle-info { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .detalle-info p { margin: 8px 0; }
    .dias-seleccion h4 { margin-bottom: 15px; color: #34495e; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #34495e; }
    .form-control, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    textarea { resize: vertical; min-height: 80px; }
    .btn-flotante-inicio { position: fixed; bottom: 20px; right: 20px; background-color: #3498db; color: white; padding: 12px 20px; border-radius: 50px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 100; }
    .btn-flotante-inicio:hover { background-color: #2980b9; transform: scale(1.05); transition: transform 0.2s; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Consultas de Nombramientos</h2>

    <div class="usuario-info" id="usuarioInfo">
      <h3>Usuario Activo: <span id="nombreUsuario">Cargando...</span></h3>
      <p>Rol: <span id="rolUsuario">Administrador</span></p>
    </div>

    <div class="filtros">
      <div>
        <label for="mes">Mes:</label>
        <select id="mes">
          <option value="">Todos los meses</option>
          <option value="1">Enero</option>
          <option value="2">Febrero</option>
          <option value="3">Marzo</option>
          <option value="4">Abril</option>
          <option value="5">Mayo</option>
          <option value="6">Junio</option>
          <option value="7">Julio</option>
          <option value="8">Agosto</option>
          <option value="9">Septiembre</option>
          <option value="10">Octubre</option>
          <option value="11">Noviembre</option>
          <option value="12">Diciembre</option>
        </select>
      </div>

      <div>
        <label for="anio">A√±o:</label>
        <select id="anio"></select>
      </div>

      <button id="btnFiltrar">Filtrar</button>
      <button id="btnExportarPDF">üìÑ Exportar PDF</button>
    </div>

    <div class="tabla-container">
      <div id="mensajeError" class="error" style="display:none;"></div>
      <table id="tablaNombramientos">
        <thead>
          <tr>
            <th>C√©dula Sustituido</th>
            <th>Funcionario Sustituido</th>
            <th>√Årea</th>
            <th>C√≥digo √Årea</th>
            <th>Inicio</th>
            <th>Final</th>
            <th>Horario</th>
            <th>D√≠as</th>
            <th>Salario</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaRegistros">
          <tr><td colspan="11" class="cargando">Cargando datos del mes actual...</td></tr>
        </tbody>
      </table>
      <div id="mensajeSinDatos" class="sin-datos" style="display:none;">üì≠ No se encontraron nombramientos para este mes y a√±o.</div>
    </div>

    <!-- Modal Confirmacion -->
    <div id="modalConfirmacion" class="modal">
      <div class="modal-contenido">
        <h3 class="modal-titulo">Confirmar Cambios</h3>
        <p id="mensajeConfirmacion">¬øEst√° seguro que desea guardar los cambios realizados?</p>
        <div class="modal-botones">
          <button id="btnAceptar" class="btn-modal btn-aceptar">Aceptar</button>
          <button id="btnCancelarModal" class="btn-modal btn-cancelar-modal">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal Detalle -->
    <div id="modalDetalle" class="modal">
      <div class="modal-contenido" style="max-width: 800px; width: 90%;">
        <h3 class="modal-titulo">Detalles del Nombramiento</h3>
        <div class="detalle-info">
          <p><strong>Funcionario:</strong> <span id="detalleFuncionario"></span></p>
          <p><strong>Per√≠odo:</strong> <span id="detallePeriodo"></span></p>
          <p><strong>√Årea:</strong> <span id="detalleArea"></span></p>
        </div>

        <div class="dias-seleccion">
          <h4>D√≠as del per√≠odo (<span id="totalDias"></span> d√≠as totales)</h4>
          <div id="diasContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin: 15px 0;"></div>
        </div>

        <div class="form-group">
          <label for="tipoAusencia">Tipo de Ausencia:</label>
          <select id="tipoAusencia" class="form-control">
            <option value="">-- Seleccione tipo --</option>
            <option value="libre1">Libre 1</option>
            <option value="libre2">Libre 2</option>
            <option value="libre3">Libre 3</option>
            <option value="vacaciones">Vacaciones</option>
            <option value="incapacidad">Incapacidad</option>
            <option value="licencia">Licencia</option>
          </select>
        </div>

        <div class="form-group">
          <label for="comentarioAusencia">Comentario:</label>
          <textarea id="comentarioAusencia" placeholder="Comentario adicional sobre la ausencia..."></textarea>
        </div>

        <div class="modal-botones">
          <button id="btnGuardarDetalle" class="btn-modal btn-aceptar">üíæ Guardar Detalles</button>
          <button id="btnCerrarDetalle" class="btn-modal btn-cancelar-modal">Cerrar</button>
        </div>
      </div>
    </div>

    <a href="dashboard.html" class="btn-flotante-inicio" title="Ir al Dashboard">üè† Inicio</a>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // Config Firebase (igual que el original)
    const firebaseConfig = {
      apiKey: "AIzaSyDigm9JWEqr5h0YV3H6a-H3ub4N__2Y2q4",
      authDomain: "interinos-ccss.firebaseapp.com",
      projectId: "interinos-ccss",
      storageBucket: "interinos-ccss.firebasestorage.app",
      messagingSenderId: "1098694984589",
      appId: "1:1098694984589:web:180af36da33ff6a161b3c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Verificar sesi√≥n
    const usuario = JSON.parse(localStorage.getItem("usuarioActivo"));
    if (!usuario) {
      window.location.href = "login.html";
    } else {
      document.getElementById("nombreUsuario").textContent = usuario.nombre || "Usuario";
      document.getElementById("rolUsuario").textContent = usuario.rol || "Usuario";
    }

    // Variables globales
    let documentoActual = null;
    let filaActual = null;
    let datosOriginales = null;
    let documentoDetalleActual = null;
    let diasSeleccionados = new Set();

    /***** Helpers robustos para fechas y timestamps *****/
    function isFirestoreTimestamp(v) {
      return v && typeof v.toDate === 'function';
    }

    // Parsear sin efectos de zona horaria cuando se recibe YYYY-MM-DD
    function parseDateNoTZ(val) {
      if (!val) return null;
      if (isFirestoreTimestamp(val)) return val.toDate();
      if (val instanceof Date) return val;
      if (typeof val === 'string') {
        if (/^\d{4}-\d{2}-\d{2}$/.test(val)) {
          const [y,m,d] = val.split('-').map(Number);
          return new Date(y, m-1, d);
        }
        const tryDate = new Date(val);
        if (!isNaN(tryDate)) return tryDate;
      }
      return null;
    }

    function toDateObject(val) {
      return parseDateNoTZ(val);
    }

    function formatDateForDisplay(val) {
      const d = toDateObject(val);
      if (!d || isNaN(d)) return 'N/A';
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function calcularDiasInclusivos(inicioVal, finalVal) {
      const inicio = toDateObject(inicioVal);
      const fin = toDateObject(finalVal);
      if (!inicio || !fin || isNaN(inicio) || isNaN(fin) || fin < inicio) return 0;
      const diff = Math.floor((fin - inicio) / (1000 * 60 * 60 * 24)) + 1;
      return diff;
    }

    /***** FIN helpers *****/

    // Extrae mes y a√±o de una fecha (acepta strings, timestamp, Date)
    function extraerMesYAnioDeFechaString(fecha) {
      const d = toDateObject(fecha);
      if (!d || isNaN(d)) return null;
      return { mes: d.getMonth() + 1, anio: d.getFullYear() };
    }

    // Cargar registros desde Firestore con correcciones
    async function cargarRegistros() {
      const mesSeleccionado = document.getElementById("mes")?.value;
      const anioSeleccionado = parseInt(document.getElementById("anio")?.value);
      const tbody = document.getElementById("tablaRegistros");
      const mensaje = document.getElementById("mensajeSinDatos");
      const tabla = document.getElementById("tablaNombramientos");
      const mensajeError = document.getElementById("mensajeError");

      mensajeError.style.display = "none";
      mensaje.style.display = "none";

      if (isNaN(anioSeleccionado)) {
        tbody.innerHTML = `<tr><td colspan="11" style="color:red;">‚ö†Ô∏è Por favor, seleccione un a√±o v√°lido.</td></tr>`;
        tabla.style.display = "table";
        return;
      }

      tbody.innerHTML = `<tr><td colspan="11" class="cargando">Cargando datos...</td></tr>`;
      tabla.style.display = "table";

      try {
        const nombramientosRef = collection(db, "nombramientos");
        const q = query(nombramientosRef, where("usuarioCedula", "==", usuario.cedula));
        const querySnapshot = await getDocs(q);

        const registrosFiltrados = [];

        querySnapshot.forEach((docSnapshot) => {
          const rRaw = docSnapshot.data();

          // Asegurarnos de tener campo 'inicio'
          if (!rRaw || !rRaw.inicio) {
            console.warn("Documento sin campo 'inicio':", docSnapshot.id);
            return;
          }

          const fecha = extraerMesYAnioDeFechaString(rRaw.inicio);
          if (!fecha) {
            console.warn("Fecha inv√°lida:", rRaw.inicio, "en documento", docSnapshot.id);
            return;
          }

          if (fecha.anio !== anioSeleccionado) return;
          if (mesSeleccionado !== "" && fecha.mes !== parseInt(mesSeleccionado)) return;

          // Normalizar fechas a formato YYYY-MM-DD para mostrar y manipular sin TZ
          const normalized = { ...rRaw };
          normalized.inicio = formatDateForDisplay(rRaw.inicio);
          normalized.final = formatDateForDisplay(rRaw.final);

          registrosFiltrados.push({ id: docSnapshot.id, data: normalized, raw: rRaw });
        });

        // Ordenar por fecha de inicio (usar parseDateNoTZ para evitar problemas de TZ)
        registrosFiltrados.sort((a, b) => {
          const da = parseDateNoTZ(a.data.inicio) || new Date(0);
          const db = parseDateNoTZ(b.data.inicio) || new Date(0);
          return da - db;
        });

        // Renderizar filas (crear elementos DOM en vez de innerHTML con JSON.stringify)
        tbody.innerHTML = "";
        if (registrosFiltrados.length === 0) {
          tabla.style.display = "none";
          mensaje.style.display = "block";
          console.log("üì≠ No se encontraron datos para este filtro.");
        } else {
          registrosFiltrados.forEach((registro) => {
            const r = registro.data;
            const tr = document.createElement('tr');
            tr.dataset.id = registro.id;

            // Helper para formatear salario
            const salarioNum = parseFloat(registro.raw && registro.raw.salario ? registro.raw.salario : (r.salario || 0)) || 0;
            const salarioStr = salarioNum.toLocaleString('es-CR', { minimumFractionDigits: 2 });

            const estado = (registro.raw && typeof registro.raw.estado !== 'undefined') ? (registro.raw.estado ? "‚úÖ Pagado" : "‚è≥ Pendiente") : (r.estado ? "‚úÖ Pagado" : "‚è≥ Pendiente");

            // Crear celdas
            const campos = [
              r.personaSustituirCedula || 'N/A',
              r.personaSustituirNombre || 'SIN DATOS',
              r.area || 'N/A',
              r.codArea || 'N/A',
              r.inicio || 'N/A',
              r.final || 'N/A',
              `${r.horarioEntrada || 'N/A'} - ${r.horarioSalida || 'N/A'}`,
              r.dias || 0,
              `‚Ç°${salarioStr}`,
              estado
            ];

            campos.forEach((valor) => {
              const td = document.createElement('td');
              td.textContent = valor;
              tr.appendChild(td);
            });

            // Acciones: botones creados por addEventListener (no JSON.stringify)
            const tdAcc = document.createElement('td');
            tdAcc.className = 'acciones';

            const btnDetalle = document.createElement('button');
            btnDetalle.className = 'btn-detalle';
            btnDetalle.textContent = 'üìã Detalles';
            btnDetalle.addEventListener('click', () => abrirDetalle(registro.id, registro.data));

            const btnEditar = document.createElement('button');
            btnEditar.className = 'btn-editar';
            btnEditar.textContent = '‚úèÔ∏è Editar';
            btnEditar.addEventListener('click', () => iniciarEdicion(registro.id, btnEditar));

            const btnGuardar = document.createElement('button');
            btnGuardar.className = 'btn-guardar';
            btnGuardar.textContent = 'üíæ Guardar';
            btnGuardar.style.display = 'none';
            btnGuardar.addEventListener('click', () => guardarCambios(registro.id, btnGuardar));

            const btnCancelar = document.createElement('button');
            btnCancelar.className = 'btn-cancelar';
            btnCancelar.textContent = '‚ùå Cancelar';
            btnCancelar.style.display = 'none';
            btnCancelar.addEventListener('click', () => cancelarEdicion(registro.id, btnCancelar));

            tdAcc.appendChild(btnDetalle);
            tdAcc.appendChild(btnEditar);
            tdAcc.appendChild(btnGuardar);
            tdAcc.appendChild(btnCancelar);

            tr.appendChild(tdAcc);
            tbody.appendChild(tr);
          });

          console.log(`‚úÖ Se cargaron y ordenaron ${registrosFiltrados.length} registros.`);
        }
      } catch (error) {
        console.error("‚ùå Error al cargar registros de Firestore:", error);
        mensajeError.textContent = "Error al cargar datos: " + error.message;
        mensajeError.style.display = "block";
        tbody.innerHTML = `<tr><td colspan="11" style="color:red;">Error al cargar datos de la base de datos. Por favor, intente nuevamente.</td></tr>`;
      }
    }

    // Iniciar edici√≥n: hace celdas editables y guarda valores originales (num√©ricos correctamente)
    window.iniciarEdicion = function(docId, boton) {
      const fila = boton.closest('tr');
      filaActual = fila;
      documentoActual = docId;

      const celdas = fila.querySelectorAll('td');
      datosOriginales = {
        personaSustituirCedula: celdas[0].textContent,
        personaSustituirNombre: celdas[1].textContent,
        area: celdas[2].textContent,
        codArea: celdas[3].textContent,
        inicio: celdas[4].textContent,
        final: celdas[5].textContent,
        horario: celdas[6].textContent,
        dias: parseInt(celdas[7].textContent) || 0,
        salario: parseFloat(celdas[8].textContent.replace('‚Ç°', '').replace(/\./g, '').replace(',', '.')) || 0,
        estado: celdas[9].textContent.includes('‚úÖ')
      };

      // Cambiar visibilidad de botones
      const btnEditar = fila.querySelector('.btn-editar');
      const btnGuardar = fila.querySelector('.btn-guardar');
      const btnCancelar = fila.querySelector('.btn-cancelar');
      btnEditar.style.display = 'none';
      btnGuardar.style.display = 'inline-block';
      btnCancelar.style.display = 'inline-block';

      // Crear campos editables
      hacerEditable(celdas[0], 'personaSustituirCedula');
      hacerEditable(celdas[1], 'personaSustituirNombre');
      hacerEditable(celdas[2], 'area');
      hacerEditable(celdas[3], 'codArea');
      hacerEditableFecha(celdas[4], 'inicio');
      hacerEditableFecha(celdas[5], 'final');
      hacerEditableHorario(celdas[6]);
      hacerEditableNumero(celdas[7], 'dias');
      hacerEditableNumero(celdas[8], 'salario', true);
      hacerEditableEstado(celdas[9], 'estado');
    };

    function hacerEditable(celda, campo) {
      const valor = celda.textContent;
      celda.innerHTML = `<input type="text" class="editable" value="${valor}" data-campo="${campo}">`;
    }

    function hacerEditableFecha(celda, campo) {
      const valor = celda.textContent;
      const dateVal = (valor === 'N/A') ? '' : formatDateForDisplay(valor);
      celda.innerHTML = `<input type="date" class="editable" value="${dateVal}" data-campo="${campo}">`;

      // Agregar listener para recalcular d√≠as y salario en la fila cuando cambien las fechas
      const input = celda.querySelector('input');
      input.addEventListener('change', () => {
        const fila = celda.closest('tr');
        actualizarDiasYSalarioEnFila(fila);
      });
    }

    function hacerEditableNumero(celda, campo, esMoneda = false) {
      let valor = celda.textContent;
      if (esMoneda) {
        valor = valor.replace('‚Ç°', '').replace(/\./g, '').replace(',', '.').trim();
      }
      celda.innerHTML = `<input type="number" class="editable" value="${valor}" data-campo="${campo}" step="${esMoneda ? '0.01' : '1'}">`;
    }

    function hacerEditableEstado(celda, campo) {
      const esPagado = celda.textContent.includes('‚úÖ');
      celda.innerHTML = `\n        <select class="editable" data-campo="${campo}">\n          <option value="true" ${esPagado ? 'selected' : ''}>‚úÖ Pagado</option>\n          <option value="false" ${!esPagado ? 'selected' : ''}>‚è≥ Pendiente</option>\n        </select>\n      `;
    }

    function hacerEditableHorario(celda) {
      const texto = celda.textContent;
      let entrada = 'N/A', salida = 'N/A';
      if (texto !== 'N/A - N/A') {
        const partes = texto.split(' - ');
        if (partes.length === 2) { entrada = partes[0]; salida = partes[1]; }
      }
      celda.innerHTML = `\n        <div style="display: flex; gap: 5px; justify-content: center;">\n          <input type="time" class="editable" value="${entrada === 'N/A' ? '' : entrada}" data-campo="horarioEntrada" style="width: 70px;">\n          <span>-</span>\n          <input type="time" class="editable" value="${salida === 'N/A' ? '' : salida}" data-campo="horarioSalida" style="width: 70px;">\n        </div>\n      `;
    }

    // Recalcula d√≠as y salario (si puede) cuando cambian las fechas en una fila en edici√≥n
    function actualizarDiasYSalarioEnFila(fila) {
      if (!fila) return;
      const inicioInput = fila.querySelector('input[data-campo="inicio"]');
      const finalInput = fila.querySelector('input[data-campo="final"]');
      const diasInput = fila.querySelector('input[data-campo="dias"]');
      const salarioInput = fila.querySelector('input[data-campo="salario"]');

      if (!inicioInput || !finalInput) return;

      const inicioVal = inicioInput.value;
      const finalVal = finalInput.value;
      const nuevosDias = calcularDiasInclusivos(inicioVal, finalVal);

      if (diasInput) diasInput.value = nuevosDias;
      else {
        // Si no hay input, actualizar texto de la celda 7
        const celdas = fila.querySelectorAll('td');
        celdas[7].textContent = nuevosDias;
      }

      // Calcular salario nuevo basado en tarifa diaria original si existe
      let tarifaDiaria = null;
      if (datosOriginales && Number(datosOriginales.dias) > 0) {
        tarifaDiaria = Number(datosOriginales.salario || 0) / Number(datosOriginales.dias || 1);
      } else if (salarioInput && Number(diasInput?.value) > 0) {
        tarifaDiaria = Number(salarioInput.value || 0) / Number(diasInput.value || 1);
      }

      if (tarifaDiaria !== null && salarioInput) {
        const nuevoSal = (tarifaDiaria * nuevosDias).toFixed(2);
        salarioInput.value = nuevoSal;
      } else if (tarifaDiaria !== null) {
        const celdas = fila.querySelectorAll('td');
        celdas[8].textContent = `‚Ç°${(tarifaDiaria * nuevosDias).toLocaleString('es-CR', { minimumFractionDigits: 2 })}`;
      }
    }

    // Cancelar edici√≥n
    window.cancelarEdicion = function(docId, boton) {
      if (!filaActual || !datosOriginales) return;
      const celdas = filaActual.querySelectorAll('td');
      celdas[0].textContent = datosOriginales.personaSustituirCedula;
      celdas[1].textContent = datosOriginales.personaSustituirNombre;
      celdas[2].textContent = datosOriginales.area;
      celdas[3].textContent = datosOriginales.codArea;
      celdas[4].textContent = datosOriginales.inicio;
      celdas[5].textContent = datosOriginales.final;
      celdas[6].textContent = datosOriginales.horario;
      celdas[7].textContent = datosOriginales.dias;
      celdas[8].textContent = `‚Ç°${parseFloat(datosOriginales.salario).toLocaleString('es-CR', { minimumFractionDigits: 2 })}`;
      celdas[9].textContent = datosOriginales.estado ? "‚úÖ Pagado" : "‚è≥ Pendiente";

      const btnEditar = filaActual.querySelector('.btn-editar');
      const btnGuardar = filaActual.querySelector('.btn-guardar');
      const btnCancelar = filaActual.querySelector('.btn-cancelar');
      btnEditar.style.display = 'inline-block';
      btnGuardar.style.display = 'none';
      btnCancelar.style.display = 'none';

      documentoActual = null;
      filaActual = null;
      datosOriginales = null;
    };

    // Guardar cambios: prepara nuevosValores y actualiza Firestore
    window.guardarCambios = function(docId, boton) {
      const fila = boton.closest('tr');
      const celdas = fila.querySelectorAll('td');
      const nuevosValores = {};

      for (let i = 0; i <= 9; i++) {
        const celda = celdas[i];
        const inputs = celda.querySelectorAll('.editable');
        if (inputs.length > 0) {
          if (i === 6) {
            nuevosValores.horarioEntrada = inputs[0].value || "N/A";
            nuevosValores.horarioSalida = inputs[1].value || "N/A";
          } else {
            const input = inputs[0];
            let campo;
            switch(i) {
              case 0: campo = 'personaSustituirCedula'; break;
              case 1: campo = 'personaSustituirNombre'; break;
              case 2: campo = 'area'; break;
              case 3: campo = 'codArea'; break;
              case 4: campo = 'inicio'; break;
              case 5: campo = 'final'; break;
              case 7: campo = 'dias'; break;
              case 8: campo = 'salario'; break;
              case 9: campo = 'estado'; break;
            }

            if (campo === 'estado') {
              nuevosValores[campo] = input.value === 'true';
            } else if (campo === 'dias' || campo === 'salario') {
              nuevosValores[campo] = (campo === 'salario') ? parseFloat(input.value) || 0 : parseInt(input.value) || 0;
            } else {
              nuevosValores[campo] = input.value || "N/A";
            }
          }
        }
      }

      // Si inicio/final est√°n presentes, asegurarnos de guardarlos en formato YYYY-MM-DD
      if (nuevosValores.inicio) nuevosValores.inicio = formatDateForDisplay(nuevosValores.inicio);
      if (nuevosValores.final) nuevosValores.final = formatDateForDisplay(nuevosValores.final);

      // Mostrar modal de confirmaci√≥n
      const modal = document.getElementById('modalConfirmacion');
      const mensajeConfirmacion = document.getElementById('mensajeConfirmacion');
      mensajeConfirmacion.textContent = `¬øEst√° seguro que desea guardar los cambios realizados al nombramiento de ${nuevosValores.personaSustituirNombre || 'N/A'}?`;
      modal.style.display = 'flex';

      const btnAceptar = document.getElementById('btnAceptar');
      const btnCancelarModal = document.getElementById('btnCancelarModal');

      const confirmarGuardado = async () => {
        try {
          const docRef = doc(db, "nombramientos", docId);
          await updateDoc(docRef, nuevosValores);

          // Actualizar vista (mostrar valores guardados)
          celdas[0].textContent = nuevosValores.personaSustituirCedula || "N/A";
          celdas[1].textContent = nuevosValores.personaSustituirNombre || "N/A";
          celdas[2].textContent = nuevosValores.area || "N/A";
          celdas[3].textContent = nuevosValores.codArea || "N/A";
          celdas[4].textContent = nuevosValores.inicio || "N/A";
          celdas[5].textContent = nuevosValores.final || "N/A";
          celdas[6].textContent = `${nuevosValores.horarioEntrada || 'N/A'} - ${nuevosValores.horarioSalida || 'N/A'}`;
          celdas[7].textContent = nuevosValores.dias || 0;
          celdas[8].textContent = `‚Ç°${parseFloat(nuevosValores.salario || 0).toLocaleString('es-CR', { minimumFractionDigits: 2 })}`;
          celdas[9].textContent = nuevosValores.estado ? "‚úÖ Pagado" : "‚è≥ Pendiente";

          const btnEditar = fila.querySelector('.btn-editar');
          const btnGuardar = fila.querySelector('.btn-guardar');
          const btnCancelar = fila.querySelector('.btn-cancelar');
          btnEditar.style.display = 'inline-block';
          btnGuardar.style.display = 'none';
          btnCancelar.style.display = 'none';

          alert("‚úÖ Cambios guardados correctamente");

          documentoActual = null;
          filaActual = null;
          datosOriginales = null;
        } catch (error) {
          console.error("Error al guardar cambios:", error);
          alert("‚ùå Error al guardar los cambios: " + error.message);
        }
        modal.style.display = 'none';
      };

      btnAceptar.onclick = confirmarGuardado;
      btnCancelarModal.onclick = function() { modal.style.display = 'none'; };

      // Cerrar modal al hacer clic fuera
      window.onclick = function(event) {
        if (event.target == modal) modal.style.display = 'none';
      };
    };

    // Abrir detalle (las fechas en 'datos' ya vienen normalizadas a YYYY-MM-DD)
    window.abrirDetalle = function(docId, datos) {
      documentoDetalleActual = docId;
      document.getElementById('detalleFuncionario').textContent = datos.personaSustituirNombre || 'SIN DATOS';
      document.getElementById('detallePeriodo').textContent = `${datos.inicio} - ${datos.final || 'N/A'}`;
      document.getElementById('detalleArea').textContent = datos.area || 'N/A';

      generarDiasPeriodo(datos.inicio, datos.final);
      cargarDatosDetalle(datos);
      document.getElementById('modalDetalle').style.display = 'flex';
    };

    function generarDiasPeriodo(fechaInicio, fechaFinal) {
      const container = document.getElementById('diasContainer');
      const totalDiasElem = document.getElementById('totalDias');

      if (!fechaInicio || !fechaFinal) {
        container.innerHTML = '<p style="color: red;">Fechas inv√°lidas</p>';
        totalDiasElem.textContent = '0';
        return;
      }

      const inicio = parseDateNoTZ(fechaInicio);
      const final = parseDateNoTZ(fechaFinal);
      if (!inicio || !final || final < inicio) {
        container.innerHTML = '<p style="color: red;">Fechas inv√°lidas o rango incorrecto</p>';
        totalDiasElem.textContent = '0';
        return;
      }

      const dias = [];
      let actual = new Date(inicio);
      while (actual <= final) {
        dias.push(new Date(actual));
        actual.setDate(actual.getDate() + 1);
      }

      totalDiasElem.textContent = dias.length;
      container.innerHTML = '';

      dias.forEach(fecha => {
        const yyyy = fecha.getFullYear();
        const mm = String(fecha.getMonth()+1).padStart(2,'0');
        const dd = String(fecha.getDate()).padStart(2,'0');
        const fechaStr = `${yyyy}-${mm}-${dd}`;
        const diaSemana = fecha.toLocaleDateString('es-ES', { weekday: 'short' });
        const fechaFormateada = fecha.toLocaleDateString('es-ES');

        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.gap = '8px';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `dia_${fechaStr}`;
        checkbox.value = fechaStr;
        checkbox.dataset.fecha = fechaStr;

        const label = document.createElement('label');
        label.htmlFor = `dia_${fechaStr}`;
        label.textContent = `${fechaFormateada} (${diaSemana})`;
        label.style.cursor = 'pointer';

        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);

        checkbox.addEventListener('change', function() {
          if (this.checked) diasSeleccionados.add(this.value);
          else diasSeleccionados.delete(this.value);
        });
      });
    }

    function cargarDatosDetalle(datos) {
      diasSeleccionados.clear();
      document.querySelectorAll('#diasContainer input[type="checkbox"]').forEach(cb => cb.checked = false);

      const diasLibres = datos.diasLibres || [];
      diasLibres.forEach(fecha => {
        const fechaStr = formatDateForDisplay(fecha); // normalizar formatos posibles
        const checkbox = document.querySelector(`#dia_${fechaStr}`);
        if (checkbox) {
          checkbox.checked = true;
          diasSeleccionados.add(fechaStr);
        }
      });

      document.getElementById('tipoAusencia').value = datos.tipoAusencia || '';
      document.getElementById('comentarioAusencia').value = datos.comentarioAusencia || '';
    }

    document.getElementById('btnGuardarDetalle').addEventListener('click', async function() {
      if (!documentoDetalleActual) return;
      const tipoAusencia = document.getElementById('tipoAusencia').value;
      const comentarioAusencia = document.getElementById('comentarioAusencia').value;

      if (tipoAusencia && diasSeleccionados.size === 0) {
        alert('‚ö†Ô∏è Debe seleccionar al menos un d√≠a si especifica un tipo de ausencia.');
        return;
      }

      try {
        const datosDetalle = {
          diasLibres: Array.from(diasSeleccionados),
          tipoAusencia: tipoAusencia || null,
          comentarioAusencia: comentarioAusencia || null,
          ultimaActualizacionDetalle: new Date()
        };

        const docRef = doc(db, "nombramientos", documentoDetalleActual);
        await updateDoc(docRef, datosDetalle);

        alert('‚úÖ Detalles guardados correctamente');
        document.getElementById('modalDetalle').style.display = 'none';
      } catch (error) {
        console.error('Error al guardar detalles:', error);
        alert('‚ùå Error al guardar los detalles: ' + error.message);
      }
    });

    document.getElementById('btnCerrarDetalle').addEventListener('click', function() {
      document.getElementById('modalDetalle').style.display = 'none';
    });

    window.addEventListener('click', function(event) {
      const modal = document.getElementById('modalDetalle');
      if (event.target === modal) modal.style.display = 'none';
    });

    function exportarPDF() {
      const element = document.getElementById('tablaNombramientos');
      const mes = document.getElementById("mes").options[document.getElementById("mes").selectedIndex].text;
      const anio = document.getElementById("anio").value;
      const usuarioInfo = document.getElementById('usuarioInfo').outerHTML;

      const filas = document.querySelectorAll("#tablaRegistros tr");
      if (filas.length <= 1 || filas[0].querySelector("td")?.textContent?.includes("Cargando") || filas[0].querySelector("td")?.textContent?.includes("No se encontraron")) {
        alert("No hay datos para exportar.");
        return;
      }

      const pdfContainer = document.createElement('div');
      pdfContainer.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          <h2 style="color: #0d47a1; font-size: 24px; margin-bottom: 10px;">Reporte de Nombramientos</h2>
          <p style="font-size: 16px; margin-bottom: 5px;">Filtrado por: ${mes} ${anio}</p>
          <p style="font-size: 14px;">Generado por: ${usuario.nombre || 'Usuario'}</p>
          <p style="font-size: 14px;">Fecha: ${new Date().toLocaleDateString('es-CR')}</p>
        </div>
        ${usuarioInfo}
      `;

      const tablaClone = element.cloneNode(true);
      const botonesAcciones = tablaClone.querySelectorAll('.acciones');
      botonesAcciones.forEach(btn => { btn.innerHTML = 'Reporte generado'; btn.style.backgroundColor = '#e0e0e0'; btn.style.color = '#666'; btn.style.padding = '5px'; btn.style.borderRadius = '3px'; btn.style.textAlign = 'center'; });
      pdfContainer.appendChild(tablaClone);

      const opt = { margin: [15, 10, 15, 10], filename: `nombramientos_${mes}_${anio}_${usuario.nombre || 'usuario'}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } };
      html2pdf().set(opt).from(pdfContainer).save();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const hoy = new Date();
      const mesSelect = document.getElementById("mes");
      const anioSelect = document.getElementById("anio");
      if (mesSelect) mesSelect.value = hoy.getMonth() + 1;
      if (anioSelect) {
        anioSelect.innerHTML = "";
        for (let year = 2020; year <= 2025; year++) {
          const option = document.createElement("option"); option.value = year; option.textContent = year; anioSelect.appendChild(option);
        }
        anioSelect.value = hoy.getFullYear();
      }

      setTimeout(() => { cargarRegistros(); }, 500);
    });

    document.addEventListener("DOMContentLoaded", () => {
      const btnFiltrar = document.getElementById("btnFiltrar");
      const btnExportarPDF = document.getElementById("btnExportarPDF");
      const selectMes = document.getElementById("mes");
      const selectAnio = document.getElementById("anio");

      if (btnFiltrar) btnFiltrar.addEventListener("click", cargarRegistros);
      if (btnExportarPDF) btnExportarPDF.addEventListener("click", exportarPDF);
      if (selectMes) selectMes.addEventListener("change", cargarRegistros);
      if (selectAnio) selectAnio.addEventListener("change", cargarRegistros);

      console.log("‚úÖ Todos los eventos y auto-filtros asignados correctamente.");
    });
  </script>
</body>
</html>
