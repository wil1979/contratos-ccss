<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consultas de Nombramientos</title>
  <link rel="stylesheet" href="styleconsulta.css">
</head>
<body>
  <div class="container">
    <h2>Consultas de Nombramientos</h2>

    <!-- Informaci√≥n del usuario activo -->
    <div class="usuario-info" id="usuarioInfo">
      <h3>Usuario Activo: <span id="nombreUsuario">Cargando...</span></h3>
      <p>Rol: <span id="rolUsuario">Administrador</span></p>
    </div>

    <div class="filtros">
      <div>
        <label for="mes">Mes:</label>
        <select id="mes">
          <option value="">Todos los meses</option>
          <option value="1">Enero</option>
          <option value="2">Febrero</option>
          <option value="3">Marzo</option>
          <option value="4">Abril</option>
          <option value="5">Mayo</option>
          <option value="6">Junio</option>
          <option value="7">Julio</option>
          <option value="8">Agosto</option>
          <option value="9">Septiembre</option>
          <option value="10">Octubre</option>
          <option value="11">Noviembre</option>
          <option value="12">Diciembre</option>
        </select>
      </div>

      <div>
        <label for="anio">A√±o:</label>
        <select id="anio">
          <option value="">Todos los a√±os</option>
          <!-- Se llenar√° din√°micamente con JavaScript -->
        </select>
      </div>

      <button id="btnFiltrar">Filtrar</button>
      <button id="btnExportarPDF">üìÑ Exportar PDF</button>
    </div>

    <div class="tabla-container">
      <div id="mensajeError" class="error" style="display:none;"></div>
      <table id="tablaNombramientos">
        <thead>
          <tr>
            <th>C√©dula Sustituido</th>
            <th>Funcionario Sustituido</th>
            <th>√Årea</th>
            <th>C√≥digo √Årea</th>
            <th>Inicio</th>
            <th>Final</th>
            <th>Horario</th>
            <th>D√≠as</th>
            <th>Salario</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaRegistros">
          <tr><td colspan="11" class="cargando">Cargando todos los datos registrados...</td></tr>
        </tbody>
      </table>
      <div id="mensajeSinDatos" class="sin-datos" style="display:none;">
        üì≠ No se encontraron nombramientos con los criterios seleccionados.
      </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div id="modalConfirmacion" class="modal">
      <div class="modal-contenido">
        <h3 class="modal-titulo">Confirmar Cambios</h3>
        <p id="mensajeConfirmacion">¬øEst√° seguro que desea guardar los cambios realizados?</p>
        <div class="modal-botones">
          <button id="btnAceptar" class="btn-modal btn-aceptar">Aceptar</button>
          <button id="btnCancelarModal" class="btn-modal btn-cancelar-modal">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- üéØ Bot√≥n flotante "Inicio" -->
    <a href="dashboard.html" class="btn-flotante-inicio" title="Ir al Dashboard">
      üè† Inicio
    </a>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // üîπ Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDigm9JWEqr5h0YV3H6a-H3ub4N__2Y2q4",
      authDomain: "interinos-ccss.firebaseapp.com",
      projectId: "interinos-ccss",
      storageBucket: "interinos-ccss.firebasestorage.app",
      messagingSenderId: "1098694984589",
      appId: "1:1098694984589:web:180af36da33ff6a161b3c4"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Verificar sesi√≥n
    const usuario = JSON.parse(localStorage.getItem("usuarioActivo"));
    if (!usuario) {
      window.location.href = "login.html";
    } else {
      // Mostrar informaci√≥n del usuario activo
      document.getElementById("nombreUsuario").textContent = usuario.nombre || "Usuario";
      document.getElementById("rolUsuario").textContent = usuario.rol || "Usuario";
    }

    // Variables globales
    let documentoActual = null;
    let filaActual = null;
    let datosOriginales = null;

    // üîπ Extrae mes y a√±o directamente del string YYYY-MM-DD (evita zona horaria)
    function extraerMesYAnioDeFechaString(fechaStr) {
      if (!fechaStr || !/^\d{4}-\d{2}-\d{2}$/.test(fechaStr)) {
        console.warn("Formato de fecha inv√°lido:", fechaStr);
        return null;
      }
      const [anio, mes] = fechaStr.split("-").map(Number);
      return { mes, anio };
    }

    // üîπ Cargar registros con filtro desde Firestore (FILTRANDO POR USUARIO ACTIVO)
    async function cargarRegistros() {
      const mesSeleccionado = document.getElementById("mes")?.value;
      const anioSeleccionado = document.getElementById("anio")?.value;
      const tbody = document.getElementById("tablaRegistros");
      const mensaje = document.getElementById("mensajeSinDatos");
      const tabla = document.getElementById("tablaNombramientos");
      const mensajeError = document.getElementById("mensajeError");

      // Ocultar mensajes previos
      mensajeError.style.display = "none";
      mensaje.style.display = "none";

      console.log("üîç Filtrando por Mes:", mesSeleccionado || "Todos", "A√±o:", anioSeleccionado || "Todos", "Usuario:", usuario.cedula);

      // Mostrar estado de carga
      tbody.innerHTML = `<tr><td colspan="11" class="cargando">Cargando datos...</td></tr>`;
      tabla.style.display = "table";

      try {
        // Obtener documentos de la colecci√≥n "nombramientos" filtrados por usuarioCedula
        const nombramientosRef = collection(db, "nombramientos");
        
        // Crear query que filtre por usuarioCedula del usuario activo
        const q = query(nombramientosRef, where("usuarioCedula", "==", usuario.cedula));
        const querySnapshot = await getDocs(q);

        let hayDatos = false;
        tbody.innerHTML = ""; // Limpiar "Cargando..."

        // Procesar cada documento
        querySnapshot.forEach((docSnapshot) => {
          const r = docSnapshot.data();
          
          // Verificar que el documento tenga la fecha de inicio
          if (!r.inicio) {
            console.warn("üìÑ Documento sin campo 'inicio':", docSnapshot.id);
            return;
          }

          // Extraer mes y a√±o de la fecha de inicio
          const fecha = extraerMesYAnioDeFechaString(r.inicio);
          if (!fecha) {
            console.warn("üìÑ Fecha inv√°lida:", r.inicio, "en documento", docSnapshot.id);
            return;
          }

          // Filtrar por mes y a√±o seleccionados (si se seleccionaron)
          let mostrarRegistro = true;
          
          if (mesSeleccionado !== "" && fecha.mes !== parseInt(mesSeleccionado)) {
            mostrarRegistro = false;
          }
          
          if (anioSeleccionado !== "" && fecha.anio !== parseInt(anioSeleccionado)) {
            mostrarRegistro = false;
          }

          if (mostrarRegistro) {
            hayDatos = true;
            
            // Formatear los datos para mostrar (CAMBIADO: personaSustituirCedula y personaSustituirNombre)
            const personaSustituirNombre = r.personaSustituirNombre || "SIN DATOS";
            const personaSustituirCedula = r.personaSustituirCedula || "N/A";
            const area = r.area || "N/A";
            const codArea = r.codArea || "N/A";
            const fechaFinal = r.final || "N/A";
            const horario = `${r.horarioEntrada || 'N/A'} - ${r.horarioSalida || 'N/A'}`;
            const dias = r.dias || 0;
            const salario = parseFloat(r.salario || 0).toLocaleString('es-CR', { minimumFractionDigits: 2 });
            const estado = r.estado ? "‚úÖ Pagado" : "‚è≥ Pendiente";

            // Crear la fila de la tabla
            const fila = document.createElement('tr');
            fila.dataset.id = docSnapshot.id;
            fila.innerHTML = `
              <td>${personaSustituirCedula}</td>
              <td>${personaSustituirNombre}</td>
              <td>${area}</td>
              <td>${codArea}</td>
              <td>${r.inicio}</td>
              <td>${fechaFinal}</td>
              <td>${horario}</td>
              <td>${dias}</td>
              <td>‚Ç°${salario}</td>
              <td>${estado}</td>
              <td class="acciones">
                <button class="btn-editar" onclick="iniciarEdicion('${docSnapshot.id}', this)">‚úèÔ∏è Editar</button>
                <button class="btn-guardar" onclick="guardarCambios('${docSnapshot.id}', this)">üíæ Guardar</button>
                <button class="btn-cancelar" onclick="cancelarEdicion('${docSnapshot.id}', this)">‚ùå Cancelar</button>
              </td>
            `;
            tbody.appendChild(fila);
          }
        });

        if (!hayDatos) {
          tabla.style.display = "none";
          mensaje.style.display = "block";
          console.log("üì≠ No se encontraron datos para este filtro.");
        } else {
          console.log(`‚úÖ Se cargaron ${querySnapshot.size} registros del usuario ${usuario.cedula}.`);
        }
      } catch (error) {
        console.error("‚ùå Error al cargar registros de Firestore:", error);
        mensajeError.textContent = "Error al cargar datos: " + error.message;
        mensajeError.style.display = "block";
        tbody.innerHTML = `<tr><td colspan="11" style="color:red;">Error al cargar datos de la base de datos. Por favor, intente nuevamente.</td></tr>`;
      }
    }

    // üîπ Iniciar edici√≥n de un registro
    window.iniciarEdicion = function(docId, boton) {
      const fila = boton.closest('tr');
      filaActual = fila;
      documentoActual = docId;
      
      // Guardar valores originales
      const celdas = fila.querySelectorAll('td');
      datosOriginales = {
        personaSustituirCedula: celdas[0].textContent,
        personaSustituirNombre: celdas[1].textContent,
        area: celdas[2].textContent,
        codArea: celdas[3].textContent,
        inicio: celdas[4].textContent,
        final: celdas[5].textContent,
        horario: celdas[6].textContent,
        dias: celdas[7].textContent,
        salario: celdas[8].textContent.replace('‚Ç°', '').replace(/\./g, '').replace(',', '.'),
        estado: celdas[9].textContent.includes('‚úÖ')
      };
      
      // Cambiar los botones
      const btnEditar = fila.querySelector('.btn-editar');
      const btnGuardar = fila.querySelector('.btn-guardar');
      const btnCancelar = fila.querySelector('.btn-cancelar');
      
      btnEditar.style.display = 'none';
      btnGuardar.style.display = 'inline-block';
      btnCancelar.style.display = 'inline-block';
      
      // Convertir celdas en campos editables
      hacerEditable(celdas[0], 'personaSustituirCedula');
      hacerEditable(celdas[1], 'personaSustituirNombre');
      hacerEditable(celdas[2], 'area');
      hacerEditable(celdas[3], 'codArea');
      hacerEditableFecha(celdas[4], 'inicio');
      hacerEditableFecha(celdas[5], 'final');
      hacerEditableHorario(celdas[6]);
      hacerEditableNumero(celdas[7], 'dias');
      hacerEditableNumero(celdas[8], 'salario', true);
      hacerEditableEstado(celdas[9], 'estado');
    };

    // üîπ Hacer una celda editable como texto
    function hacerEditable(celda, campo) {
      const valor = celda.textContent;
      celda.innerHTML = `<input type="text" class="editable" value="${valor}" data-campo="${campo}">`;
    }

    // üîπ Hacer una celda editable como fecha
    function hacerEditableFecha(celda, campo) {
      const valor = celda.textContent;
      celda.innerHTML = `<input type="date" class="editable" value="${valor === 'N/A' ? '' : valor}" data-campo="${campo}">`;
    }

    // üîπ Hacer una celda editable como n√∫mero
    function hacerEditableNumero(celda, campo, esMoneda = false) {
      let valor = celda.textContent;
      if (esMoneda) {
        valor = valor.replace('‚Ç°', '').replace(/\./g, '').replace(',', '.').trim();
      }
      celda.innerHTML = `<input type="number" class="editable" value="${valor}" data-campo="${campo}" step="${esMoneda ? '0.01' : '1'}">`;
    }

    // üîπ Hacer una celda editable como estado (select)
    function hacerEditableEstado(celda, campo) {
      const esPagado = celda.textContent.includes('‚úÖ');
      celda.innerHTML = `
        <select class="editable" data-campo="${campo}">
          <option value="true" ${esPagado ? 'selected' : ''}>‚úÖ Pagado</option>
          <option value="false" ${!esPagado ? 'selected' : ''}>‚è≥ Pendiente</option>
        </select>
      `;
    }

    // üîπ Hacer una celda editable como horario (entrada y salida)
    function hacerEditableHorario(celda) {
      const texto = celda.textContent;
      let entrada = 'N/A', salida = 'N/A';
      
      if (texto !== 'N/A - N/A') {
        const partes = texto.split(' - ');
        if (partes.length === 2) {
          entrada = partes[0];
          salida = partes[1];
        }
      }
      
      celda.innerHTML = `
        <div style="display: flex; gap: 5px; justify-content: center;">
          <input type="time" class="editable" value="${entrada === 'N/A' ? '' : entrada}" data-campo="horarioEntrada" style="width: 70px;">
          <span>-</span>
          <input type="time" class="editable" value="${salida === 'N/A' ? '' : salida}" data-campo="horarioSalida" style="width: 70px;">
        </div>
      `;
    }

    // üîπ Cancelar edici√≥n de un registro
    window.cancelarEdicion = function(docId, boton) {
      if (!filaActual || !datosOriginales) return;
      
      const celdas = filaActual.querySelectorAll('td');
      celdas[0].textContent = datosOriginales.personaSustituirCedula;
      celdas[1].textContent = datosOriginales.personaSustituirNombre;
      celdas[2].textContent = datosOriginales.area;
      celdas[3].textContent = datosOriginales.codArea;
      celdas[4].textContent = datosOriginales.inicio;
      celdas[5].textContent = datosOriginales.final;
      celdas[6].textContent = datosOriginales.horario;
      celdas[7].textContent = datosOriginales.dias;
      celdas[8].textContent = `‚Ç°${parseFloat(datosOriginales.salario).toLocaleString('es-CR', { minimumFractionDigits: 2 })}`;
      celdas[9].textContent = datosOriginales.estado ? "‚úÖ Pagado" : "‚è≥ Pendiente";
      
      // Cambiar los botones
      const btnEditar = filaActual.querySelector('.btn-editar');
      const btnGuardar = filaActual.querySelector('.btn-guardar');
      const btnCancelar = filaActual.querySelector('.btn-cancelar');
      
      btnEditar.style.display = 'inline-block';
      btnGuardar.style.display = 'none';
      btnCancelar.style.display = 'none';
      
      // Limpiar variables
      documentoActual = null;
      filaActual = null;
      datosOriginales = null;
    };

    // üîπ Guardar cambios de un registro
    window.guardarCambios = function(docId, boton) {
      const fila = boton.closest('tr');
      
      // Obtener los nuevos valores
      const celdas = fila.querySelectorAll('td');
      const nuevosValores = {};
      
      // Procesar cada celda editable
      for (let i = 0; i <= 9; i++) { // De la celda 0 a la 9 (excluyendo acciones)
        const celda = celdas[i];
        const inputs = celda.querySelectorAll('.editable');
        
        if (inputs.length > 0) {
          if (i === 6) { // Horario (entrada y salida)
            nuevosValores.horarioEntrada = inputs[0].value || "N/A";
            nuevosValores.horarioSalida = inputs[1].value || "N/A";
          } else {
            const input = inputs[0];
            let campo;
            
            // Asignar el campo correcto seg√∫n la posici√≥n
            switch(i) {
              case 0: campo = 'personaSustituirCedula'; break;
              case 1: campo = 'personaSustituirNombre'; break;
              case 2: campo = 'area'; break;
              case 3: campo = 'codArea'; break;
              case 4: campo = 'inicio'; break;
              case 5: campo = 'final'; break;
              case 7: campo = 'dias'; break;
              case 8: campo = 'salario'; break;
              case 9: campo = 'estado'; break;
            }
            
            if (campo === 'estado') {
              nuevosValores[campo] = input.value === 'true';
            } else if (campo === 'dias' || campo === 'salario') {
              nuevosValores[campo] = parseFloat(input.value) || 0;
            } else {
              nuevosValores[campo] = input.value || "N/A";
            }
          }
        }
      }
      
      // Mostrar modal de confirmaci√≥n
      const modal = document.getElementById('modalConfirmacion');
      const mensajeConfirmacion = document.getElementById('mensajeConfirmacion');
      mensajeConfirmacion.textContent = `¬øEst√° seguro que desea guardar los cambios realizados al nombramiento de ${celdas[1].querySelector('.editable')?.value || 'N/A'}?`;
      modal.style.display = 'flex';
      
      // Manejar botones del modal
      const btnAceptar = document.getElementById('btnAceptar');
      const btnCancelarModal = document.getElementById('btnCancelarModal');
      
      // Funci√≥n para guardar realmente los cambios
      const confirmarGuardado = async () => {
        try {
          // Actualizar en Firestore
          const docRef = doc(db, "nombramientos", docId);
          await updateDoc(docRef, nuevosValores);
          
          // Actualizar la vista
          celdas[0].textContent = nuevosValores.personaSustituirCedula || "N/A";
          celdas[1].textContent = nuevosValores.personaSustituirNombre || "N/A";
          celdas[2].textContent = nuevosValores.area || "N/A";
          celdas[3].textContent = nuevosValores.codArea || "N/A";
          celdas[4].textContent = nuevosValores.inicio || "N/A";
          celdas[5].textContent = nuevosValores.final || "N/A";
          celdas[6].textContent = `${nuevosValores.horarioEntrada || 'N/A'} - ${nuevosValores.horarioSalida || 'N/A'}`;
          celdas[7].textContent = nuevosValores.dias || 0;
          celdas[8].textContent = `‚Ç°${parseFloat(nuevosValores.salario || 0).toLocaleString('es-CR', { minimumFractionDigits: 2 })}`;
          celdas[9].textContent = nuevosValores.estado ? "‚úÖ Pagado" : "‚è≥ Pendiente";
          
          // Cambiar los botones
          const btnEditar = fila.querySelector('.btn-editar');
          const btnGuardar = fila.querySelector('.btn-guardar');
          const btnCancelar = fila.querySelector('.btn-cancelar');
          
          btnEditar.style.display = 'inline-block';
          btnGuardar.style.display = 'none';
          btnCancelar.style.display = 'none';
          
          // Mostrar mensaje de √©xito
          alert("‚úÖ Cambios guardados correctamente");
          
          // Limpiar variables
          documentoActual = null;
          filaActual = null;
          datosOriginales = null;
          
        } catch (error) {
          console.error("Error al guardar cambios:", error);
          alert("‚ùå Error al guardar los cambios: " + error.message);
        }
        
        // Cerrar modal
        modal.style.display = 'none';
      };
      
      // Asignar eventos a los botones del modal
      btnAceptar.onclick = confirmarGuardado;
      btnCancelarModal.onclick = function() {
        modal.style.display = 'none';
      };
      
      // Cerrar modal al hacer clic fuera de √©l
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      };
    };

    // üîπ Exportar tabla a PDF usando html2pdf
    function exportarPDF() {
      const element = document.getElementById('tablaNombramientos');
      const mes = document.getElementById("mes").options[document.getElementById("mes").selectedIndex].text;
      const anio = document.getElementById("anio").options[document.getElementById("anio").selectedIndex].text;
      const usuarioInfo = document.getElementById('usuarioInfo').outerHTML;
      
      // Verificar si hay datos para exportar
      const filas = document.querySelectorAll("#tablaRegistros tr");
      if (filas.length <= 1 || filas[0].querySelector("td")?.textContent?.includes("Cargando") || filas[0].querySelector("td")?.textContent?.includes("No se encontraron")) {
        alert("No hay datos para exportar.");
        return;
      }

      // Crear un contenedor para el PDF
      const pdfContainer = document.createElement('div');
      pdfContainer.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          <h2 style="color: #0d47a1; font-size: 24px; margin-bottom: 10px;">Reporte de Nombramientos</h2>
          <p style="font-size: 16px; margin-bottom: 5px;">Filtrado por: ${mes} ${anio}</p>
          <p style="font-size: 14px;">Generado por: ${usuario.nombre || 'Usuario'}</p>
          <p style="font-size: 14px;">Fecha: ${new Date().toLocaleDateString('es-CR')}</p>
        </div>
        ${usuarioInfo}
      `;
      
      // Clonar la tabla
      const tablaClone = element.cloneNode(true);
      
      // Eliminar botones de acciones en el PDF
      const botonesAcciones = tablaClone.querySelectorAll('.acciones');
      botonesAcciones.forEach(btn => {
        btn.innerHTML = 'Reporte generado';
        btn.style.backgroundColor = '#e0e0e0';
        btn.style.color = '#666';
        btn.style.padding = '5px';
        btn.style.borderRadius = '3px';
        btn.style.textAlign = 'center';
      });
      
      pdfContainer.appendChild(tablaClone);

      const opt = {
        margin: [15, 10, 15, 10],
        filename: `nombramientos_${mes}_${anio}_${usuario.nombre || 'usuario'}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
      };

      // Generar el PDF
      html2pdf().set(opt).from(pdfContainer).save();
    }

    // ‚úÖ Inicializaci√≥n segura al cargar la p√°gina
    document.addEventListener("DOMContentLoaded", () => {
      const hoy = new Date();
      const mesSelect = document.getElementById("mes");
      const anioSelect = document.getElementById("anio");

      // Establecer opci√≥n "Todos los meses" por defecto
      if (mesSelect) mesSelect.value = "";

      // Llenar el select de a√±os desde 2020 hasta 2025 con opci√≥n "Todos los a√±os"
      if (anioSelect) {
        anioSelect.innerHTML = ""; // Limpiar opciones existentes
        // Agregar opci√≥n "Todos los a√±os"
        const optionTodos = document.createElement("option");
        optionTodos.value = "";
        optionTodos.textContent = "Todos los a√±os";
        anioSelect.appendChild(optionTodos);
        
        // Agregar a√±os desde 2020 hasta 2025
        for (let year = 2020; year <= 2025; year++) {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          anioSelect.appendChild(option);
        }
        // Establecer opci√≥n "Todos los a√±os" por defecto
        anioSelect.value = "";
      }

      // Cargar todos los datos iniciales (sin filtros)
      setTimeout(() => {
        cargarRegistros();
      }, 500);
    });

    // ‚úÖ Asignar eventos a botones y filtros autom√°ticos
    document.addEventListener("DOMContentLoaded", () => {
      const btnFiltrar = document.getElementById("btnFiltrar");
      const btnExportarPDF = document.getElementById("btnExportarPDF");
      const selectMes = document.getElementById("mes");
      const selectAnio = document.getElementById("anio");

      if (btnFiltrar) {
        btnFiltrar.addEventListener("click", cargarRegistros);
      }

      if (btnExportarPDF) {
        btnExportarPDF.addEventListener("click", exportarPDF);
      }

      // ‚úÖ Auto-filtrar cuando cambie mes
      if (selectMes) {
        selectMes.addEventListener("change", cargarRegistros);
      }

      // ‚úÖ Auto-filtrar cuando cambie a√±o
      if (selectAnio) {
        selectAnio.addEventListener("change", cargarRegistros);
      }

      console.log("‚úÖ Todos los eventos y auto-filtros asignados correctamente.");
    });
  </script>
</body>
</html>