<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consultas de Nombramientos</title>
  <link rel="stylesheet" href="styleconsulta.css">
</head>
<body>
  <div class="container">
    <h2>Consultas de Nombramientos</h2>
    <!-- Informaci√≥n del usuario activo -->
    <div class="usuario-info" id="usuarioInfo">
      <h3>Usuario Activo: <span id="nombreUsuario">Cargando...</span></h3>
      <p>Rol: <span id="rolUsuario">Administrador</span></p>
    </div>
    <div class="filtros">
      <div>
        <label for="mes">Mes:</label>
        <select id="mes">
          <option value="">Todos los meses</option>
          <option value="1">Enero</option>
          <option value="2">Febrero</option>
          <option value="3">Marzo</option>
          <option value="4">Abril</option>
          <option value="5">Mayo</option>
          <option value="6">Junio</option>
          <option value="7">Julio</option>
          <option value="8">Agosto</option>
          <option value="9">Septiembre</option>
          <option value="10">Octubre</option>
          <option value="11">Noviembre</option>
          <option value="12">Diciembre</option>
        </select>
      </div>
      <div>
        <label for="anio">A√±o:</label>
        <select id="anio">
          <!-- Se llenar√° din√°micamente con JavaScript -->
        </select>
      </div>
      <button id="btnFiltrar">Filtrar</button>
      <button id="btnExportarPDF">üìÑ Exportar PDF</button>
      <button id="btnVerDiasLibres">üìä Ver D√≠as Libres</button>
    </div>
    <div class="tabla-container">
      <div id="mensajeError" class="error" style="display:none;"></div>
      <table id="tablaNombramientos">
        <thead>
          <tr>
            <th>C√©dula Sustituido</th>
            <th>Funcionario Sustituido</th>
            <th>√Årea</th>
            <th>C√≥digo √Årea</th>
            <th>Inicio</th>
            <th>Final</th>
            <th>Horario</th>
            <th>D√≠as</th>
            <th>Salario</th>
            <th>Estado</th>
            <th>D√≠as Libres</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaRegistros">
          <tr><td colspan="12" class="cargando">Cargando datos del mes actual...</td></tr>
        </tbody>
      </table>
      <div id="mensajeSinDatos" class="sin-datos" style="display:none;">
        üì≠ No se encontraron nombramientos para este mes y a√±o.
      </div>
    </div>
    <!-- Modal de Confirmaci√≥n -->
    <div id="modalConfirmacion" class="modal">
      <div class="modal-contenido">
        <h3 class="modal-titulo">Confirmar Cambios</h3>
        <p id="mensajeConfirmacion">¬øEst√° seguro que desea guardar los cambios realizados?</p>
        <div class="modal-botones">
          <button id="btnAceptar" class="btn-modal btn-aceptar">Aceptar</button>
          <button id="btnCancelarModal" class="btn-modal btn-cancelar-modal">Cancelar</button>
        </div>
      </div>
    </div>
    <!-- Modal de Detalle de Nombramiento -->
    <div id="modalDetalle" class="modal">
      <div class="modal-contenido" style="max-width: 800px; width: 90%;">
        <h3 class="modal-titulo">Detalles del Nombramiento</h3>
        <div class="detalle-info">
          <p><strong>Funcionario:</strong> <span id="detalleFuncionario"></span></p>
          <p><strong>Per√≠odo:</strong> <span id="detallePeriodo"></span></p>
          <p><strong>√Årea:</strong> <span id="detalleArea"></span></p>
        </div>
        <div class="dias-seleccion">
          <h4>Seleccionar d√≠as en el mes de <span id="mesCalendario"></span></h4>
          <div class="calendario-container" id="calendarioContainer"></div>
        </div>
        <div class="form-group">
          <label for="tipoAusencia">Tipo de D√≠a:</label>
          <select id="tipoAusencia" class="form-control">
            <option value="">-- Seleccione tipo --</option>
            <option value="laborado">‚úÖ D√≠a Laborado</option>
            <option value="no_laborado">‚ùå D√≠a No Laborado</option>
            <option value="libre1">üî¥ Libre 1</option>
            <option value="libre2">üü† Libre 2</option>
            <option value="libre3">üü£ Libre 3</option>
            <option value="vacaciones">üèñÔ∏è Vacaciones</option>
            <option value="licencia">üè• Licencia</option>
          </select>
        </div>
        <div class="form-group">
          <label for="comentarioAusencia">Comentario:</label>
          <textarea id="comentarioAusencia" placeholder="Comentario adicional..."></textarea>
        </div>
        <div class="modal-botones">
          <button id="btnGuardarDetalle" class="btn-modal btn-aceptar">üíæ Guardar Detalles</button>
          <button id="btnCerrarDetalle" class="btn-modal btn-cancelar-modal">Cerrar</button>
        </div>
      </div>
    </div>
    <!-- üéØ Bot√≥n flotante "Inicio" -->
    <a href="dashboard.html" class="btn-flotante-inicio" title="Ir al Dashboard">
      üè† Inicio
    </a>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, query, where, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDigm9JWEqr5h0YV3H6a-H3ub4N__2Y2q4",
      authDomain: "interinos-ccss.firebaseapp.com",
      projectId: "interinos-ccss",
      storageBucket: "interinos-ccss.firebasestorage.app",
      messagingSenderId: "1098694984589",
      appId: "1:1098694984589:web:180af36da33ff6a161b3c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const usuario = JSON.parse(localStorage.getItem("usuarioActivo"));
    if (!usuario) {
      window.location.href = "login.html";
    } else {
      document.getElementById("nombreUsuario").textContent = usuario.nombre || "Usuario";
      document.getElementById("rolUsuario").textContent = usuario.rol || "Usuario";
    }

    let documentoActual = null;
    let filaActual = null;
    let datosOriginales = null;
    let documentoDetalleActual = null;
    let diasSeleccionados = new Set();
    let rangoNombramiento = { inicio: null, final: null };

    function extraerMesYAnioDeFechaString(fechaStr) {
      if (!fechaStr || !/^\d{4}-\d{2}-\d{2}$/.test(fechaStr)) return null;
      const [anio, mes] = fechaStr.split("-").map(Number);
      return { mes, anio };
    }

    // üîπ GUARDAR D√çA EN CALENDAR (igual que en calendar.html)
    async function guardarDiaEnCalendar(fechaString, tipo, comentario) {
      try {
        const fecha = new Date(fechaString);
        const mes = fecha.getMonth();
        const anio = fecha.getFullYear();
        const calendarRef = collection(db, "calendar");
        const docRef = doc(calendarRef, `${usuario.cedula}_${anio}_${mes}`);
        const docSnap = await getDoc(docRef);
        let datosMes = docSnap.exists() ? docSnap.data() : {};
        if (tipo) {
          datosMes[fechaString] = {
            tipo,
            comentario: comentario || null,
            usuario: {
              cedula: usuario.cedula,
              nombre: usuario.nombre,
              rol: usuario.rol
            },
            ultimaActualizacion: new Date()
          };
        } else {
          delete datosMes[fechaString];
        }
        await setDoc(docRef, datosMes);
        return true;
      } catch (error) {
        console.error("Error al guardar en calendar:", error);
        return false;
      }
    }

    // üîπ CARGAR D√çAS DESDE CALENDAR PARA UN RANGO
    async function cargarDiasDesdeCalendar(inicio, final) {
      const inicioDate = new Date(inicio);
      const finalDate = new Date(final);
      const diasMap = new Map();
      const meses = [];
      let current = new Date(inicioDate.getFullYear(), inicioDate.getMonth(), 1);
      const finRango = new Date(finalDate.getFullYear(), finalDate.getMonth(), 1);
      while (current <= finRango) {
        meses.push({ anio: current.getFullYear(), mes: current.getMonth() });
        current.setMonth(current.getMonth() + 1);
      }
      for (const { anio, mes } of meses) {
        const docRef = doc(collection(db, "calendar"), `${usuario.cedula}_${anio}_${mes}`);
        const snap = await getDoc(docRef);
        if (snap.exists()) {
          const data = snap.data();
          Object.keys(data).forEach(fecha => {
            const fechaObj = new Date(fecha);
            if (fechaObj >= inicioDate && fechaObj <= finalDate) {
              const registro = data[fecha];
              if (registro.usuario?.cedula === usuario.cedula) {
                diasMap.set(fecha, registro);
              }
            }
          });
        }
      }
      return diasMap;
    }

    // üîπ ACTUALIZAR COLUMNA DE D√çAS LIBRES EN TABLA
    async function actualizarDiasLibresEnFila(docId, inicio, final) {
      const diasMap = await cargarDiasDesdeCalendar(inicio, final);
      const diasNoLaborados = Array.from(diasMap.values()).filter(d => d.tipo !== 'laborado').length;
      const fila = document.querySelector(`tr[data-id="${docId}"]`);
      if (fila) {
        const celda = fila.querySelectorAll('td')[10];
        const texto = diasNoLaborados > 0 
          ? `${diasNoLaborados} d√≠a${diasNoLaborados !== 1 ? 's' : ''}`
          : "Ninguno";
        celda.textContent = texto;
        celda.title = diasNoLaborados > 0 
          ? 'Fechas: ' + Array.from(diasMap.keys()).join(', ') 
          : '';
      }
    }

    // üîπ CARGAR REGISTROS (sin depender de diasLibres)
    async function cargarRegistros() {
      const mesSeleccionado = document.getElementById("mes")?.value;
      const anioSeleccionado = parseInt(document.getElementById("anio")?.value);
      const tbody = document.getElementById("tablaRegistros");
      const mensaje = document.getElementById("mensajeSinDatos");
      const tabla = document.getElementById("tablaNombramientos");
      const mensajeError = document.getElementById("mensajeError");

      mensajeError.style.display = "none";
      mensaje.style.display = "none";

      if (isNaN(anioSeleccionado)) {
        tbody.innerHTML = `<tr><td colspan="12" style="color:red;">‚ö†Ô∏è A√±o inv√°lido.</td></tr>`;
        tabla.style.display = "table";
        return;
      }

      tbody.innerHTML = `<tr><td colspan="12" class="cargando">Cargando...</td></tr>`;
      tabla.style.display = "table";

      try {
        const nombramientosRef = collection(db, "nombramientos");
        const q = query(nombramientosRef, where("usuarioCedula", "==", usuario.cedula));
        const querySnapshot = await getDocs(q);
        const registrosFiltrados = [];

        querySnapshot.forEach((docSnapshot) => {
          const r = docSnapshot.data();
          if (!r || typeof r !== 'object' || !r.inicio) return;
          const fecha = extraerMesYAnioDeFechaString(r.inicio);
          if (!fecha) return;
          if (fecha.anio !== anioSeleccionado) return;
          if (mesSeleccionado !== "" && fecha.mes !== parseInt(mesSeleccionado)) return;
          registrosFiltrados.push({ id: docSnapshot.id, data: r });
        });

        registrosFiltrados.sort((a, b) => {
          const inicioA = a.data?.inicio;
          const inicioB = b.data?.inicio;
          if (!inicioA && !inicioB) return 0;
          if (!inicioA) return 1;
          if (!inicioB) return -1;
          const fechaA = new Date(inicioA);
          const fechaB = new Date(inicioB);
          if (isNaN(fechaA.getTime()) && isNaN(fechaB.getTime())) return 0;
          if (isNaN(fechaA.getTime())) return 1;
          if (isNaN(fechaB.getTime())) return -1;
          return fechaA - fechaB;
        });

        tbody.innerHTML = "";
        if (registrosFiltrados.length === 0) {
          tabla.style.display = "none";
          mensaje.style.display = "block";
        } else {
          registrosFiltrados.forEach(registro => {
            const r = registro.data;
            const personaSustituirNombre = r.personaSustituirNombre || "SIN DATOS";
            const personaSustituirCedula = r.personaSustituirCedula || "N/A";
            const area = r.area || "N/A";
            const codArea = r.codArea || "N/A";
            const fechaFinal = r.final || "N/A";
            const horario = `${r.horarioEntrada || 'N/A'} - ${r.horarioSalida || 'N/A'}`;
            const dias = r.dias || 0;
            const salario = parseFloat(r.salario || 0).toLocaleString('es-CR', { minimumFractionDigits: 2 });
            const estado = r.estado ? "‚úÖ Pagado" : "‚è≥ Pendiente";

            const fila = document.createElement('tr');
            fila.dataset.id = registro.id;
            fila.innerHTML = `
              <td>${personaSustituirCedula}</td>
              <td>${personaSustituirNombre}</td>
              <td>${area}</td>
              <td>${codArea}</td>
              <td>${r.inicio}</td>
              <td>${fechaFinal}</td>
              <td>${horario}</td>
              <td>${dias}</td>
              <td>‚Ç°${salario}</td>
              <td>${estado}</td>
              <td class="dias-libres-info">Cargando...</td>
              <td class="acciones">
                <button class="btn-detalle" onclick='abrirDetalle("${registro.id}", ${JSON.stringify(r).replace(/'/g, "\\'")})'>üìã Detalles</button>
                <button class="btn-editar" onclick="iniciarEdicion('${registro.id}', this)">‚úèÔ∏è Editar</button>
                <button class="btn-guardar" onclick="guardarCambios('${registro.id}', this)">üíæ Guardar</button>
                <button class="btn-cancelar" onclick="cancelarEdicion('${registro.id}', this)">‚ùå Cancelar</button>
              </td>
            `;
            tbody.appendChild(fila);

            // ‚úÖ Actualizar columna desde CALENDAR
            actualizarDiasLibresEnFila(registro.id, r.inicio, r.final);
          });
        }
      } catch (error) {
        console.error("Error al cargar registros:", error);
        mensajeError.textContent = "Error: " + error.message;
        mensajeError.style.display = "block";
        tbody.innerHTML = `<tr><td colspan="12" style="color:red;">Error al cargar.</td></tr>`;
      }
    }

    // üîπ FUNCIONES DE EDICI√ìN (sin cambios, solo omiten diasLibres)
    window.iniciarEdicion = function(docId, boton) {
      const fila = boton.closest('tr');
      filaActual = fila;
      documentoActual = docId;
      const celdas = fila.querySelectorAll('td');
      datosOriginales = {
        personaSustituirCedula: celdas[0].textContent,
        personaSustituirNombre: celdas[1].textContent,
        area: celdas[2].textContent,
        codArea: celdas[3].textContent,
        inicio: celdas[4].textContent,
        final: celdas[5].textContent,
        horario: celdas[6].textContent,
        dias: celdas[7].textContent,
        salario: celdas[8].textContent.replace(/[^\d.,-]/g, '').replace(',', '.'),
        estado: celdas[9].textContent.includes('‚úÖ')
      };
      const btnEditar = fila.querySelector('.btn-editar');
      const btnGuardar = fila.querySelector('.btn-guardar');
      const btnCancelar = fila.querySelector('.btn-cancelar');
      btnEditar.style.display = 'none';
      btnGuardar.style.display = 'inline-block';
      btnCancelar.style.display = 'inline-block';
      hacerEditable(celdas[0], 'personaSustituirCedula'); 
      hacerEditable(celdas[1], 'personaSustituirNombre');
      hacerEditable(celdas[2], 'area');
      hacerEditable(celdas[3], 'codArea');
      hacerEditableFecha(celdas[4], 'inicio');
      hacerEditableFecha(celdas[5], 'final');
      hacerEditableHorario(celdas[6]);
      hacerEditableNumero(celdas[7], 'dias');
      hacerEditableNumero(celdas[8], 'salario', true);
      hacerEditableEstado(celdas[9], 'estado');
    };

    function hacerEditable(celda, campo) {
      const valor = celda.textContent;
      celda.innerHTML = `<input type="text" class="editable" value="${valor}" data-campo="${campo}">`;
    }
    function hacerEditableFecha(celda, campo) {
      const valor = celda.textContent;
      celda.innerHTML = `<input type="date" class="editable" value="${valor === 'N/A' ? '' : valor}" data-campo="${campo}">`;
    }
    function hacerEditableNumero(celda, campo, esMoneda = false) {
      let valor = celda.textContent;
      if (esMoneda) {
        valor = valor.replace(/[^\d,.-]/g, '').replace(',', '.').replace(/\.(?=.*\.)/g, '');
      }
      const valorNumerico = parseFloat(valor) || 0;
      celda.innerHTML = `<input type="number" class="editable" value="${valorNumerico}" data-campo="${campo}" step="${esMoneda ? '0.01' : '1'}">`;
    }
    function hacerEditableEstado(celda, campo) {
      const esPagado = celda.textContent.includes('‚úÖ');
      celda.innerHTML = `
        <select class="editable" data-campo="${campo}">
          <option value="true" ${esPagado ? 'selected' : ''}>‚úÖ Pagado</option>
          <option value="false" ${!esPagado ? 'selected' : ''}>‚è≥ Pendiente</option>
        </select>
      `;
    }
    function hacerEditableHorario(celda) {
      const texto = celda.textContent;
      let entrada = 'N/A', salida = 'N/A';
      if (texto !== 'N/A - N/A') {
        const partes = texto.split(' - ');
        if (partes.length === 2) {
          entrada = partes[0];
          salida = partes[1];
        }
      }
      celda.innerHTML = `
        <div style="display: flex; gap: 5px; justify-content: center;">
          <input type="time" class="editable" value="${entrada === 'N/A' ? '' : entrada}" data-campo="horarioEntrada" style="width: 70px;">
          <span>-</span>
          <input type="time" class="editable" value="${salida === 'N/A' ? '' : salida}" data-campo="horarioSalida" style="width: 70px;">
        </div>
      `;
    }

    window.cancelarEdicion = function(docId, boton) {
      if (!filaActual || !datosOriginales) return;
      const celdas = filaActual.querySelectorAll('td');
      celdas[0].textContent = datosOriginales.personaSustituirCedula;
      celdas[1].textContent = datosOriginales.personaSustituirNombre;
      celdas[2].textContent = datosOriginales.area;
      celdas[3].textContent = datosOriginales.codArea;
      celdas[4].textContent = datosOriginales.inicio;
      celdas[5].textContent = datosOriginales.final;
      celdas[6].textContent = datosOriginales.horario;
      celdas[7].textContent = datosOriginales.dias;
      celdas[8].textContent = `‚Ç°${parseFloat(datosOriginales.salario).toLocaleString('es-CR', { minimumFractionDigits: 2 })}`;
      celdas[9].textContent = datosOriginales.estado ? "‚úÖ Pagado" : "‚è≥ Pendiente";
      const btnEditar = filaActual.querySelector('.btn-editar');
      const btnGuardar = filaActual.querySelector('.btn-guardar');
      const btnCancelar = filaActual.querySelector('.btn-cancelar');
      btnEditar.style.display = 'inline-block';
      btnGuardar.style.display = 'none';
      btnCancelar.style.display = 'none';
      documentoActual = null;
      filaActual = null;
      datosOriginales = null;
    };

    window.guardarCambios = function(docId, boton) {
      const fila = boton.closest('tr');
      const celdas = fila.querySelectorAll('td');
      const nuevosValores = {};
      for (let i = 0; i <= 9; i++) {
        const celda = celdas[i];
        const inputs = celda.querySelectorAll('.editable');
        if (inputs.length > 0) {
          if (i === 6) {
            nuevosValores.horarioEntrada = inputs[0].value || "N/A";
            nuevosValores.horarioSalida = inputs[1].value || "N/A";
          } else {
            const input = inputs[0];
            let campo;
            switch(i) {
              case 0: campo = 'personaSustituirCedula'; break;
              case 1: campo = 'personaSustituirNombre'; break;
              case 2: campo = 'area'; break;
              case 3: campo = 'codArea'; break;
              case 4: campo = 'inicio'; break;
              case 5: campo = 'final'; break;
              case 7: campo = 'dias'; break;
              case 8: campo = 'salario'; break;
              case 9: campo = 'estado'; break;
            }
            if (campo === 'estado') {
              nuevosValores[campo] = input.value === 'true';
            } else if (campo === 'dias' || campo === 'salario') {
              nuevosValores[campo] = parseFloat(input.value) || 0;
            } else {
              nuevosValores[campo] = input.value || "N/A";
            }
          }
        }
      }

      const modal = document.getElementById('modalConfirmacion');
      const mensajeConfirmacion = document.getElementById('mensajeConfirmacion');
      mensajeConfirmacion.textContent = `¬øGuardar cambios para ${celdas[1].querySelector('.editable')?.value || 'N/A'}?`;
      modal.style.display = 'flex';

      const confirmarGuardado = async () => {
        try {
          const docRef = doc(db, "nombramientos", docId);
          await updateDoc(docRef, nuevosValores);
          celdas[0].textContent = nuevosValores.personaSustituirCedula || "N/A";
          celdas[1].textContent = nuevosValores.personaSustituirNombre || "N/A";
          celdas[2].textContent = nuevosValores.area || "N/A";
          celdas[3].textContent = nuevosValores.codArea || "N/A";
          celdas[4].textContent = nuevosValores.inicio || "N/A";
          celdas[5].textContent = nuevosValores.final || "N/A";
          celdas[6].textContent = `${nuevosValores.horarioEntrada || 'N/A'} - ${nuevosValores.horarioSalida || 'N/A'}`;
          celdas[7].textContent = nuevosValores.dias || 0;
          celdas[8].textContent = `‚Ç°${parseFloat(nuevosValores.salario || 0).toLocaleString('es-CR', { minimumFractionDigits: 2 })}`;
          celdas[9].textContent = nuevosValores.estado ? "‚úÖ Pagado" : "‚è≥ Pendiente";

          const btnEditar = fila.querySelector('.btn-editar');
          const btnGuardar = fila.querySelector('.btn-guardar');
          const btnCancelar = fila.querySelector('.btn-cancelar');
          btnEditar.style.display = 'inline-block';
          btnGuardar.style.display = 'none';
          btnCancelar.style.display = 'none';

          alert("‚úÖ Cambios guardados");
          documentoActual = null;
          filaActual = null;
          datosOriginales = null;
        } catch (error) {
          console.error("Error al guardar:", error);
          alert("‚ùå Error: " + error.message);
        }
        modal.style.display = 'none';
      };

      document.getElementById('btnAceptar').onclick = confirmarGuardado;
      document.getElementById('btnCancelarModal').onclick = () => modal.style.display = 'none';
      window.onclick = (event) => { if (event.target == modal) modal.style.display = 'none'; };
    };

    // üîπ ABRIR MODAL DE DETALLE
    window.abrirDetalle = async function(docId, datos) {
      documentoDetalleActual = docId;
      rangoNombramiento = { inicio: datos.inicio, final: datos.final };

      document.getElementById('detalleFuncionario').textContent = datos.personaSustituirNombre || 'SIN DATOS';
      document.getElementById('detallePeriodo').textContent = `${datos.inicio} - ${datos.final || 'N/A'}`;
      document.getElementById('detalleArea').textContent = datos.area || 'N/A';

      const fechaInicio = new Date(datos.inicio);
      const mes = fechaInicio.getMonth();
      const anio = fechaInicio.getFullYear();
      const nombreMes = fechaInicio.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
      document.getElementById('mesCalendario').textContent = nombreMes;

      generarCalendario(mes, anio, datos.inicio, datos.final);

      // ‚úÖ Cargar desde CALENDAR
      const diasMap = await cargarDiasDesdeCalendar(datos.inicio, datos.final);
      diasSeleccionados.clear();
      document.querySelectorAll('.calendario-dia.dia-seleccionado').forEach(el => el.classList.remove('dia-seleccionado'));

      const mesCal = mes;
      const anioCal = anio;
      diasMap.forEach((registro, fecha) => {
        const fechaObj = new Date(fecha);
        const dia = fechaObj.getDate();
        const elementos = document.querySelectorAll('.calendario-dia:not(.dia-fuera)');
        elementos.forEach(el => {
          if (parseInt(el.textContent) === dia) {
            const fechaEl = new Date(anioCal, mesCal, dia);
            if (fechaEl.toISOString().split('T')[0] === fecha) {
              el.classList.add('dia-seleccionado');
              diasSeleccionados.add(fecha);
            }
          }
        });
      });

      document.getElementById('modalDetalle').style.display = 'flex';
    };

    // üîπ GENERAR CALENDARIO
    function generarCalendario(mes, anio, inicioNombramiento, finalNombramiento) {
      const container = document.getElementById('calendarioContainer');
      container.innerHTML = '';
      const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      diasSemana.forEach(dia => {
        const header = document.createElement('div');
        header.className = 'calendario-header';
        header.textContent = dia;
        container.appendChild(header);
      });

      const primerDia = new Date(anio, mes, 1);
      const ultimoDia = new Date(anio, mes + 1, 0);
      const totalDias = ultimoDia.getDate();
      const diaSemanaInicio = primerDia.getDay();

      for (let i = 0; i < diaSemanaInicio; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendario-dia dia-fuera';
        container.appendChild(empty);
      }

      const fechaInicioNom = new Date(inicioNombramiento);
      const fechaFinalNom = new Date(finalNombramiento);

      for (let dia = 1; dia <= totalDias; dia++) {
        const diaDiv = document.createElement('div');
        diaDiv.className = 'calendario-dia';
        diaDiv.textContent = dia;
        const fechaActual = new Date(anio, mes, dia);
        const dentroRango = fechaActual >= fechaInicioNom && fechaActual <= fechaFinalNom;
        if (dentroRango) {
          diaDiv.classList.add('dia-nombramiento');
        }
        diaDiv.addEventListener('click', () => {
          if (!dentroRango) return;
          diaDiv.classList.toggle('dia-seleccionado');
          const fechaStr = fechaActual.toISOString().split('T')[0];
          if (diaDiv.classList.contains('dia-seleccionado')) {
            diasSeleccionados.add(fechaStr);
          } else {
            diasSeleccionados.delete(fechaStr);
          }
        });
        container.appendChild(diaDiv);
      }
    }

    // üîπ GUARDAR DETALLES EN CALENDAR
    document.getElementById('btnGuardarDetalle').addEventListener('click', async function() {
      if (!documentoDetalleActual) return;
      const tipo = document.getElementById('tipoAusencia').value;
      const comentario = document.getElementById('comentarioAusencia').value;

      if (tipo && diasSeleccionados.size === 0) {
        alert('‚ö†Ô∏è Seleccione al menos un d√≠a.');
        return;
      }

      const resultados = await Promise.all(
        Array.from(diasSeleccionados).map(fecha => guardarDiaEnCalendar(fecha, tipo, comentario))
      );

      if (resultados.every(r => r)) {
        alert('‚úÖ D√≠as actualizados en el calendario personal.');
        document.getElementById('modalDetalle').style.display = 'none';
        actualizarDiasLibresEnFila(documentoDetalleActual, rangoNombramiento.inicio, rangoNombramiento.final);
      } else {
        alert('‚ùå Error al guardar algunos d√≠as.');
      }
    });

    document.getElementById('btnCerrarDetalle').addEventListener('click', () => {
      document.getElementById('modalDetalle').style.display = 'none';
    });

    window.addEventListener('click', (event) => {
      const modal = document.getElementById('modalDetalle');
      if (event.target === modal) modal.style.display = 'none';
    });

    // üîπ FUNCIONES DE EXPORTACI√ìN Y RESUMEN (sin cambios)
    function exportarPDF() {
      const element = document.getElementById('tablaNombramientos');
      const mes = document.getElementById("mes").options[document.getElementById("mes").selectedIndex].text;
      const anio = document.getElementById("anio").value;
      const filas = document.querySelectorAll("#tablaRegistros tr");
      if (filas.length <= 1 || filas[0].querySelector("td")?.textContent?.includes("Cargando") || filas[0].querySelector("td")?.textContent?.includes("No se encontraron")) {
        alert("No hay datos para exportar.");
        return;
      }

      const pdfContainer = document.createElement('div');
      pdfContainer.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          <h2 style="color: #0d47a1;">Reporte de Nombramientos</h2>
          <p>Filtrado por: ${mes} ${anio}</p>
          <p>Generado por: ${usuario.nombre || 'Usuario'}</p>
          <p>Fecha: ${new Date().toLocaleDateString('es-CR')}</p>
        </div>
        ${document.getElementById('usuarioInfo').outerHTML}
      `;
      const tablaClone = element.cloneNode(true);
      tablaClone.querySelectorAll('.acciones').forEach(btn => {
        btn.innerHTML = 'Reporte generado';
        btn.style.cssText = 'background:#e0e0e0;color:#666;padding:5px;border-radius:3px;text-align:center;';
      });
      pdfContainer.appendChild(tablaClone);

      html2pdf().set({
        margin: [15, 10, 15, 10],
        filename: `nombramientos_${mes}_${anio}_${usuario.nombre || 'usuario'}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
      }).from(pdfContainer).save();
    }

    function mostrarResumenDiasLibres() {
      alert("Esta funcionalidad ahora se basa en 'calendar'. ¬øDeseas que la actualice tambi√©n?");
    }

    // üîπ INICIALIZACI√ìN
    document.addEventListener("DOMContentLoaded", () => {
      const hoy = new Date();
      const mesSelect = document.getElementById("mes");
      const anioSelect = document.getElementById("anio");
      if (mesSelect) mesSelect.value = hoy.getMonth() + 1;
      if (anioSelect) {
        anioSelect.innerHTML = "";
        for (let year = 2020; year <= 2026; year++) {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          anioSelect.appendChild(option);
        }
        anioSelect.value = hoy.getFullYear();
      }
      setTimeout(cargarRegistros, 500);
    });

    document.addEventListener("DOMContentLoaded", () => {
      const btnFiltrar = document.getElementById("btnFiltrar");
      const btnExportarPDF = document.getElementById("btnExportarPDF");
      const btnVerDiasLibres = document.getElementById("btnVerDiasLibres");
      if (btnFiltrar) btnFiltrar.addEventListener("click", cargarRegistros);
      if (btnExportarPDF) btnExportarPDF.addEventListener("click", exportarPDF);
      if (btnVerDiasLibres) btnVerDiasLibres.addEventListener("click", mostrarResumenDiasLibres);
      const selectMes = document.getElementById("mes");
      const selectAnio = document.getElementById("anio");
      if (selectMes) selectMes.addEventListener("change", cargarRegistros);
      if (selectAnio) selectAnio.addEventListener("change", cargarRegistros);
    });
  </script>
</body>
</html>