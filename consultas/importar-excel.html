<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Importar Excel/CSV/JSON a Firestore</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      padding: 20px;
      margin: 0;
    }
    h2 {
      text-align: center;
      color: #004080;
      margin-bottom: 30px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .uploader {
      border: 3px dashed #004080;
      padding: 30px;
      text-align: center;
      border-radius: 10px;
      margin-bottom: 30px;
      background: #f0f8ff;
    }
    .uploader:hover {
      background: #e6f2ff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 30px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background: #004080;
      color: white;
    }
    input, select, textarea {
      width: 100%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background: #004080;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0066cc;
    }
    button.guardar {
      background: #28a745;
    }
    button.guardar:hover {
      background: #218838;
    }
    .acciones {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    .estado-pendiente { background: #fff3cd; }
    .estado-pagado { background: #d4edda; }
    #mensaje {
      text-align: center;
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
    }
    .info { background: #d1ecf1; color: #0c5460; }
    .error { background: #f8d7da; color: #721c24; }
    .success { background: #d4edda; color: #155724; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Importar Excel/CSV/JSON a Firestore</h2>

    <div class="uploader" id="dropZone">
      <h3>üìÇ Arrastra aqu√≠ tu archivo o haz clic para seleccionar</h3>
      <p>Formatos soportados: <strong>.xlsx, .xls, .csv, .json</strong></p>
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.json" style="display:none;">
      <button id="btnSelectFile">Seleccionar Archivo</button>
    </div>

    <div id="mensaje"></div>

    <div id="tablaContainer" style="display:none;">
      <table id="tablaNombramientos">
        <thead>
          <tr>
            <th>Inicio</th>
            <th>Final</th>
            <th>D√≠as</th>
            <th>√Årea (C√≥digo)</th>
            <th>√Årea (Nombre)</th>
            <th>Sustituye a</th>
            <th>Salario</th>
            <th>Estado</th>
            <th>Horario Entrada</th>
            <th>Horario Salida</th>
            <th>Usuario C√©dula</th>
            <th>Usuario Nombre</th>
            <th>Comentario</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyRegistros"></tbody>
      </table>
    </div>

    <div id="botonesContainer" style="text-align: center; margin-top: 20px; display: none;">
      <button id="btnGuardarTodos">üíæ Guardar Todos en Firestore</button>
    </div>
  </div>

  <!-- Librer√≠a SheetJS para leer Excel/CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // üîπ Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDigm9JWEqr5h0YV3H6a-H3ub4N__2Y2q4",
      authDomain: "interinos-ccss.firebaseapp.com",
      projectId: "interinos-ccss",
      storageBucket: "interinos-ccss.firebasestorage.app",
      messagingSenderId: "1098694984589",
      appId: "1:1098694984589:web:180af36da33ff6a161b3c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üîπ Variables globales
    let datosOriginales = [];

    // üîπ Reformattear fecha (admite varios formatos)
    function reformatearFecha(fechaStr) {
      if (!fechaStr) return "";
      
      // Si ya est√° en formato YYYY-MM-DD
      if (/^\d{4}-\d{2}-\d{2}$/.test(fechaStr)) {
        return fechaStr;
      }
      
      // Si est√° en formato MM/DD/YYYY o DD/MM/YYYY
      const partes = fechaStr.toString().split(/\D/).filter(p => p);
      if (partes.length >= 3) {
        // Asumimos MM/DD/YYYY (ajusta si es DD/MM/YYYY)
        const mes = partes[0];
        const dia = partes[1];
        const anio = partes[2].length === 2 ? `20${partes[2]}` : partes[2];
        return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
      }
      
      return "";
    }

    // üîπ Renderizar tabla
    function renderizarTabla(datos) {
      const tbody = document.getElementById("tbodyRegistros");
      const tablaContainer = document.getElementById("tablaContainer");
      const botonesContainer = document.getElementById("botonesContainer");
      const mensajeDiv = document.getElementById("mensaje");

      datosOriginales = datos;
      tbody.innerHTML = "";

      if (!Array.isArray(datos) || datos.length === 0) {
        mensajeDiv.innerHTML = '<p class="error">üì≠ No se encontraron registros en el archivo.</p>';
        return;
      }

      mensajeDiv.innerHTML = `<p class="info">‚úÖ Se cargaron ${datos.length} registros. Edita los campos que faltan y guarda en Firestore.</p>`;

      datos.forEach((registro, index) => {
        const fila = document.createElement("tr");
        fila.className = (registro.estado === "PAGADO" || registro.estado === true) ? "estado-pagado" : "estado-pendiente";

        // Formatear fechas
        const inicioFormateado = reformatearFecha(registro.inicio);
        const finalFormateado = reformatearFecha(registro.final);

        // Convertir d√≠as y salario a n√∫mero si son strings
        const dias = typeof registro.dias === 'string' ? parseInt(registro.dias) : registro.dias;
        const salario = typeof registro.salario === 'string' ? parseFloat(registro.salario) : registro.salario;

        fila.innerHTML = `
          <td><input type="date" value="${inicioFormateado}" data-index="${index}" data-campo="inicio"></td>
          <td><input type="date" value="${finalFormateado}" data-index="${index}" data-campo="final"></td>
          <td><input type="number" value="${dias || ''}" data-index="${index}" data-campo="dias"></td>
          <td><input type="text" value="${registro.codArea || ''}" data-index="${index}" data-campo="codArea" readonly></td>
          <td><input type="text" value="${registro.area || ''}" placeholder="Nombre del √°rea" data-index="${index}" data-campo="area"></td>
          <td>${registro.personaSustituirNombre || ''} (${registro.personaSustituirCedula || ''})</td>
          <td><input type="number" value="${salario || ''}" step="0.01" data-index="${index}" data-campo="salario"></td>
          <td>
            <select data-index="${index}" data-campo="estado">
              <option value="false" ${(registro.estado === "PENDIENTE" || registro.estado === false) ? "selected" : ""}>PENDIENTE</option>
              <option value="true" ${(registro.estado === "PAGADO" || registro.estado === true) ? "selected" : ""}>PAGADO</option>
            </select>
          </td>
          <td><input type="time" value="${registro.horarioEntrada || '07:00'}" data-index="${index}" data-campo="horarioEntrada"></td>
          <td><input type="time" value="${registro.horarioSalida || '16:00'}" data-index="${index}" data-campo="horarioSalida"></td>
          <td><input type="text" value="${registro.usuarioCedula || ''}" data-index="${index}" data-campo="usuarioCedula" readonly></td>
          <td><input type="text" value="${registro.usuarioNombre || ''}" placeholder="Nombre del usuario" data-index="${index}" data-campo="usuarioNombre"></td>
          <td><textarea data-index="${index}" data-campo="comentario">${registro.comentario || ''}</textarea></td>
          <td class="acciones">
            <button class="guardar" data-index="${index}">üíæ Guardar</button>
          </td>
        `;
        tbody.appendChild(fila);
      });

      // Mostrar tabla y botones
      tablaContainer.style.display = "block";
      botonesContainer.style.display = "block";

      // Asignar eventos a botones "Guardar"
      document.querySelectorAll(".guardar").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const index = e.target.dataset.index;
          await guardarRegistro(index);
        });
      });
    }

    // üîπ Obtener datos editados de un registro
    function obtenerDatosEditados(index) {
      const campos = ["inicio", "final", "dias", "codArea", "area", "salario", "estado", "horarioEntrada", "horarioSalida", "usuarioCedula", "usuarioNombre", "comentario"];
      const registroEditado = {};

      campos.forEach(campo => {
        const elemento = document.querySelector(`[data-index="${index}"][data-campo="${campo}"]`);
        if (elemento) {
          if (campo === "dias" || campo === "salario") {
            registroEditado[campo] = parseFloat(elemento.value) || 0;
          } else if (campo === "estado") {
            registroEditado[campo] = elemento.value === "true";
          } else {
            registroEditado[campo] = elemento.value;
          }
        }
      });

      // Datos fijos del registro original
      const original = datosOriginales[index];
      registroEditado.personaSustituirCedula = original.personaSustituirCedula || "";
      registroEditado.personaSustituirNombre = original.personaSustituirNombre || "";

      // A√±adir timestamp
      registroEditado.creadoEn = new Date();

      return registroEditado;
    }

    // üîπ Guardar un registro en Firestore
    async function guardarRegistro(index) {
      try {
        const datos = obtenerDatosEditados(index);
        const docRef = await addDoc(collection(db, "nombramientos"), datos);
        
        alert(`‚úÖ Registro guardado con ID: ${docRef.id}`);
        
        // Feedback visual
        const fila = document.querySelector(`[data-index="${index}"]`)?.closest("tr");
        if (fila) {
          fila.style.background = "#d4edda";
          setTimeout(() => {
            fila.style.background = datosOriginales[index].estado === "PAGADO" || datosOriginales[index].estado === true ? "#d4edda" : "#fff3cd";
          }, 2000);
        }
      } catch (error) {
        console.error("Error guardando registro:", error);
        alert("‚ùå Error al guardar: " + error.message);
      }
    }

    // üîπ Guardar todos los registros
    async function guardarTodosRegistros() {
      if (!confirm(`¬øGuardar todos los ${datosOriginales.length} registros en Firestore?`)) return;

      let exitosos = 0;
      let errores = 0;

      for (let i = 0; i < datosOriginales.length; i++) {
        try {
          const datos = obtenerDatosEditados(i);
          await addDoc(collection(db, "nombramientos"), datos);
          exitosos++;

          // Feedback visual
          const fila = document.querySelector(`[data-index="${i}"]`)?.closest("tr");
          if (fila) {
            fila.style.background = "#d4edda";
          }
        } catch (error) {
          console.error(`Error en registro ${i}:`, error);
          errores++;
        }
      }

      alert(`‚úÖ Guardado completado: ${exitosos} exitosos, ${errores} errores.`);
      document.getElementById("mensaje").innerHTML = `<p class="success">‚úÖ Guardado completado: ${exitosos} exitosos, ${errores} errores.</p>`;
    }

    // üîπ Procesar archivo Excel/CSV/JSON
    function procesarArchivo(file) {
      const mensajeDiv = document.getElementById("mensaje");
      mensajeDiv.innerHTML = '<p class="info">‚è≥ Procesando archivo...</p>';

      const reader = new FileReader();

      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          let registros = [];

          if (file.name.endsWith('.json')) {
            // Procesar JSON
            const jsonText = new TextDecoder().decode(data);
            registros = JSON.parse(jsonText);
          } else if (file.name.endsWith('.csv')) {
            // Procesar CSV
            const csvText = new TextDecoder().decode(data);
            registros = parseCSV(csvText);
          } else {
            // Procesar Excel
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            registros = XLSX.utils.sheet_to_json(worksheet);
          }

          renderizarTabla(registros);
        } catch (error) {
          console.error("Error procesando archivo:", error);
          mensajeDiv.innerHTML = `<p class="error">‚ùå Error procesando el archivo: ${error.message}</p>`;
        }
      };

      reader.onerror = function() {
        mensajeDiv.innerHTML = '<p class="error">‚ùå Error leyendo el archivo.</p>';
      };

      reader.readAsArrayBuffer(file);
    }

    // üîπ Parsear CSV manualmente (b√°sico)
    function parseCSV(csvText) {
      const lines = csvText.split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const registros = [];

      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const registro = {};
        headers.forEach((header, index) => {
          registro[header] = values[index] || "";
        });
        registros.push(registro);
      }

      return registros;
    }

    // üîπ Inicializar eventos
    document.addEventListener("DOMContentLoaded", () => {
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const btnSelectFile = document.getElementById("btnSelectFile");
      const btnGuardarTodos = document.getElementById("btnGuardarTodos");

      // Evento para seleccionar archivo
      btnSelectFile.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          procesarArchivo(e.target.files[0]);
        }
      });

      // Evento para arrastrar y soltar
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "#0066cc";
        dropZone.style.backgroundColor = "#e6f2ff";
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.style.borderColor = "#004080";
        dropZone.style.backgroundColor = "#f0f8ff";
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "#004080";
        dropZone.style.backgroundColor = "#f0f8ff";
        
        if (e.dataTransfer.files.length > 0) {
          procesarArchivo(e.dataTransfer.files[0]);
        }
      });

      // Evento para guardar todos
      btnGuardarTodos.addEventListener("click", guardarTodosRegistros);
    });
  </script>
</body>
</html>