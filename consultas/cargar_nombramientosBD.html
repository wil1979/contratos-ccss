<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Importar y Editar Nombramientos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      padding: 20px;
      margin: 0;
    }
    h2 {
      text-align: center;
      color: #004080;
      margin-bottom: 30px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background: #004080;
      color: white;
    }
    input, select, textarea {
      width: 100%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background: #004080;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0066cc;
    }
    button.guardar {
      background: #28a745;
    }
    button.guardar:hover {
      background: #218838;
    }
    .acciones {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    .estado-pendiente { background: #fff3cd; }
    .estado-pagado { background: #d4edda; }
    .cargando {
      text-align: center;
      padding: 40px;
      font-size: 1.2em;
      color: #004080;
    }
    #mensajeCarga {
      text-align: center;
      padding: 20px;
      color: #e74c3c;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Importar, Editar y Guardar Nombramientos en Firestore</h2>

    <div id="mensajeCarga"></div>

    <div id="tablaContainer" style="display:none;">
      <table id="tablaNombramientos">
        <thead>
          <tr>
            <th>Inicio</th>
            <th>Final</th>
            <th>D√≠as</th>
            <th>√Årea (C√≥digo)</th>
            <th>√Årea (Nombre)</th>
            <th>Sustituye a</th>
            <th>Salario</th>
            <th>Estado</th>
            <th>Horario Entrada</th>
            <th>Horario Salida</th>
            <th>Usuario C√©dula</th>
            <th>Usuario Nombre</th>
            <th>Comentario</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyRegistros"></tbody>
      </table>
    </div>

    <div id="botonesContainer" style="text-align: center; margin-top: 20px; display: none;">
      <button id="btnGuardarTodos">üíæ Guardar Todos en Firestore</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // üîπ Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDigm9JWEqr5h0YV3H6a-H3ub4N__2Y2q4",
      authDomain: "interinos-ccss.firebaseapp.com",
      projectId: "interinos-ccss",
      storageBucket: "interinos-ccss.firebasestorage.app",
      messagingSenderId: "1098694984589",
      appId: "1:1098694984589:web:180af36da33ff6a161b3c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üîπ Reformattear fecha de MM/DD/YYYY a YYYY-MM-DD
    function reformatearFecha(fechaStr) {
      if (!fechaStr) return "";
      const partes = fechaStr.split("/");
      if (partes.length !== 3) return "";
      const [mes, dia, anio] = partes;
      return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    }

    // üîπ Renderizar tabla
    function renderizarTabla(datos) {
      const tbody = document.getElementById("tbodyRegistros");
      const tablaContainer = document.getElementById("tablaContainer");
      const botonesContainer = document.getElementById("botonesContainer");
      const mensajeCarga = document.getElementById("mensajeCarga");

      tbody.innerHTML = "";
      mensajeCarga.textContent = "";

      if (!Array.isArray(datos) || datos.length === 0) {
        mensajeCarga.textContent = "üì≠ No se encontraron registros en el archivo JSON.";
        return;
      }

      datos.forEach((registro, index) => {
        const fila = document.createElement("tr");
        fila.className = registro.estado === "PAGADO" ? "estado-pagado" : "estado-pendiente";

        // Formatear fechas
        const inicioFormateado = reformatearFecha(registro.inicio);
        const finalFormateado = reformatearFecha(registro.final);

        fila.innerHTML = `
          <td><input type="date" value="${inicioFormateado}" data-index="${index}" data-campo="inicio"></td>
          <td><input type="date" value="${finalFormateado}" data-index="${index}" data-campo="final"></td>
          <td><input type="number" value="${registro.dias}" data-index="${index}" data-campo="dias"></td>
          <td><input type="text" value="${registro.codArea || ''}" data-index="${index}" data-campo="codArea" readonly></td>
          <td><input type="text" value="" placeholder="Nombre del √°rea" data-index="${index}" data-campo="area"></td>
          <td>${registro.personaSustituirNombre || ''} (${registro.personaSustituirCedula || ''})</td>
          <td><input type="number" value="${registro.salario}" step="0.01" data-index="${index}" data-campo="salario"></td>
          <td>
            <select data-index="${index}" data-campo="estado">
              <option value="false" ${registro.estado === "PENDIENTE" ? "selected" : ""}>PENDIENTE</option>
              <option value="true" ${registro.estado === "PAGADO" ? "selected" : ""}>PAGADO</option>
            </select>
          </td>
          <td><input type="time" value="07:00" data-index="${index}" data-campo="horarioEntrada"></td>
          <td><input type="time" value="16:00" data-index="${index}" data-campo="horarioSalida"></td>
          <td><input type="text" value="${registro.usuarioCedula || ''}" data-index="${index}" data-campo="usuarioCedula" readonly></td>
          <td><input type="text" value="" placeholder="Nombre del usuario" data-index="${index}" data-campo="usuarioNombre"></td>
          <td><textarea data-index="${index}" data-campo="comentario">${registro.comentario || ''}</textarea></td>
          <td class="acciones">
            <button class="guardar" data-index="${index}">üíæ Guardar</button>
          </td>
        `;
        tbody.appendChild(fila);
      });

      // Mostrar tabla y botones
      tablaContainer.style.display = "block";
      botonesContainer.style.display = "block";

      // Asignar eventos a botones "Guardar"
      document.querySelectorAll(".guardar").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const index = e.target.dataset.index;
          await guardarRegistro(index, datos);
        });
      });
    }

    // üîπ Obtener datos editados de un registro
    function obtenerDatosEditados(index, datosOriginales) {
      const campos = ["inicio", "final", "dias", "codArea", "area", "salario", "estado", "horarioEntrada", "horarioSalida", "usuarioCedula", "usuarioNombre", "comentario"];
      const registroEditado = {};

      campos.forEach(campo => {
        const elemento = document.querySelector(`[data-index="${index}"][data-campo="${campo}"]`);
        if (elemento) {
          if (campo === "dias" || campo === "salario") {
            registroEditado[campo] = parseFloat(elemento.value) || 0;
          } else if (campo === "estado") {
            registroEditado[campo] = elemento.value === "true";
          } else {
            registroEditado[campo] = elemento.value;
          }
        }
      });

      // Datos fijos del JSON original
      const original = datosOriginales[index];
      registroEditado.personaSustituirCedula = original.personaSustituirCedula || "";
      registroEditado.personaSustituirNombre = original.personaSustituirNombre || "";

      // A√±adir timestamp
      registroEditado.creadoEn = new Date();

      return registroEditado;
    }

    // üîπ Guardar un registro en Firestore
    async function guardarRegistro(index, datosOriginales) {
      try {
        const datos = obtenerDatosEditados(index, datosOriginales);
        const docRef = await addDoc(collection(db, "nombramientos"), datos);
        
        alert(`‚úÖ Registro guardado con ID: ${docRef.id}`);
        
        // Feedback visual
        const fila = document.querySelector(`[data-index="${index}"]`)?.closest("tr");
        if (fila) {
          fila.style.background = "#d4edda";
          setTimeout(() => {
            fila.style.background = datosOriginales[index].estado === "PAGADO" ? "#d4edda" : "#fff3cd";
          }, 2000);
        }
      } catch (error) {
        console.error("Error guardando registro:", error);
        alert("‚ùå Error al guardar: " + error.message);
      }
    }

    // üîπ Guardar todos los registros
    async function guardarTodosRegistros(datosOriginales) {
      if (!confirm(`¬øGuardar todos los ${datosOriginales.length} registros en Firestore?`)) return;

      let exitosos = 0;
      let errores = 0;

      for (let i = 0; i < datosOriginales.length; i++) {
        try {
          const datos = obtenerDatosEditados(i, datosOriginales);
          await addDoc(collection(db, "nombramientos"), datos);
          exitosos++;

          // Feedback visual
          const fila = document.querySelector(`[data-index="${i}"]`)?.closest("tr");
          if (fila) {
            fila.style.background = "#d4edda";
          }
        } catch (error) {
          console.error(`Error en registro ${i}:`, error);
          errores++;
        }
      }

      alert(`‚úÖ Guardado completado: ${exitosos} exitosos, ${errores} errores.`);
    }

    // üîπ Cargar datos desde registros.json
    async function cargarDatosDesdeJSON() {
      const mensajeCarga = document.getElementById("mensajeCarga");
      mensajeCarga.textContent = "üì• Cargando datos desde registros.json...";

      try {
        const response = await fetch("registros.json");
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const datos = await response.json();
        renderizarTabla(datos);

        // Asignar evento al bot√≥n de guardar todos
        document.getElementById("btnGuardarTodos").addEventListener("click", () => {
          guardarTodosRegistros(datos);
        });

      } catch (error) {
        console.error("Error cargando registros.json:", error);
        mensajeCarga.textContent = `‚ùå Error: No se pudo cargar el archivo 'registros.json'. Verifica que exista y tenga formato JSON v√°lido. (${error.message})`;
      }
    }

    // ‚úÖ Iniciar carga autom√°tica
    document.addEventListener("DOMContentLoaded", cargarDatosDesdeJSON);
  </script>
</body>
</html>