<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Nombramientos</title>
  <link rel="stylesheet" href="styleextra.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <div class="container">
    <h2>Registro de Nombramientos</h2>
    
    <!-- Información del usuario activo -->
    <div class="info-usuario" id="infoUsuario">
      <h3>Usuario Activo: <span id="nombreUsuario">Cargando...</span></h3>
      <p>Rol: <span id="rolUsuario">Usuario</span></p>
    </div>

    <form id="formNombramiento">
      <div class="form-group">
        <label for="inicio">Inicio:</label>
        <input type="date" id="inicio" required>
      </div>

      <div class="form-group">
        <label for="final">Final:</label>
        <input type="date" id="final" required>
      </div>

      <div class="form-group">
        <label for="dias">Días:</label>
        <input type="number" id="dias" readonly>
      </div>

      <div class="form-group">
        <label for="selectAreaSalud">Área de Salud:</label>
        <select id="selectAreaSalud" required>
          <option value="">-- Elegir Área --</option>
        </select>
        <button type="button" id="btnAgregarArea" class="btn-secondary">+ Agregar Área</button>
      </div>

      <div class="form-group">
        <label>Horario:</label>
        <div class="horario-container">
          <input type="time" id="horaEntrada" required>
          <input type="time" id="horaSalida" required>
        </div>
      </div>

      <div class="form-group">
        <label for="salario">Salario:</label>
        <input type="number" id="salario" step="0.01" readonly>
      </div>

      <div class="form-group">
        <label for="comentario">Comentario:</label>
        <textarea id="comentario" rows="3"></textarea>
      </div>

      <!-- Persona a Sustituir -->
      <div class="form-group">
        <label>Persona a Sustituir (Cédula):</label>
        <input type="text" id="cedulaSustituir" placeholder="Ej: 108290753" >
        <button type="button" id="btnBuscarPersonal" class="btn-secondary">🔍 Buscar Personal</button>
      </div>

      <div class="form-group">
        <label>Nombre Persona a Sustituir:</label>
        <input type="text" id="nombreSustituir" >
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="estado"> Pago Validado
        </label>
      </div>

      <div class="btn-container">
        <button type="submit" class="btn-primary">Guardar Nombramiento</button>
        <button type="button" class="btn-secondary" onclick="cerrarSesion()">Cerrar Sesión</button>
      </div>
    </form>
    
    <!-- Reporte de días por área -->
    <div class="reporte-container">
      <div class="reporte-header">
        <h3 class="reporte-titulo">📊 Reporte de Días Laborados por Área</h3>
        <button id="btnActualizarReporte" class="reporte-refresh">🔄 Actualizar</button>
      </div>
      <div id="reporteContenido" class="reporte-grid">
        <p>Cargando reporte...</p>
      </div>
    </div>
  </div>

  <!-- Modal para áreas -->
  <div id="modalArea">
    <div class="modal-content">
      <h3>Nueva Área</h3>
      <div class="form-group">
        <label>Código:</label>
        <input type="text" id="nuevaCodArea">
      </div>
      <div class="form-group">
        <label>Nombre Área:</label>
        <input type="text" id="nuevaNombreArea">
      </div>
      <div class="btn-container">
        <button id="guardarAreaBtn" class="btn-primary">Guardar Área</button>
        <button id="cerrarModalBtn" class="btn-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal Selección de Personal -->
  <div id="modalPersonal" class="modal">
    <div class="modal-content">
      <h3>Seleccionar Personal</h3>

      <!-- Filtros -->
      <div class="form-group">
        <input type="text" id="filtroNombre" placeholder="Buscar por nombre...">
      </div>
      <div class="form-group">
        <input type="text" id="filtroCedula" placeholder="Buscar por cédula...">
      </div>
      <div class="form-group">
        <label for="filtroPuesto">Puesto:</label>
        <select id="filtroPuesto">
          <option value="">Todos</option>
          <option value="TRAB.SERV.GENERALES">TRAB.SERV.GENERALES</option>
          <option value="TEC.SAL.EN FARM. I">TEC.SAL.EN FARM. I</option>
          <!-- Agrega más puestos según tu Personal.json -->
        </select>
      </div>

      <!-- Botones de acción -->
      <div class="btn-container" style="justify-content: center; gap: 10px;">
        <button id="btnBuscarEnModal" class="btn-primary">🔍 Buscar</button>
        <button id="btnLimpiarFiltros" class="btn-secondary">🧹 Limpiar</button>
      </div>

      <!-- Tabla resultados -->
      <table id="tablaPersonal">
        <thead>
          <tr>
            <th>Cédula</th>
            <th>Nombre</th>
            <th>Puesto</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          <!-- Se llena con JS -->
        </tbody>
      </table>

      <div class="btn-container">
        <button id="cerrarPersonalBtn" class="btn-secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- 🎯 Botón flotante "Inicio" -->
  <a href="dashboard.html" class="btn-flotante-inicio" title="Ir al Dashboard">
    🏠 Inicio
  </a>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDigm9JWEqr5h0YV3H6a-H3ub4N__2Y2q4",
      authDomain: "interinos-ccss.firebaseapp.com",
      projectId: "interinos-ccss",
      storageBucket: "interinos-ccss.firebasestorage.app",
      messagingSenderId: "1098694984589",
      appId: "1:1098694984589:web:180af36da33ff6a161b3c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Verificar sesión
    const usuario = JSON.parse(localStorage.getItem("usuarioActivo"));
    if (!usuario) {
      window.location.href = "login.html";
    } else {
      document.getElementById("nombreUsuario").textContent = usuario.nombre || "Usuario no disponible";
      document.getElementById("rolUsuario").textContent = usuario.rol || "Usuario";
    }

    const inicio = document.getElementById("inicio");
    const final = document.getElementById("final");
    const dias = document.getElementById("dias");
    const salarioInput = document.getElementById("salario");

    function calcularSalario() {
      const diasValor = parseFloat(dias.value) || 0;
      const salario = diasValor * 14523;
      salarioInput.value = salario.toFixed(2);
    }

    function calcularDias() {
      if (!inicio.value || !final.value) return;
      const fi = new Date(inicio.value);
      const ff = new Date(final.value);
      const diff = ff - fi;
      const total = Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1;
      dias.value = total >= 0 ? total : 0;
      calcularSalario();
    }

    inicio.addEventListener("change", calcularDias);
    final.addEventListener("change", calcularDias);

    // Áreas de Salud
    const selectArea = document.getElementById("selectAreaSalud");
    const btnAgregarArea = document.getElementById("btnAgregarArea");
    const modalArea = document.getElementById("modalArea");
    const guardarAreaBtn = document.getElementById("guardarAreaBtn");
    const cerrarModalBtn = document.getElementById("cerrarModalBtn");

    async function cargarAreas() {
      selectArea.innerHTML = `<option value="">-- Elegir Área --</option>`;
      const snapshot = await getDocs(collection(db, "areasSalud"));
      snapshot.forEach(doc => {
        const a = doc.data();
        const opt = document.createElement("option");
        opt.value = JSON.stringify({ codArea: a.codArea, nombreArea: a.nombreArea });
        opt.textContent = `${a.codArea} - ${a.nombreArea}`;
        selectArea.appendChild(opt);
      });
    }
    cargarAreas();

    btnAgregarArea.addEventListener("click", () => modalArea.style.display = "flex");
    cerrarModalBtn.addEventListener("click", () => modalArea.style.display = "none");

    guardarAreaBtn.addEventListener("click", async () => {
      const cod = document.getElementById("nuevaCodArea").value.trim();
      const nombre = document.getElementById("nuevaNombreArea").value.trim();
      if (!cod || !nombre) {
        alert("Debe llenar los campos");
        return;
      }
      await addDoc(collection(db, "areasSalud"), { codArea: cod, nombreArea: nombre });
      modalArea.style.display = "none";
      document.getElementById("nuevaCodArea").value = "";
      document.getElementById("nuevaNombreArea").value = "";
      cargarAreas();
    });

    const cedulaSustituir = document.getElementById("cedulaSustituir");
    const nombreSustituir = document.getElementById("nombreSustituir");

    // Guardar nombramiento
    document.getElementById("formNombramiento").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!selectArea.value) {
        alert("Seleccione un área de salud");
        return;
      }
      const area = JSON.parse(selectArea.value);
      const docRef = await addDoc(collection(db, "nombramientos"), {
        inicio: inicio.value,
        final: final.value,
        dias: parseInt(dias.value),
        codArea: area.codArea,
        area: area.nombreArea,
        horarioEntrada: document.getElementById("horaEntrada").value,
        horarioSalida: document.getElementById("horaSalida").value,
        salario: parseFloat(salarioInput.value),
        comentario: document.getElementById("comentario").value,
        estado: document.getElementById("estado").checked,
        personaSustituirCedula: cedulaSustituir.value.trim(),
        personaSustituirNombre: nombreSustituir.value,
        usuarioCedula: usuario.cedula,
        usuarioNombre: usuario.nombre,
        creadoEn: new Date()
      });
      alert("Nombramiento guardado con ID: " + docRef.id);
      e.target.reset();
      generarReporteDiasPorArea();
    });

    function cerrarSesion() {
      localStorage.removeItem("usuarioActivo");
      window.location.href = "login.html";
    }
    window.cerrarSesion = cerrarSesion;
    
    async function generarReporteDiasPorArea() {
      const reporteContenido = document.getElementById("reporteContenido");
      reporteContenido.innerHTML = "<p>Cargando datos...</p>";
      
      try {
        const q = query(collection(db, "nombramientos"), where("usuarioCedula", "==", usuario.cedula));
        const querySnapshot = await getDocs(q);
        
        const areasMap = new Map();
        
        querySnapshot.forEach(doc => {
          const data = doc.data();
          const areaKey = `${data.codArea} - ${data.area}`;
          if (!areasMap.has(areaKey)) {
            areasMap.set(areaKey, { codArea: data.codArea, nombreArea: data.area, totalDias: 0 });
          }
          const areaData = areasMap.get(areaKey);
          areaData.totalDias += data.dias || 0;
        });
        
        const areasOrdenadas = Array.from(areasMap.values()).sort((a, b) => b.totalDias - a.totalDias);
        
        if (areasOrdenadas.length === 0) {
          reporteContenido.innerHTML = "<p>📊 No hay datos de nombramientos para generar el reporte.</p>";
          return;
        }
        
        let htmlReporte = "";
        areasOrdenadas.forEach(area => {
          htmlReporte += `
            <div class="area-card">
              <div class="area-nombre">${area.nombreArea}</div>
              <div class="area-codigo">Código: ${area.codArea}</div>
              <div class="area-dias">${area.totalDias} días</div>
            </div>
          `;
        });
        reporteContenido.innerHTML = htmlReporte;
        
        const totalGeneral = areasOrdenadas.reduce((sum, area) => sum + area.totalDias, 0);
        const totalElement = document.createElement("div");
        totalElement.style.fontWeight = "bold";
        totalElement.style.marginTop = "1rem";
        totalElement.textContent = `TOTAL GENERAL: ${totalGeneral} días laborados`;
        reporteContenido.appendChild(totalElement);
        
      } catch (error) {
        console.error("Error al generar reporte:", error);
        reporteContenido.innerHTML = `<p style="color: red;">❌ Error al cargar el reporte: ${error.message}</p>`;
      }
    }
    
    document.getElementById("btnActualizarReporte").addEventListener("click", function() {
      this.textContent = "Actualizando...";
      this.disabled = true;
      generarReporteDiasPorArea().then(() => {
        this.textContent = "🔄 Actualizar";
        this.disabled = false;
      });
    });
    
    document.addEventListener("DOMContentLoaded", function() {
      setTimeout(() => {
        generarReporteDiasPorArea();
      }, 1000);
    });

        // =============================
    // Modal Selección de Personal (versión segura)
    // =============================
    const modalPersonal = document.getElementById("modalPersonal");
    const btnBuscarPersonal = document.getElementById("btnBuscarPersonal");
    const cerrarPersonalBtn = document.getElementById("cerrarPersonalBtn");
    const tablaPersonal = document.querySelector("#tablaPersonal tbody");
    const filtroNombre = document.getElementById("filtroNombre");
    const filtroCedula = document.getElementById("filtroCedula");
    const filtroPuesto = document.getElementById("filtroPuesto");
    const btnBuscarEnModal = document.getElementById("btnBuscarEnModal");
    const btnLimpiarFiltros = document.getElementById("btnLimpiarFiltros");

    let listaPersonal = [];

    btnBuscarPersonal.addEventListener("click", async () => {
      modalPersonal.style.display = "flex";
      if (listaPersonal.length === 0) {
        await cargarPersonal();
      }
      tablaPersonal.innerHTML = "<tr><td colspan='4'>Ingrese criterios y haga clic en 'Buscar'</td></tr>";
    });

    cerrarPersonalBtn.addEventListener("click", () => {
      modalPersonal.style.display = "none";
    });

    btnLimpiarFiltros.addEventListener("click", () => {
      filtroNombre.value = "";
      filtroCedula.value = "";
      filtroPuesto.value = "";
      tablaPersonal.innerHTML = "<tr><td colspan='4'>Filtros limpiados. Haga clic en 'Buscar'.</td></tr>";
    });

    btnBuscarEnModal.addEventListener("click", mostrarPersonal);

    // Cargar Personal.json con manejo de errores robusto
    async function cargarPersonal() {
      try {
        const resp = await fetch("Personal.json");
        if (!resp.ok) throw new Error("Archivo Personal.json no encontrado");
        
        const datos = await resp.json();
        
        // Validar y limpiar datos
        if (!Array.isArray(datos)) {
          throw new Error("Personal.json debe ser un arreglo");
        }
        
        listaPersonal = datos.filter(p => {
          if (!p || typeof p !== 'object') return false;
          return (p.nombre != null) || (p.cedula != null) || (p.puesto != null);
        });
        
        console.log("✅ Personal cargado:", listaPersonal.length, "registros válidos");
      } catch (error) {
        console.error("❌ Error al cargar Personal.json:", error);
        listaPersonal = [];
        tablaPersonal.innerHTML = `<tr><td colspan='4'>Error: ${error.message}</td></tr>`;
      }
    }

    // Función de búsqueda segura
    function mostrarPersonal() {
      const nombreFiltro = filtroNombre.value.trim().toLowerCase();
      const cedulaFiltro = filtroCedula.value.trim().replace(/\D/g, ''); // Solo dígitos
      const puestoFiltro = filtroPuesto.value;

      tablaPersonal.innerHTML = "<tr><td colspan='4'>Buscando...</td></tr>";

      setTimeout(() => {
        const resultados = listaPersonal.filter(p => {
          // Filtro por puesto
          if (puestoFiltro && p.puesto !== puestoFiltro) return false;

          // Filtro por nombre (seguro contra undefined)
          if (nombreFiltro) {
            const nombreNormalizado = (p.nombre || '').toLowerCase();
            if (!nombreNormalizado.includes(nombreFiltro)) return false;
          }

          // Filtro por cédula (¡protegido contra undefined, null, etc!)
          if (cedulaFiltro) {
            const cedulaStr = (p.cedula != null) ? p.cedula.toString().replace(/\D/g, '') : '';
            if (!cedulaStr.includes(cedulaFiltro)) return false;
          }

          return true;
        });

        if (resultados.length === 0) {
          tablaPersonal.innerHTML = `<tr><td colspan="4">No se encontraron coincidencias</td></tr>`;
        } else {
          // Limitar resultados para mejor rendimiento
          const resultadosAMostrar = resultados.slice(0, 100);
          tablaPersonal.innerHTML = resultadosAMostrar.map(p => `
            <tr>
              <td>${p.cedula != null ? p.cedula : '—'}</td>
              <td>${p.nombre || '—'}</td>
              <td>${p.puesto || '—'}</td>
              <td><button class="btn-primary btnSeleccionar" 
                  data-cedula="${p.cedula != null ? p.cedula : ''}" 
                  data-nombre="${p.nombre || ''}">Seleccionar</button></td>
            </tr>
          `).join('');

          if (resultados.length > 100) {
            const filaAdvertencia = document.createElement("tr");
            filaAdvertencia.innerHTML = `<td colspan="4" style="text-align: center; font-style: italic;">... y ${resultados.length - 100} más (mostrando 100)</td>`;
            tablaPersonal.appendChild(filaAdvertencia);
          }

          // Auto-seleccionar si solo hay un resultado
          if (resultados.length === 1) {
            const unico = resultados[0];
            cedulaSustituir.value = unico.cedula != null ? unico.cedula : '';
            nombreSustituir.value = unico.nombre || '';
            modalPersonal.style.display = "none";
          }

          // Reasignar eventos a botones
          document.querySelectorAll(".btnSeleccionar").forEach(btn => {
            btn.addEventListener("click", () => {
              cedulaSustituir.value = btn.dataset.cedula;
              nombreSustituir.value = btn.dataset.nombre;
              modalPersonal.style.display = "none";
            });
          });
        }
      }, 150);
    }
  </script>
</body>
</html>