<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Nombramientos</title>
  <link rel="stylesheet" href="styleextra.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">

</head>
<body>
  <div class="container">
    <h2>Registro de Nombramientos</h2>
    
    <!-- Informaci√≥n del usuario activo -->
    <div class="info-usuario" id="infoUsuario">
      <h3>Usuario Activo: <span id="nombreUsuario">Cargando...</span></h3>
      <p>Rol: <span id="rolUsuario">Usuario</span></p>
    </div>

    <form id="formNombramiento">
      <div class="form-group">
        <label for="inicio">Inicio:</label>
        <input type="date" id="inicio" required>
      </div>

      <div class="form-group">
        <label for="final">Final:</label>
        <input type="date" id="final" required>
      </div>

      <div class="form-group">
        <label for="dias">D√≠as:</label>
        <input type="number" id="dias" readonly>
      </div>

      <div class="form-group">
        <label for="selectAreaSalud">√Årea de Salud:</label>
        <select id="selectAreaSalud" required>
          <option value="">-- Elegir √Årea --</option>
        </select>
        <button type="button" id="btnAgregarArea" class="btn-secondary">+ Agregar √Årea</button>
      </div>

      <div class="form-group">
        <label>Horario:</label>
        <div class="horario-container">
          <input type="time" id="horaEntrada" required>
          <input type="time" id="horaSalida" required>
        </div>
      </div>

      <div class="form-group">
        <label for="salario">Salario:</label>
        <input type="number" id="salario" step="0.01" readonly>
      </div>

      <div class="form-group">
        <label for="comentario">Comentario:</label>
        <textarea id="comentario" rows="3"></textarea>
      </div>

      <div class="form-group">
        <label>Persona a Sustituir (C√©dula):</label>
        <input type="text" id="cedulaSustituir" placeholder="Ej: 108290753">
      </div>

      <div class="form-group">
        <label>Nombre Persona a Sustituir:</label>
        <input type="text" id="nombreSustituir" readonly>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="estado"> Pago Validado
        </label>
      </div>

      <div class="btn-container">
        <button type="submit" class="btn-primary">Guardar Nombramiento</button>
        <button type="button" class="btn-secondary" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
      </div>
    </form>
    
    <!-- Reporte de d√≠as por √°rea -->
    <div class="reporte-container">
      <div class="reporte-header">
        <h3 class="reporte-titulo">üìä Reporte de D√≠as Laborados por √Årea</h3>
        <button id="btnActualizarReporte" class="reporte-refresh">üîÑ Actualizar</button>
      </div>
      <div id="reporteContenido" class="reporte-grid">
        <p>Cargando reporte...</p>
      </div>
    </div>
  </div>

  <!-- Modal para √°reas -->
  <div id="modalArea">
    <div class="modal-content">
      <h3>Nueva √Årea</h3>
      <div class="form-group">
        <label>C√≥digo:</label>
        <input type="text" id="nuevaCodArea">
      </div>
      <div class="form-group">
        <label>Nombre √Årea:</label>
        <input type="text" id="nuevaNombreArea">
      </div>
      <div class="btn-container">
        <button id="guardarAreaBtn" class="btn-primary">Guardar √Årea</button>
        <button id="cerrarModalBtn" class="btn-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- üéØ Bot√≥n flotante "Inicio" -->
  <a href="dashboard.html" class="btn-flotante-inicio" title="Ir al Dashboard">
    üè† Inicio
  </a>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDigm9JWEqr5h0YV3H6a-H3ub4N__2Y2q4",
      authDomain: "interinos-ccss.firebaseapp.com",
      projectId: "interinos-ccss",
      storageBucket: "interinos-ccss.firebasestorage.app",
      messagingSenderId: "1098694984589",
      appId: "1:1098694984589:web:180af36da33ff6a161b3c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Verificar sesi√≥n
    const usuario = JSON.parse(localStorage.getItem("usuarioActivo"));
    if (!usuario) {
      window.location.href = "login.html";
    } else {
      // Mostrar informaci√≥n del usuario activo
      document.getElementById("nombreUsuario").textContent = usuario.nombre || "Usuario no disponible";
      document.getElementById("rolUsuario").textContent = usuario.rol || "Usuario";
    }

    const inicio = document.getElementById("inicio");
    const final = document.getElementById("final");
    const dias = document.getElementById("dias");
    const salarioInput = document.getElementById("salario");

    function calcularSalario() {
      const diasValor = parseFloat(dias.value) || 0;
      const salario = diasValor * 14523;
      salarioInput.value = salario.toFixed(2); // 2 decimales
    }

    function calcularDias() {
      if (!inicio.value || !final.value) return;
      const fi = new Date(inicio.value);
      const ff = new Date(final.value);
      const diff = ff - fi;
      const total = Math.ceil(diff / (1000*60*60*24)) + 1;
      dias.value = total >= 0 ? total : 0;

      // ‚úÖ Actualizar salario autom√°ticamente
      calcularSalario();
    }

    inicio.addEventListener("change", calcularDias);
    final.addEventListener("change", calcularDias);

    // √Åreas de Salud
    const selectArea = document.getElementById("selectAreaSalud");
    const btnAgregarArea = document.getElementById("btnAgregarArea");
    const modalArea = document.getElementById("modalArea");
    const guardarAreaBtn = document.getElementById("guardarAreaBtn");
    const cerrarModalBtn = document.getElementById("cerrarModalBtn");

    async function cargarAreas() {
      selectArea.innerHTML = `<option value="">-- Elegir √Årea --</option>`;
      const snapshot = await getDocs(collection(db, "areasSalud"));
      snapshot.forEach(doc => {
        const a = doc.data();
        const opt = document.createElement("option");
        opt.value = JSON.stringify({ codArea: a.codArea, nombreArea: a.nombreArea });
        opt.textContent = `${a.codArea} - ${a.nombreArea}`;
        selectArea.appendChild(opt);
      });
    }
    cargarAreas();

    btnAgregarArea.addEventListener("click", () => modalArea.style.display = "flex");
    cerrarModalBtn.addEventListener("click", () => modalArea.style.display = "none");

    guardarAreaBtn.addEventListener("click", async () => {
      const cod = document.getElementById("nuevaCodArea").value.trim();
      const nombre = document.getElementById("nuevaNombreArea").value.trim();
      if (!cod || !nombre) {
        alert("Debe llenar los campos");
        return;
      }
      await addDoc(collection(db, "areasSalud"), { codArea: cod, nombreArea: nombre });
      modalArea.style.display = "none";
      document.getElementById("nuevaCodArea").value = "";
      document.getElementById("nuevaNombreArea").value = "";
      cargarAreas();
    });

    // Buscar nombre por c√©dula (API externa simulada + Firestore tabla personal)
    async function buscarPersonaPorCedula(cedula) {
      try {
        // 1. Intentar en API externa (ejemplo ficticio)
        const resp = await fetch(`https://api.hacienda.go.cr/fe/ae?identificacion=${cedula}`);
        if (resp.ok) {
          const data = await resp.json();
          return data.nombre;
        }
      } catch (e) {
        console.log("API no disponible, usando Firestore");
      }

      // 2. Intentar en Firestore tabla personal
      const q = query(collection(db, "personal"), where("id", "==", cedula));
      const snap = await getDocs(q);
      if (!snap.empty) {
        return snap.docs[0].data().nombre;
      }
      return "";
    }

    const cedulaSustituir = document.getElementById("cedulaSustituir");
    const nombreSustituir = document.getElementById("nombreSustituir");

    cedulaSustituir.addEventListener("blur", async () => {
      if (!cedulaSustituir.value) return;
      const nombre = await buscarPersonaPorCedula(cedulaSustituir.value.trim());
      nombreSustituir.value = nombre || "No encontrado";
    });

    // Guardar nombramiento
    document.getElementById("formNombramiento").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!selectArea.value) {
        alert("Seleccione un √°rea de salud");
        return;
      }
      const area = JSON.parse(selectArea.value);
      const docRef = await addDoc(collection(db, "nombramientos"), {
        inicio: inicio.value,
        final: final.value,
        dias: parseInt(dias.value),
        codArea: area.codArea,
        area: area.nombreArea,
        horarioEntrada: document.getElementById("horaEntrada").value,
        horarioSalida: document.getElementById("horaSalida").value,
        salario: parseFloat(salarioInput.value),
        comentario: document.getElementById("comentario").value,
        estado: document.getElementById("estado").checked,
        personaSustituirCedula: cedulaSustituir.value.trim(),
        personaSustituirNombre: nombreSustituir.value,
        usuarioCedula: usuario.cedula,
        usuarioNombre: usuario.nombre,
        creadoEn: new Date()
      });
      alert("Nombramiento guardado con ID: " + docRef.id);
      e.target.reset();
      // Actualizar reporte despu√©s de guardar
      generarReporteDiasPorArea();
    });

    function cerrarSesion() {
      localStorage.removeItem("usuarioActivo");
      window.location.href = "login.html";
    }
    window.cerrarSesion = cerrarSesion;
    
    // üîπ Generar reporte de d√≠as por √°rea
    async function generarReporteDiasPorArea() {
      const reporteContenido = document.getElementById("reporteContenido");
      reporteContenido.innerHTML = "<p>Cargando datos...</p>";
      
      try {
        // Obtener todos los nombramientos del usuario actual
        const q = query(
          collection(db, "nombramientos"),
          where("usuarioCedula", "==", usuario.cedula)
        );
        
        const querySnapshot = await getDocs(q);
        
        // Agrupar d√≠as por √°rea
        const areasMap = new Map();
        
        querySnapshot.forEach(doc => {
          const data = doc.data();
          const areaKey = `${data.codArea} - ${data.area}`;
          
          if (!areasMap.has(areaKey)) {
            areasMap.set(areaKey, {
              codArea: data.codArea,
              nombreArea: data.area,
              totalDias: 0,
              registros: []
            });
          }
          
          const areaData = areasMap.get(areaKey);
          areaData.totalDias += data.dias || 0;
          areaData.registros.push({
            id: doc.id,
            inicio: data.inicio,
            final: data.final,
            dias: data.dias
          });
        });
        
        // Ordenar √°reas por total de d√≠as (descendente)
        const areasOrdenadas = Array.from(areasMap.values())
          .sort((a, b) => b.totalDias - a.totalDias);
        
        // Generar HTML para el reporte
        if (areasOrdenadas.length === 0) {
          reporteContenido.innerHTML = "<p>üìä No hay datos de nombramientos para generar el reporte.</p>";
          return;
        }
        
        let htmlReporte = "";
        
        areasOrdenadas.forEach(area => {
          htmlReporte += `
            <div class="area-card">
              <div class="area-nombre">${area.nombreArea}</div>
              <div class="area-codigo">C√≥digo: ${area.codArea}</div>
              <div class="area-dias">${area.totalDias} d√≠as</div>
            </div>
          `;
        });
        
        reporteContenido.innerHTML = htmlReporte;
        
        // Mostrar total general
        const totalGeneral = areasOrdenadas.reduce((sum, area) => sum + area.totalDias, 0);
        const totalElement = document.createElement("div");
        totalElement.style.marginTop = "20px";
        totalElement.style.padding = "15px";
        totalElement.style.backgroundColor = "#e3f2fd";
        totalElement.style.borderRadius = "8px";
        totalElement.style.textAlign = "center";
        totalElement.style.fontWeight = "bold";
        totalElement.style.fontSize = "18px";
        totalElement.innerHTML = `TOTAL GENERAL: ${totalGeneral} d√≠as laborados`;
        reporteContenido.appendChild(totalElement);
        
      } catch (error) {
        console.error("Error al generar reporte:", error);
        reporteContenido.innerHTML = `<p style="color: red;">‚ùå Error al cargar el reporte: ${error.message}</p>`;
      }
    }
    
    // Evento para actualizar reporte manualmente
    document.getElementById("btnActualizarReporte").addEventListener("click", function() {
      this.textContent = "Actualizando...";
      this.disabled = true;
      
      generarReporteDiasPorArea().then(() => {
        this.textContent = "üîÑ Actualizar";
        this.disabled = false;
      }).catch(() => {
        this.textContent = "üîÑ Actualizar";
        this.disabled = false;
      });
    });
    
    // Cargar reporte al iniciar
    document.addEventListener("DOMContentLoaded", function() {
      setTimeout(() => {
        generarReporteDiasPorArea();
      }, 1000);
    });
  </script>
</body>
</html>