<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B√∫squeda Segura de Personal</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #f8f9fa;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #2c3e50;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #34495e;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
    }
    .btn-container {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 10px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
    }
    .btn-primary {
      background-color: #3498db;
      color: white;
    }
    .btn-primary:hover {
      background-color: #2980b9;
    }
    .btn-secondary {
      background-color: #95a5a6;
      color: white;
    }
    .btn-secondary:hover {
      background-color: #7f8c8d;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #f8f9fa;
      color: #2c3e50;
    }
    tr:hover {
      background-color: #f8f9fa;
    }
    .message {
      text-align: center;
      padding: 20px;
      font-style: italic;
    }
    .loading {
      color: #3498db;
    }
    .error {
      color: #e74c3c;
    }
    .success {
      color: #27ae60;
    }

    /* üéØ Bot√≥n flotante de Inicio */
    .btn-flotante-inicio {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #004080;
      color: white;
      padding: 12px 16px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      transition: background 0.3s, transform 0.2s;
    }

    .btn-flotante-inicio:hover {
      background: #0059b3;
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üîç B√∫squeda Segura de Personal</h2>

    <!-- Filtros -->
    <div class="form-group">
      <label for="filtroNombre">Nombre:</label>
      <input type="text" id="filtroNombre" placeholder="Ej: Jorge, Mar√≠a...">
    </div>
    <div class="form-group">
      <label for="filtroCedula">C√©dula:</label>
      <input type="text" id="filtroCedula" placeholder="Ej: 206830189 o 830...">
    </div>
    <div class="form-group">
      <label for="filtroPuesto">Puesto:</label>
      <select id="filtroPuesto">
        <option value="">Todos los puestos</option>
        <!-- Se llenar√° din√°micamente -->
      </select>
    </div>

    <!-- Botones -->
    <div class="btn-container">
      <button id="btnBuscar" class="btn-primary">üîç Buscar</button>
      <button id="btnLimpiar" class="btn-secondary">üßπ Limpiar</button>
    </div>

    <!-- üéØ Bot√≥n flotante "Inicio" -->
  <a href="dashboard.html" class="btn-flotante-inicio" title="Ir al Dashboard">
    üè† Inicio
  </a>

    <!-- Resultados -->
    <div id="resultados">
      <table id="tablaPersonal">
        <thead>
          <tr>
            <th>C√©dula</th>
            <th>Nombre</th>
            <th>Puesto</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tablaCuerpo">
          <tr>
            <td colspan="4" class="message loading">Cargando lista de personal...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Datos globales
    let listaPersonal = [];
    const puestosUnicos = new Set();

    // Elementos del DOM
    const filtroNombre = document.getElementById("filtroNombre");
    const filtroCedula = document.getElementById("filtroCedula");
    const filtroPuesto = document.getElementById("filtroPuesto");
    const btnBuscar = document.getElementById("btnBuscar");
    const btnLimpiar = document.getElementById("btnLimpiar");
    const tablaCuerpo = document.getElementById("tablaCuerpo");

    // Cargar Personal.json con validaci√≥n robusta
    async function cargarPersonal() {
      try {
        const respuesta = await fetch("personal.json");
        if (!respuesta.ok) {
          throw new Error(`Archivo no encontrado. C√≥digo: ${respuesta.status}`);
        }

        const datos = await respuesta.json();

        // Validar que sea un arreglo
        if (!Array.isArray(datos)) {
          throw new Error("personal.json debe ser un arreglo de objetos");
        }

        // Filtrar registros v√°lidos y extraer puestos
        listaPersonal = datos.filter(p => {
          if (!p || typeof p !== 'object') return false;
          // Asegurar que tenga al menos un campo √∫til
          return (p.nombre != null) || (p.cedula != null) || (p.puesto != null);
        });

        // Extraer puestos √∫nicos (solo valores v√°lidos)
        listaPersonal.forEach(p => {
          if (p.puesto && typeof p.puesto === 'string') {
            puestosUnicos.add(p.puesto);
          }
        });

        // Llenar el select de puestos
        const opcionesPuesto = Array.from(puestosUnicos).sort();
        filtroPuesto.innerHTML = '<option value="">Todos los puestos</option>';
        opcionesPuesto.forEach(puesto => {
          const option = document.createElement("option");
          option.value = puesto;
          option.textContent = puesto;
          filtroPuesto.appendChild(option);
        });

        console.log(`‚úÖ Cargados ${listaPersonal.length} registros v√°lidos`);
        tablaCuerpo.innerHTML = '<tr><td colspan="4" class="message">Ingrese criterios y haga clic en "Buscar"</td></tr>';
      } catch (error) {
        console.error("‚ùå Error al cargar personal.json:", error);
        tablaCuerpo.innerHTML = `<tr><td colspan="4" class="message error">
          ‚ùå Error: ${error.message}<br>
          Verifique que el archivo "personal.json" exista y sea un JSON v√°lido.
        </td></tr>`;
      }
    }

    // Funci√≥n de b√∫squeda segura
    function buscarPersonal() {
      const nombreFiltro = filtroNombre.value.trim().toLowerCase();
      const cedulaFiltro = filtroCedula.value.trim().replace(/\D/g, ''); // Solo d√≠gitos
      const puestoFiltro = filtroPuesto.value;

      tablaCuerpo.innerHTML = '<tr><td colspan="4" class="message loading">Buscando...</td></tr>';

      setTimeout(() => {
        const resultados = listaPersonal.filter(p => {
          // Filtro por puesto
          if (puestoFiltro && p.puesto !== puestoFiltro) return false;

          // Filtro por nombre (seguro contra undefined)
          if (nombreFiltro) {
            const nombreNormalizado = (p.nombre || '').toLowerCase();
            if (!nombreNormalizado.includes(nombreFiltro)) return false;
          }

          // Filtro por c√©dula (¬°protegido contra undefined, null, etc!)
          if (cedulaFiltro) {
            const cedulaStr = (p.cedula != null) ? p.cedula.toString() : '';
            if (!cedulaStr.includes(cedulaFiltro)) return false;
          }

          return true;
        });

        if (resultados.length === 0) {
          tablaCuerpo.innerHTML = '<tr><td colspan="4" class="message error">‚ùå No se encontraron coincidencias</td></tr>';
        } else {
          // Limitar a 100 resultados para no congelar el navegador
          const resultadosAMostrar = resultados.slice(0, 100);
          tablaCuerpo.innerHTML = resultadosAMostrar.map(p => `
            <tr>
              <td>${p.cedula != null ? p.cedula : '‚Äî'}</td>
              <td>${p.nombre || '‚Äî'}</td>
              <td>${p.puesto || '‚Äî'}</td>
              <td><button class="btn-primary" onclick="alert('Seleccionado:\\nNombre: ${p.nombre || '‚Äî'}\\nC√©dula: ${p.cedula != null ? p.cedula : '‚Äî'}')">Seleccionar</button></td>
            </tr>
          `).join('');

          if (resultados.length > 100) {
            const filaAdvertencia = document.createElement("tr");
            filaAdvertencia.innerHTML = `<td colspan="4" class="message">... y ${resultados.length - 100} m√°s (mostrando solo 100)</td>`;
            tablaCuerpo.appendChild(filaAdvertencia);
          }
        }
      }, 150);
    }

    // Limpiar filtros
    function limpiarFiltros() {
      filtroNombre.value = "";
      filtroCedula.value = "";
      filtroPuesto.value = "";
      tablaCuerpo.innerHTML = '<tr><td colspan="4" class="message">Ingrese criterios y haga clic en "Buscar"</td></tr>';
    }

    // Eventos
    btnBuscar.addEventListener("click", buscarPersonal);
    btnLimpiar.addEventListener("click", limpiarFiltros);

    // Permitir b√∫squeda con Enter
    document.addEventListener("keypress", (e) => {
      if (e.key === "Enter") buscarPersonal();
    });

    // Iniciar carga
    cargarPersonal();
  </script>
</body>

</html>


